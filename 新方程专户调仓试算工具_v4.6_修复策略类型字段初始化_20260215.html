<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°æ–¹ç¨‹ä¸“æˆ·è°ƒä»“è¯•ç®—å·¥å…· v4.6</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', 'Helvetica Neue', Arial, sans-serif;
            background: #f8fafc;
            padding: 12px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.12), 0 0 0 1px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        #productSelectorPanel::-webkit-scrollbar,
        #buyProduct-options-panel::-webkit-scrollbar,
        #product-options-panel::-webkit-scrollbar {
            width: 6px;
        }

        #productSelectorPanel::-webkit-scrollbar-track,
        #buyProduct-options-panel::-webkit-scrollbar-track,
        #product-options-panel::-webkit-scrollbar-track {
            background: #F1F1F1;
            border-radius: 3px;
        }

        #productSelectorPanel::-webkit-scrollbar-thumb,
        #buyProduct-options-panel::-webkit-scrollbar-thumb,
        #product-options-panel::-webkit-scrollbar-thumb {
            background: #C1C1C1;
            border-radius: 3px;
            transition: background 0.2s;
        }

        #productSelectorPanel::-webkit-scrollbar-thumb:hover,
        #buyProduct-options-panel::-webkit-scrollbar-thumb:hover,
        #product-options-panel::-webkit-scrollbar-thumb:hover {
            background: #A0A0A0;
        }

        /* éšè—åŸæœ‰çš„ä¹°å…¥å’Œå–å‡ºtab */
        #buy, #sell {
            display: none !important;
        }

.header {
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            color: white;
            padding: 16px 24px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 20px;
            margin-bottom: 4px;
            font-weight: 600;
            letter-spacing: 0.5px;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 12px;
            opacity: 0.95;
            position: relative;
            z-index: 1;
        }

        .header .version {
            position: absolute;
            top: 14px;
            right: 14px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 10px;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.3);
            z-index: 1;
        }

        .header .help-btn {
            position: absolute;
            top: 14px;
            right: 90px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 1;
        }

        .header .help-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .tabs {
            display: flex;
            background: white;
            border-bottom: 2px solid #e2e8f0;
            padding: 0 8px;
        }

        .tab {
            padding: 10px 14px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: #64748b;
            transition: all 0.2s;
            border: none;
            background: none;
            border-bottom: 3px solid transparent;
            position: relative;
        }

        .tab:hover {
            background: #f1f5f9;
            color: #1e40af;
        }

        .tab.active {
            color: #1e40af;
            border-bottom-color: #1e40af;
            background: white;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: #1e40af;
            border-radius: 2px 2px 0 0;
        }

        .tab-content {
            padding: 16px;
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .tab-content.active {
            display: block;
        }

        .section-title {
            font-size: 15px;
            color: #1a1a1a;
            margin-bottom: 12px;
            padding-bottom: 6px;
            border-bottom: 2px solid #e2e8f0;
            position: relative;
            font-weight: 600;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 60px;
            height: 2px;
            background: #1e40af;
            border-radius: 2px;
        }

        .form-group {
            margin-bottom: 10px;
        }

        .form-group label {
            display: block;
            margin-bottom: 3px;
            font-weight: 600;
            color: #334155;
            font-size: 13px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 13px;
            transition: all 0.2s;
            background: #f7fafc;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #1e40af;
            background: #ffffff;
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }

        .form-group input::placeholder {
            color: #94a3b8;
        }

        /* ä¼˜åŒ–selectä¸‹æ‹‰æ¡†æ ·å¼ */
        .form-group select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%231e40af' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
            cursor: pointer;
            color: #1a1a1a;
            font-weight: 500;
        }

        .form-group select:hover {
            border-color: #cbd5e0;
            background: #ffffff;
        }

        .form-group select option {
            padding: 8px 12px;
            background: #ffffff;
            color: #1a1a1a;
            font-weight: 500;
        }

        .form-group select option:hover {
            background: #f0f4ff;
        }

        .form-group select option:checked {
            background: #1e40af;
            color: #ffffff;
            font-weight: 600;
        }

        .form-group select option:disabled {
            color: #94a3b8;
            font-style: italic;
        }

        .btn {
            padding: 6px 14px;
            border: none;
            border-radius: 5px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 6px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .btn-primary {
            background: #1e40af;
            color: white;
            box-shadow: 0 2px 4px rgba(30, 64, 175, 0.2);
        }

        .btn-primary:hover {
            background: #1e3a8a;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(30, 64, 175, 0.3);
        }

        .btn-success {
            background: #059669;
            color: white;
            box-shadow: 0 2px 4px rgba(5, 150, 105, 0.2);
        }

        .btn-success:hover {
            background: #047857;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(5, 150, 105, 0.3);
        }

        .btn-danger {
            background: #dc2626;
            color: white;
            box-shadow: 0 2px 4px rgba(220, 38, 38, 0.2);
        }

        .btn-danger:hover {
            background: #b91c1c;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(220, 38, 38, 0.3);
        }

        .btn-info {
            background: #2563eb;
            color: white;
            box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
        }

        .btn-info:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3);
        }

        /* è¡¨æ ¼ä¼˜åŒ– */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background: white;
            border-radius: 6px;
            overflow-x: auto;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            font-size: 12px;
            table-layout: fixed;
            max-width: 100%;
        }

        thead {
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        th, td {
            padding: 4px 6px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            font-size: 12px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.4;
        }

        th {
            font-weight: 600;
            font-size: 11px;
            white-space: nowrap;
            text-align: center;
            padding: 6px 6px;
            line-height: 1.3;
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }

        th:first-child {
            border-top-left-radius: 6px;
        }

        th:last-child {
            border-top-right-radius: 6px;
        }

        /* è¡¨æ ¼æŒ‰é’®ç»„é—´è· */
        .btn-group {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .btn-group .btn-xs {
            margin: 0;
        }

        tbody tr {
            transition: all 0.15s ease;
        }

        tbody tr:hover {
            background: #f8fafc;
        }

        /* æŒä»“è¡¨æ ¼hoveræ•ˆæœ */
        .holding-table tbody tr:hover {
            background: #E6F0FA;
        }

        /* è¡¨æ ¼å•å…ƒæ ¼ä¼˜åŒ– */
        tbody tr:nth-child(even) {
            background: #fafbfc;
        }

        tbody tr:nth-child(even):hover {
            background: #f8fafc;
        }

        /* äº§å“åç§°å•å…ƒæ ¼ç‰¹æ®Šæ ·å¼ */
        td[colspan] {
            background: #f7fafc;
            font-weight: 500;
            color: #475569;
        }

        /* æ“ä½œåˆ—ä¼˜åŒ– */
        td:last-child {
            text-align: center;
            white-space: nowrap;
        }

        /* æ•°å€¼å•å…ƒæ ¼å¯¹é½ */
        td.text-right,
        td.currency-cell,
        td.percentage-cell,
        td.number-cell {
            text-align: right;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            font-size: 11px;
        }

        /* è¡¨æ ¼è¾¹æ¡†ä¼˜åŒ– */
        tbody tr:last-child td {
            border-bottom: none;
        }

        /* è¡¨æ ¼æ»šåŠ¨ä¼˜åŒ– */
        .table-responsive {
            overflow-x: auto;
            border-radius: 6px;
        }

        /* æ–‡æœ¬æº¢å‡ºå¤„ç† */
        .text-ellipsis {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* äº§å“åç§°å•å…ƒæ ¼ä¼˜åŒ– */
        .product-name-cell {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .product-name-cell:hover {
            overflow: visible;
            white-space: normal;
            word-wrap: break-word;
            background: #f8fafc;
            position: relative;
            z-index: 10;
        }

        /* çŠ¶æ€æ ‡ç­¾æ ·å¼ */
        .status-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 500;
        }

        .status-badge.success {
            background: #dcfce7;
            color: #166534;
        }

        .status-badge.warning {
            background: #fef9c3;
            color: #854d0e;
        }

        .status-badge.error {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-badge.info {
            background: #dbeafe;
            color: #1e40af;
        }

        /* è¡¨æ ¼åˆ†éš”çº¿ä¼˜åŒ– */
        thead th {
            border-bottom: 2px solid #1e3a8a;
        }

        tbody td {
            border-bottom: 1px solid #f1f5f9;
        }

        /* å¤é€‰æ¡†æ ·å¼ä¼˜åŒ– */
        input[type="checkbox"] {
            width: 14px;
            height: 14px;
            cursor: pointer;
            accent-color: #1e40af;
        }

        /* æ•°å€¼åˆ—å³å¯¹é½ */
        td.input-number,
        .number-cell {
            text-align: right;
        }

        /* ç™¾åˆ†æ¯”åˆ— */
        .percentage-cell {
            text-align: right;
        }

        /* è´§å¸åˆ— */
        .currency-cell {
            text-align: right;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        .summary-card {
            background: white;
            color: #1a1a1a;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }

        .summary-card h3 {
            margin-bottom: 10px;
            font-size: 14px;
            font-weight: 600;
            color: #1e40af;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid #e2e8f0;
            transition: all 0.2s;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-item:hover {
            padding-left: 6px;
            background: #f8fafc;
            margin: 0 -6px;
            padding-right: 6px;
        }

        .summary-item span:first-child {
            color: #64748b;
            font-weight: 500;
            font-size: 12px;
        }

        .summary-item span:last-child {
            font-weight: 600;
            font-size: 14px;
            color: #1a1a1a;
        }

        .alert {
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 12px;
            display: none;
            font-weight: 500;
            font-size: 12px;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .alert-success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .alert.show {
            display: block;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            animation: fadeIn 0.2s ease-out forwards;
        }

        .modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 1200px;
            min-width: 1000px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease-out;
            position: relative;
        }

        /* å½“å³ä¾§é¢æ¿æ‰“å¼€æ—¶ï¼Œç¦æ­¢bodyæ»šåŠ¨ */
        body.modal-open {
            overflow: hidden;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 12px;
        }

        .modal-header h2 {
            font-size: 16px;
            color: #2d3748;
            font-weight: 700;
        }

        .close-btn {
            background: linear-gradient(135deg, #fc8181 0%, #f56565 100%);
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .close-btn:hover {
            transform: rotate(90deg);
            box-shadow: 0 5px 20px rgba(245, 101, 101, 0.4);
        }

        .help-section {
            margin-bottom: 20px;
        }

        .help-section h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 18px;
            font-weight: 700;
        }

        .help-section ul {
            margin-left: 25px;
            color: #4a5568;
            line-height: 2;
        }

        .help-section li {
            margin-bottom: 10px;
        }

        .pool-categories {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .pool-category-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 30px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pool-category-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .pool-category-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.2);
        }

        .category-header td {
            background: #f8fafc;
            font-weight: 600;
            color: #1e40af;
            padding: 10px 8px;
            border-left: 4px solid #1e40af;
            font-size: 12px;
        }

        .allocation-bar {
            height: 28px;
            background: #e2e8f0;
            border-radius: 14px;
            overflow: hidden;
            margin-top: 10px;
        }

        .allocation-segment {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 11px;
            font-weight: 600;
            transition: filter 0.2s;
        }

        .allocation-segment:hover {
            filter: brightness(1.1);
        }

        .row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .col {
            flex: 1;
        }

.card {
            background: white;
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 12px;
            border: 1px solid #e2e8f0;
            transition: box-shadow 0.2s;
        }

        .card:hover {
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }

        .card h3 {
            color: #1a1a1a;
            margin-bottom: 10px;
            font-size: 14px;
            font-weight: 600;
            padding-bottom: 6px;
            border-bottom: 2px solid #e2e8f0;
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 500;
        }

        .badge-success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
        }

        .badge-warning {
            background: #fef9c3;
            color: #854d0e;
            border: 1px solid #fde047;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .badge-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .empty-state {
            text-align: center;
            padding: 30px;
            color: #a0aec0;
        }

        .empty-state i {
            font-size: 40px;
            margin-bottom: 10px;
            display: block;
            opacity: 0.7;
        }

        .actions {
            margin-top: 12px;
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .data-management-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .data-management-buttons .btn {
            width: 100%;
            justify-content: center;
            padding: 10px 16px;
            font-size: 13px;
        }

        .input-number {
            text-align: right;
        }

        /* å¸¦æœç´¢åŠŸèƒ½çš„ä¸‹æ‹‰ç»„ä»¶æ ·å¼ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 8px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #764ba2 0%, #f093fb 100%);
        }

        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            .container {
                border-radius: 0;
                margin: 0;
            }

            body {
                padding: 0;
            }

            .header {
                padding: 16px;
            }

            .header h1 {
                font-size: 20px;
            }

            .header p {
                font-size: 13px;
            }

            .header .help-btn {
                display: none;
            }

            .header .version {
                top: 12px;
                right: 12px;
                padding: 4px 10px;
                font-size: 10px;
            }

            .tabs {
                overflow-x: auto;
                white-space: nowrap;
                padding: 0;
            }

            .tab {
                flex: 0 0 auto;
                padding: 10px 16px;
                font-size: 13px;
            }

            .row {
                flex-direction: column;
            }

            .content {
                padding: 12px;
            }

            /* è¡¨æ ¼ä¼˜åŒ– */
            table {
                font-size: 12px;
                display: block;
                overflow-x: auto;
            }

            thead, tbody, tr, td, th {
                display: block;
            }

            thead tr {
                position: sticky;
                top: 0;
                z-index: 10;
            }

            th, td {
                padding: 6px;
                white-space: nowrap;
            }

            tr {
                display: flex;
                flex-wrap: wrap;
            }

            th {
                flex: 1;
                min-width: 80px;
            }

            td {
                flex: 1;
                min-width: 80px;
            }

            /* å¡ç‰‡ä¼˜åŒ– */
            .card {
                padding: 12px;
                margin-bottom: 12px;
            }

            .card h3 {
                font-size: 14px;
                margin-bottom: 10px;
            }

            .form-group label {
                font-size: 13px;
            }

            .form-group input,
            .form-group select {
                padding: 8px;
                font-size: 13px;
            }

            .btn {
                padding: 8px 16px;
                font-size: 13px;
                width: 100%;
                margin: 5px 0;
            }

            .actions {
                flex-direction: column;
            }

            .summary-card {
                padding: 20px;
            }

            .summary-item {
                padding: 10px 0;
                font-size: 14px;
            }

            .summary-item span:last-child {
                font-size: 16px;
            }

            /* ä¸Šä¼ åŒºåŸŸä¼˜åŒ– */
            .upload-box {
                padding: 20px;
            }

            .upload-box h3 {
                font-size: 16px;
            }

            .upload-box p {
                font-size: 13px;
            }
        }

        /* è¶…å°å±å¹•ä¼˜åŒ– */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 20px;
            }

            .tab {
                padding: 10px 15px;
                font-size: 13px;
            }

            table {
                font-size: 11px;
            }

            th, td {
                padding: 6px;
                min-width: 70px;
            }

            .badge {
                font-size: 10px;
                padding: 4px 10px;
            }
        }

        /* äº§å“æ± è¡¨æ ¼ä¸“é—¨ä¼˜åŒ– */
        #poolTable {
            font-size: 13px;
            table-layout: fixed;
            width: 100%;
            max-width: 100%;
            overflow-x: auto;
        }

        #poolTable thead th {
            padding: 10px 8px;
            font-size: 12px;
            white-space: nowrap;
        }

        #poolTable tbody td {
            padding: 10px 8px;
            font-size: 13px;
        }

        /* äº§å“æ± åˆ—å®½æ§åˆ¶ */
        #poolTable col:nth-child(1) {
            width: 60px;
        }
        #poolTable col:nth-child(2) {
            width: 100px;
        }
        #poolTable col:nth-child(3) {
            width: 140px;
        }
        #poolTable col:nth-child(4) {
            width: 80px;
        }
        #poolTable col:nth-child(5) {
            width: 200px;
        }
        #poolTable col:nth-child(6) {
            width: 80px;
        }
        #poolTable col:nth-child(7) {
            width: 120px;
        }

        /* äº§å“åç§°åˆ—çœç•¥æ˜¾ç¤º */
        #poolTable td:nth-child(5) {
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
        }

        #poolTable td:nth-child(5):hover {
            overflow: visible;
            white-space: normal;
            word-wrap: break-word;
            background: #f8fafc;
            z-index: 10;
            position: relative;
        }

        /* ç­–ç•¥ç±»å‹åˆ—ä¼˜åŒ– */
        #poolTable td:nth-child(3) {
            max-width: 140px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 12px;
        }

        #poolTable td:nth-child(3):hover {
            overflow: visible;
            white-space: normal;
            background: #f8fafc;
            z-index: 10;
            position: relative;
        }

        /* äº§å“ä»£ç åˆ—ç­‰å®½å­—ä½“ */
        #poolTable td:nth-child(4) {
            font-size: 12px;
        }

        /* æ•°å€¼åˆ—å³å¯¹é½ */
        #poolTable td:nth-child(6) {
            text-align: right;
        }

        /* æ“ä½œåˆ—æŒ‰é’®ç¼©å° */
        #poolTable td:nth-child(7) .btn {
            padding: 6px 10px;
            font-size: 11px;
            margin-right: 4px;
        }

        /* åˆ†ç±»æ ‡é¢˜è¡Œä¼˜åŒ– */
        .category-header td {
            font-size: 13px;
            padding: 12px 10px;
        }

        /* äº§å“æ± ç­›é€‰æŒ‰é’®ç»„ä¼˜åŒ– */
        .pool-categories {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .pool-category-btn {
            padding: 8px 16px;
            font-size: 13px;
        }

        /* äº§å“åŒ¹é…æ¨¡æ€æ¡†ä¼˜åŒ–æ ·å¼ */
        .match-summary {
            padding: 12px 16px;
            background: linear-gradient(135deg, #f6f8fb 0%, #ffffff 100%);
            border-radius: 12px;
            margin-bottom: 12px;
            border: 1px solid #e2e8f0;
        }

        .match-summary p {
            margin: 4px 0;
            font-size: 12px;
            color: #4a5568;
            line-height: 1.5;
        }

        .match-summary strong {
            color: #2d3748;
            font-weight: 700;
            font-size: 14px;
        }

        .match-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 18px;
            font-size: 12px;
        }

        /* è¡¨æ ¼æ»šåŠ¨å®¹å™¨ */
        .match-table-scroll-container {
            overflow-y: auto;
            max-height: calc(90vh - 220px); /* å‡å»ç»Ÿè®¡ä¿¡æ¯ã€é¡µè„šçš„é«˜åº¦ */
            margin-bottom: 12px;
        }

        .match-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .match-table th {
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            letter-spacing: 0.2px;
            height: 42px; /* å›ºå®šé«˜åº¦ï¼Œä¸å³ä¾§è¡¨å¤´å¯¹é½ */
            box-sizing: border-box;
        }

        .match-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: middle;
            line-height: 1.4;
        }

        .match-table tr:hover {
            background-color: #f7fafc;
        }

        .matched-product {
            color: #38a169;
            font-weight: 600;
            font-size: 12px;
        }

        .unmatched-product {
            color: #e53e3e;
            font-style: italic;
            font-weight: 500;
        }

        .confidence-high {
            color: #38a169;
            font-weight: 700;
            font-size: 13px;
        }

        .confidence-medium {
            color: #ecc94b;
            font-weight: 600;
            font-size: 13px;
        }

        .confidence-low {
            color: #e53e3e;
            font-weight: 600;
            font-size: 13px;
        }

        .modal-footer {
            padding: 12px 16px;
            border-top: 2px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 8px;
        }

        .modal-footer .btn {
            padding: 6px 16px;
            font-size: 12px;
            font-weight: 600;
            min-width: 70px;
        }

        /* é‡å¤åŒ¹é…è­¦å‘Šå¼¹çª—æ ·å¼ */
        .duplicate-match-warning-modal {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10003;
            animation: fadeIn 0.2s ease-out;
        }

        .duplicate-match-warning-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            text-align: left;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease-out;
        }

        .duplicate-match-warning-icon {
            font-size: 48px;
            margin-bottom: 16px;
            text-align: center;
        }

        .duplicate-match-warning-text {
            font-size: 14px;
            color: #333333;
            line-height: 1.6;
            margin-bottom: 20px;
            white-space: pre-wrap;
        }

        .duplicate-match-warning-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 32px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: block;
            margin: 0 auto;
        }

        .duplicate-match-warning-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        /* é‡å¤åŒ¹é…è­¦å‘Šæ ·å¼ */
        .duplicate-match-warning {
            display: flex;
            align-items: center;
            background: #FFF5F5;
            border: 2px solid #E53E3E;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .duplicate-match-warning .warning-icon {
            font-size: 24px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .duplicate-match-warning .warning-content {
            flex: 1;
        }

        .duplicate-match-warning .warning-title {
            font-size: 13px;
            font-weight: 700;
            color: #E53E3E;
            margin-bottom: 4px;
        }

        .duplicate-match-warning .warning-message {
            font-size: 12px;
            color: #666666;
            line-height: 1.4;
        }

        .duplicate-match-warning .warning-close {
            background: none;
            border: none;
            font-size: 20px;
            color: #999999;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .duplicate-match-warning .warning-close:hover {
            background: rgba(0, 0, 0, 0.05);
            color: #666666;
        }

        .btn-sm {
            padding: 4px 10px;
            font-size: 11px;
            font-weight: 500;
            border-radius: 4px;
            gap: 3px;
        }

        /* è¡¨æ ¼æ“ä½œæŒ‰é’®æ ·å¼ - æ›´ç²¾è‡´ç´§å‡‘ */
        .btn-xs {
            padding: 3px 8px;
            font-size: 11px;
            font-weight: 500;
            border-radius: 3px;
            gap: 2px;
            min-width: 36px;
        }

        .btn-xs.btn-info {
            background: #1890ff;
            color: white;
            border: none;
        }

        .btn-xs.btn-info:hover {
            background: #0d7aff;
        }

        .btn-xs.btn-danger {
            background: #ff4d4f;
            color: white;
            border: none;
        }

        .btn-xs.btn-danger:hover {
            background: #cf1322;
        }

        .btn-xs.btn-success {
            background: #52c41a;
            color: white;
            border: none;
        }

        .btn-xs.btn-success:hover {
            background: #389e0d;
        }

        /* äº§å“åŒ¹é…æ¨¡æ€æ¡†çš„ç‰¹æ®Šæ ·å¼ */
        #productMatchModal .modal-content {
            position: relative;
            min-width: 900px;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }

        /* äº§å“åŒ¹é…æ¨¡æ€æ¡†çš„å¤´éƒ¨ */
        #productMatchModal .modal-header {
            flex-shrink: 0;
        }

        /* äº§å“åŒ¹é…æ¨¡æ€æ¡†çš„ä¸»å†…å®¹åŒºåŸŸ */
        #productMatchModalContent {
            position: relative;
            width: 100%;
            transition: width 0.3s ease;
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* å½“å³ä¾§é¢æ¿æ‰“å¼€æ—¶ï¼Œä¸»å†…å®¹åŒºåŸŸæ”¶ç¼© */
        #productMatchModalContent.has-sidebar {
            width: calc(100% - 400px) !important;
            flex: none !important;
        }

        /* äº§å“é€‰æ‹©é¢æ¿ */
        .selector-panel {
            display: none;
            position: absolute;
            right: 0;
            top: 100px; /* å‘ä¸Šç§»åŠ¨æ›´å¤š */
            bottom: 20px; /* å‡å°‘åº•éƒ¨è·ç¦»ï¼Œå¢åŠ æ›´å¤šé«˜åº¦ */
            width: 420px;
            background: #ffffff;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            padding: 0;
            z-index: 10002;
            display: flex;
            flex-direction: column;
        }

        /* äº§å“é€‰æ‹©é¢æ¿çš„è¡¨å¤´ */
        .selector-header {
            padding: 14px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            font-size: 13px;
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 48px;
            box-sizing: border-box;
        }

        .selector-header h3 {
            margin: 0;
            font-size: 13px;
            font-weight: 600;
        }

        .selector-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .selector-close:hover {
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
        }

        /* äº§å“é€‰æ‹©é¢æ¿çš„ä¸»ä½“éƒ¨åˆ†å¯æ»šåŠ¨ */
        .selector-body {
            padding: 18px;
            overflow-y: hidden; /* ä¸»ä½“ä¸æ»šåŠ¨ï¼Œå†…éƒ¨å…ƒç´ ç‹¬ç«‹æ»šåŠ¨ */
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* é¡¶éƒ¨å›ºå®šåŒºåŸŸï¼šæœç´¢æ¡†å’Œæç¤ºæ¡† */
        .selector-fixed-top {
            flex-shrink: 0;
            padding-bottom: 8px; /* å‡å°‘é—´è·ï¼Œæ›´ç´§å‡‘ */
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 8px; /* å‡å°‘é—´è·ï¼Œæ›´ç´§å‡‘ */
        }

        .search-container {
            margin-bottom: 16px;
            position: relative;
        }

        .search-container input {
            width: 100%;
            padding: 8px 10px 8px 32px; /* å‡å°‘å†…è¾¹è·ï¼Œæ›´ç´§å‡‘ */
            border: 1px solid #D9D9D9;
            border-radius: 6px;
            font-size: 13px;
            outline: none;
            transition: border-color 0.2s;
        }

        .search-container input:focus {
            border-color: #1890ff;
            box-shadow: 0 0 0 2px rgba(24,144,255,0.1);
            outline: none;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            font-size: 14px;
        }

        .product-options {
            overflow-y: auto;
            padding-right: 6px;
            flex: 1;
        }

        .selector-footer {
            padding: 16px 18px;
            border-top: 1px solid #E0E0E0;
            background: #F8F9FA;
            text-align: right;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .selector-footer .btn {
            padding: 8px 18px;
            font-size: 11px;
            font-weight: 600;
            min-width: 70px;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* äº§å“é€‰é¡¹æ ·å¼ */
        .option-hint {
            margin-bottom: 8px; /* å‡å°‘é—´è·ï¼Œæ›´ç´§å‡‘ */
            padding: 8px 10px; /* å‡å°‘å†…è¾¹è·ï¼Œæ›´ç´§å‡‘ */
            background: #FFF5F5;
            border: 1px solid #FFCDD2;
            border-radius: 6px;
            font-size: 11px; /* å‡å°å­—ä½“ */
            color: #D32F2F;
            line-height: 1.4;
        }

        .option-hint strong {
            font-weight: 700;
        }

        .option-group {
            margin-bottom: 14px;
        }

        .option-group-header {
            font-weight: 700;
            color: #FFFFFF;
            font-size: 12px;
            margin-bottom: 8px;
            padding: 10px 12px;
            background: linear-gradient(135deg, #6A5ACD 0%, #5E4AA2 100%);
            border-radius: 6px;
            letter-spacing: 0.2px;
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        .option-group-header.holding {
            background: linear-gradient(135deg, #666666 0%, #555555 100%);
        }

        .option-group-header span {
            margin-right: 6px;
        }

        .option-group-body {
            margin-left: 0;
        }

        .option-item {
            padding: 10px 12px;
            background: #FFFFFF;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 4px;
            border: 1px solid #E4E7ED;
            transition: all 0.2s;
            position: relative;
        }

        .option-item:hover {
            background: #F5F7FA;
            border-color: #C0C4CC;
        }

        .option-item.selected {
            background: #E6F7FF;
            border-color: #1890ff;
        }

        .option-item.selected:hover {
            background: #BAE7FF;
            border-color: #1890ff;
        }

        .option-item.unmatched {
            background: #FFF5F5;
            border-color: #FFCDD2;
        }

        .option-item.unmatched:hover {
            background: #FFE5E5;
            border-color: #EF9A9A;
        }

        .option-item.selected .option-left-border {
            display: block;
        }

        .option-left-border {
            display: none;
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: #1890ff;
            border-radius: 4px 0 0 4px;
        }

        .option-name {
            font-size: 13px;
            font-weight: 500;
            color: #333333;
            line-height: 1.4;
        }

        .option-code {
            font-size: 11px;
            color: #666666;
            margin-top: 4px;
        }

        .option-hint-text {
            font-size: 11px;
            color: #999;
            margin-top: 4px;
            line-height: 1.3;
        }

        .option-title {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .option-title span {
            font-weight: 600;
            font-size: 12px;
        }

        .option-title .matched {
            color: #1890ff;
        }

        .option-title .unmatched {
            color: #D32F2F;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>æ–°æ–¹ç¨‹ä¸“æˆ·è°ƒä»“è¯•ç®—å·¥å…·</h1>
            <button class="help-btn" onclick="showHelp()">ä½¿ç”¨è¯´æ˜</button>
            <div class="version">v4.6</div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('adjustment')">è°ƒä»“æ“ä½œ</button>
            <button class="tab" onclick="switchTab('holding')">æŒä»“å¯¼å…¥</button>
            <button class="tab" onclick="switchTab('pool')">äº§å“æ± </button>
            <button class="tab" onclick="switchTab('summary')">æ±‡æ€»</button>
        </div>

        <div id="alert" class="alert"></div>

        <!-- è°ƒä»“æ“ä½œé¡µé¢ -->
        <div id="adjustment" class="tab-content active">
            <h2 class="section-title">è°ƒä»“æ“ä½œ</h2>
            
            <!-- ä¹°å…¥æ“ä½œéƒ¨åˆ† -->
            <div class="card" style="margin-bottom: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 16px; border-bottom: 2px solid #e2e8f0; cursor: pointer;" onclick="toggleAdjustmentSection('buySection', 'buyToggle')">
                    <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: #1a1a1a; display: flex; align-items: center; gap: 8px;">
                        <span style="color: #1e40af;">ğŸ“¥</span>
                        ä¹°å…¥æ“ä½œ
                    </h3>
                    <span id="buyToggle" style="font-size: 20px; color: #64748b; transition: transform 0.2s;">â–¼</span>
                </div>
                
                <div id="buySection" style="padding-top: 16px;">
                    <div class="row">
                        <div class="col">
                            <div class="card" style="background: #ffffff; border: 2px solid #e2e8f0; box-shadow: none;">
                                <div class="form-group">
                                    <label>äº§å“åç§°</label>
                                    <div style="display: flex; gap: 10px;">
                                        <input type="text" id="buyProductName"
                                               placeholder="ç‚¹å‡»å³ä¾§æŒ‰é’®é€‰æ‹©äº§å“" 
                                               style="flex: 1; background: #F8F9FA; cursor: pointer; color: #212121;" 
                                               onclick="openBuyProductSelector()">
                                        <button class="btn btn-primary" onclick="openBuyProductSelector()" style="padding: 10px 20px; white-space: nowrap;">é€‰æ‹©äº§å“</button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>äº§å“ç­–ç•¥ç±»å‹</label>
                                    <input type="text" id="buyStrategyType" 
                                           placeholder="é€‰æ‹©äº§å“åè‡ªåŠ¨å¡«å……" 
                                           readonly 
                                           style="background: #F8F9FA;">
                                </div>
                                <div class="form-group">
                                    <label>ç”³è´­é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰</label>
                                    <input type="number" id="buyAmount" class="input-number" placeholder="è¯·è¾“å…¥ç”³è´­é‡‘é¢" step="0.01" min="0" oninput="calculateRemainingBuyAmount()">
                                    <p style="font-size: 14px; color: #1e40af; font-weight: 600; margin-top: 8px; background: #f0f4ff; padding: 10px; border-left: 4px solid #1e40af; border-radius: 4px;">
                                        ğŸ’° ä¹°å…¥ä¸Šé™ï¼š<span id="buyLimitAmount">0.00</span> ä¸‡å…ƒï¼ˆå¯ç”¨èµ„é‡‘ - å¾…ä»˜è´¹ç”¨ï¼‰
                                    </p>
                                    <p id="remainingBuyAmountDisplay" style="font-size: 13px; margin-top: 8px; padding: 8px; border-radius: 4px; background: #f7fafc;">
                                        å‰©ä½™å¯æŠ•é‡‘é¢ï¼š<span id="remainingBuyAmount">--</span> ä¸‡å…ƒ
                                    </p>
                                </div>
                                <button class="btn btn-primary" onclick="addBuyOrder()">æ·»åŠ åˆ°ä¹°å…¥åˆ—è¡¨</button>
                            </div>
                        </div>
                        <div class="col">
                            <div class="card" style="background: #ffffff; border: 2px solid #e2e8f0; box-shadow: none;">
                                <h3 style="margin: 0 0 16px 0; font-size: 15px; font-weight: 600; color: #1a1a1a;">ä¸“æˆ·æ€»å¸‚å€¼</h3>
                                <div class="form-group">
                                    <label>å½“å‰ä¸“æˆ·æ€»å¸‚å€¼ï¼ˆä¸‡å…ƒï¼‰</label>
                                    <input type="number" id="totalMarketValue" class="input-number" placeholder="å¯¼å…¥æŒä»“æ•°æ®åè‡ªåŠ¨æ˜¾ç¤º" step="0.01" min="0" readonly style="background: #e2e8f0;">
                                </div>
                                <p style="font-size: 13px; color: #64748b; margin-top: 10px;">æ­¤å€¼è‡ªåŠ¨ä»æŒä»“å¯¼å…¥ä¸­çš„åŸºé‡‘èµ„äº§å‡€å€¼è·å–ï¼Œè¯·å…ˆåœ¨æŒä»“å¯¼å…¥tabä¸­å¯¼å…¥åŸºé‡‘ä¼°å€¼è¡¨</p>
                            </div>
                        </div>
                    </div>

                    <div class="card" style="background: #ffffff; border: 2px solid #e2e8f0; box-shadow: none; margin-top: 20px;">
                        <h3 style="margin: 0 0 16px 0; font-size: 15px; font-weight: 600; color: #1a1a1a;">ä¹°å…¥åˆ—è¡¨</h3>
                        <table id="buyTable" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%); color: white;">
                                    <th style="padding: 12px; text-align: center;">å‹¾é€‰</th>
                                    <th style="padding: 12px; text-align: center;">äº§å“ç­–ç•¥ç±»å‹</th>
                                    <th style="padding: 12px; text-align: center;">äº§å“åç§°</th>
                                    <th style="padding: 12px; text-align: center;">ç”³è´­é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰</th>
                                    <th style="padding: 12px; text-align: center;">é¢„è®¡æŠ•åæ¯”ä¾‹ï¼ˆ%ï¼‰</th>
                                    <th style="padding: 12px; text-align: center;">æŠ•åæ¯”ä¾‹æ ¡éªŒ</th>
                                    <th style="padding: 12px; text-align: center;">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="buyTableBody">
                            </tbody>
                        </table>
                        <div id="buyEmptyState" class="empty-state">
                            <i>ğŸ“‹</i>
                            <p>æš‚æ— ä¹°å…¥äº§å“</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å–å‡ºæ“ä½œéƒ¨åˆ† -->
            <div class="card" style="margin-bottom: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 16px; border-bottom: 2px solid #e2e8f0; cursor: pointer;" onclick="toggleAdjustmentSection('sellSection', 'sellToggle')">
                    <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: #1a1a1a; display: flex; align-items: center; gap: 8px;">
                        <span style="color: #dc2626;">ğŸ“¤</span>
                        å–å‡ºæ“ä½œ
                    </h3>
                    <span id="sellToggle" style="font-size: 20px; color: #64748b; transition: transform 0.2s;">â–¶</span>
                </div>
                
                <div id="sellSection" style="display: none; padding-top: 16px;">
                    <div class="card" style="background: #ffffff; border: 2px solid #e2e8f0; box-shadow: none; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 16px 0; font-size: 15px; font-weight: 600; color: #1a1a1a;">æ·»åŠ å–å‡ºäº§å“</h3>
                        <div class="form-group">
                            <label>äº§å“åç§°</label>
                            <select id="sellProductName">
                                <option value="">è¯·é€‰æ‹©è¦å–å‡ºçš„äº§å“</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>å½“å‰å‡€å€¼</label>
                            <input type="number" id="sellCurrentNav" class="input-number" placeholder="è¯·è¾“å…¥å½“å‰å‡€å€¼" step="0.0001" min="0" readonly>
                        </div>
                        <div class="form-group">
                            <label>å½“å‰ä»½é¢ï¼ˆä¸‡ä»½ï¼‰</label>
                            <input type="number" id="sellCurrentShares" class="input-number" placeholder="è¯·è¾“å…¥å½“å‰ä»½é¢" step="0.01" min="0" readonly>
                        </div>
                        <div class="form-group">
                            <label>è®¡åˆ’èµå›ä»½é¢ï¼ˆä¸‡ä»½ï¼‰</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" id="sellRedeemShares" class="input-number" placeholder="è¯·è¾“å…¥èµå›ä»½é¢" step="0.01" min="0" oninput="calculateRemainingValue()" style="flex: 1;">
                                <button class="btn btn-primary" onclick="redeemAllShares()" style="padding: 14px 20px; white-space: nowrap;">ğŸ“¦ å…¨éƒ¨èµå›</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>èµå›é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰</label>
                            <input type="number" id="sellRedeemAmount" class="input-number" placeholder="èµå›é‡‘é¢" step="0.01" min="0" readonly>
                        </div>
                        <div class="form-group">
                            <label>å‰©ä½™å¸‚å€¼ï¼ˆä¸‡å…ƒï¼‰</label>
                            <input type="number" id="sellRemainingValue" class="input-number" placeholder="å‰©ä½™å¸‚å€¼" step="0.01" min="0" readonly>
                        </div>
                        <p id="remainingValueDisplay" style="font-size: 13px; margin-top: 8px; padding: 8px; border-radius: 4px; background: #f7fafc; display: none;">
                            å–å‡ºåå‰©ä½™å¸‚å€¼ï¼š<span id="remainingValueAmount">--</span> ä¸‡å…ƒ
                        </p>
                        <p id="remainingValueWarning" style="font-size: 13px; margin-top: 8px; padding: 10px 12px; border-radius: 4px; background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; display: none; font-weight: 600;">
                            âš ï¸ è­¦å‘Šï¼šå‰©ä½™å¸‚å€¼å°äº100ä¸‡å…ƒï¼éƒ¨åˆ†èµå›æ—¶å‰©ä½™å¸‚å€¼å¿…é¡» â‰¥ 100ä¸‡å…ƒï¼Œè¯·å‡å°‘èµå›ä»½é¢æˆ–é€‰æ‹©å…¨éƒ¨èµå›ã€‚
                        </p>
                        <button id="sellConfirmBtn2" class="btn btn-danger" onclick="addSellOrder()">æ·»åŠ åˆ°å–å‡ºåˆ—è¡¨</button>
                    </div>

                    <div class="card" style="background: #ffffff; border: 2px solid #e2e8f0; box-shadow: none;">
                        <h3 style="margin: 0 0 16px 0; font-size: 15px; font-weight: 600; color: #1a1a1a;">å–å‡ºåˆ—è¡¨</h3>
                        <table id="sellTable" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); color: white;">
                                    <th style="padding: 12px; text-align: center;">å‹¾é€‰</th>
                                    <th style="padding: 12px; text-align: center;">äº§å“åç§°</th>
                                    <th style="padding: 12px; text-align: center;">å½“å‰å‡€å€¼</th>
                                    <th style="padding: 12px; text-align: center;">å½“å‰ä»½é¢ï¼ˆä¸‡ä»½ï¼‰</th>
                                    <th style="padding: 12px; text-align: center;">è®¡åˆ’èµå›ä»½é¢ï¼ˆä¸‡ä»½ï¼‰</th>
                                    <th style="padding: 12px; text-align: center;">é¢„è®¡èµå›åå‰©ä½™å¸‚å€¼ï¼ˆä¸‡å…ƒï¼‰</th>
                                    <th style="padding: 12px; text-align: center;">é¢„è®¡æŠ•åæ¯”ä¾‹ï¼ˆ%ï¼‰</th>
                                    <th style="padding: 12px; text-align: center;">æŠ•åæ¯”ä¾‹æ ¡éªŒ</th>
                                    <th style="padding: 12px; text-align: center;">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="sellTableBody">
                            </tbody>
                        </table>
                        <div id="sellEmptyState" class="empty-state">
                            <i>ğŸ“‹</i>
                            <p>æš‚æ— å–å‡ºäº§å“</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æŒä»“é¡µé¢ -->
        <div id="holding" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 class="section-title" style="margin: 0;">æŒä»“å¯¼å…¥</h2>
                <div id="currentValuationProduct" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 8px 20px; border-radius: 25px; font-size: 14px; font-weight: 600; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                    ğŸ“Š å½“å‰ä¼°å€¼è¡¨ï¼š<span id="currentValuationProductName"></span>
                </div>
            </div>

            <div class="card">
                <h3>å¯¼å…¥åŸºé‡‘ä¼°å€¼è¡¨</h3>
                <p style="margin-bottom: 15px; color: #666;">ä¸Šä¼ åŸºé‡‘ä¼°å€¼è¡¨ï¼ˆ.xlsæˆ–.xlsxæ ¼å¼ï¼‰ï¼Œè‡ªåŠ¨æå–å·²æŠ•åŸºé‡‘ã€å¯æŠ•ç§‘ç›®ã€éœ€æ”¯ä»˜ç§‘ç›®</p>
                <div style="border: 2px dashed #667eea; border-radius: 10px; padding: 30px; text-align: center; margin-bottom: 25px; background: #f8f9ff; cursor: pointer;" onclick="document.getElementById('holdingFile').click()">
                    <h3 style="color: #667eea; margin-bottom: 10px;">ğŸ“ ä¸Šä¼ åŸºé‡‘ä¼°å€¼è¡¨</h3>
                    <p style="color: #666; font-size: 14px; margin-bottom: 15px;">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
                    <input type="file" id="holdingFile" accept=".xlsx,.xls,.XLS,.XLSX" onchange="handleHoldingFile(this)" style="display: none;">
                    <div id="holdingFileInfo" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
                </div>
                <div id="loading" style="display: none; text-align: center; padding: 20px;">
                    <div style="border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 10px;"></div>
                    <p>æ­£åœ¨å¤„ç†æ•°æ®...</p>
                </div>
            </div>

            <!-- å·²æŠ•åŸºé‡‘éƒ¨åˆ† -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">å·²æŠ•åŸºé‡‘éƒ¨åˆ†</h3>
                    <div style="display: flex; gap: 10px;">
                        <button id="reMatchBtn" class="btn btn-info" onclick="reopenProductMatchModal()" style="display: none; padding: 8px 16px; font-size: 14px;">
                            ğŸ”„ ä¿®æ”¹äº§å“åŒ¹é…
                        </button>
                        <button class="btn btn-success" onclick="saveInvestFundData()" style="padding: 8px 16px; font-size: 14px;">
                            ğŸ’¾ ä¿å­˜
                        </button>
                    </div>
                </div>
                <table id="investFundTable" class="holding-table">
                    <thead>
                        <tr>
                            <th style="width: 90px; text-align: center; padding: 8px;">äº§å“ä»£ç </th>
                            <th style="min-width: 200px; padding: 8px;">äº§å“åç§°ï¼ˆå«ä»½é¢ç±»åˆ«ï¼‰</th>
                            <th style="width: 90px; text-align: center; padding: 8px;">èµ„äº§ç±»åˆ«</th>
                            <th style="width: 100px; text-align: center; padding: 8px;">ç­–ç•¥ç±»å‹</th>
                            <th style="width: 200px; text-align: center; padding: 8px;">äº§å“ç­–ç•¥</th>
                            <th style="width: 100px; text-align: center; padding: 8px;">å½“å‰ä»½é¢ï¼ˆä¸‡ä»½ï¼‰</th>
                            <th style="width: 90px; text-align: center; padding: 8px;">æ ‡çš„å‡€å€¼</th>
                            <th style="width: 100px; text-align: center; padding: 8px;">å¸‚å€¼ï¼ˆä¸‡å…ƒï¼‰</th>
                            <th style="width: 110px; text-align: center; padding: 8px;">åŸºé‡‘èµ„äº§å‡€å€¼ï¼ˆä¸‡å…ƒï¼‰</th>
                            <th style="width: 80px; text-align: center; padding: 8px;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="investFundTableBody">
                    </tbody>
                </table>
                <div id="investFundEmptyState" class="empty-state">
                    <i>ğŸ“‹</i>
                    <p>æš‚æ— å·²æŠ•åŸºé‡‘æ•°æ®</p>
                </div>
            </div>

            <!-- å¯æŠ•ç§‘ç›®å’Œéœ€æ”¯ä»˜ç§‘ç›® - åŒåˆ—å¸ƒå±€ -->
            <div class="row">
                <div class="col">
                    <div class="card">
                        <h3>å¯ç”¨èµ„é‡‘</h3>
                        <table id="investableTable" class="holding-table">
                            <thead>
                                <tr>
                                    <th style="text-align: center;">åˆ†ç±»</th>
                                    <th style="width: 150px; text-align: center;">å¸‚å€¼ï¼ˆä¸‡å…ƒï¼‰</th>
                                </tr>
                            </thead>
                            <tbody id="investableTableBody">
                            </tbody>
                        </table>
                        <div id="investableEmptyState" class="empty-state">
                            <i>ğŸ“‹</i>
                            <p>æš‚æ— æ•°æ®</p>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card">
                        <h3>å¾…ä»˜è´¹ç”¨</h3>
                        <table id="payableTable" class="holding-table">
                            <thead>
                                <tr>
                                    <th style="text-align: center;">åˆ†ç±»</th>
                                    <th style="width: 150px; text-align: center;">å¸‚å€¼ï¼ˆä¸‡å…ƒï¼‰</th>
                                </tr>
                            </thead>
                            <tbody id="payableTableBody">
                            </tbody>
                        </table>
                        <div id="payableEmptyState" class="empty-state">
                            <i>ğŸ“‹</i>
                            <p>æš‚æ— æ•°æ®</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="actions">
                <button class="btn btn-success" onclick="exportHoldings()">å¯¼å‡ºExcel</button>
            </div>
        </div>

        <!-- äº§å“æ± é¡µé¢ -->
        <div id="pool" class="tab-content">
            <h2 class="section-title">å¯æŠ•äº§å“æ± </h2>

            <div class="card">
                <h3>äº§å“åˆ†ç±»</h3>
                <div class="pool-categories">
                    <button class="pool-category-btn active" onclick="filterPoolByCategory('all')">å…¨éƒ¨äº§å“ (55)</button>
                    <button class="pool-category-btn" onclick="filterPoolByCategory('è¿›å–ç±»')">è¿›å–ç±» (32)</button>
                    <button class="pool-category-btn" onclick="filterPoolByCategory('å¹³è¡¡ç±»')">å¹³è¡¡ç±» (9)</button>
                    <button class="pool-category-btn" onclick="filterPoolByCategory('ç¨³å¥ç±»')">ç¨³å¥ç±» (14)</button>
                </div>
            </div>

            <div class="card">
                <h3>äº§å“åˆ—è¡¨</h3>
                <table id="poolTable">
                    <colgroup>
                        <col style="width: 60px;">
                        <col style="width: 100px;">
                        <col style="width: 140px;">
                        <col style="width: 80px;">
                        <col style="width: 200px;">
                        <col style="width: 80px;">
                        <col style="width: 120px;">
                    </colgroup>
                    <thead>
                        <tr>
                            <th>èµ„äº§ç±»åˆ«</th>
                            <th>ç­–ç•¥ç±»å‹</th>
                            <th>äº§å“ç­–ç•¥ç±»å‹</th>
                            <th>äº§å“ä»£ç </th>
                            <th>äº§å“åç§°</th>
                            <th>èµ·æŠ•é—¨æ§›</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="poolTableBody">
                    </tbody>
                </table>
                <div id="poolEmptyState" class="empty-state">
                    <i>ğŸ“‹</i>
                    <p>æš‚æ— äº§å“æ•°æ®</p>
                </div>
                <div class="actions">
                    <button class="btn btn-primary" onclick="showAddPoolModal()">æ·»åŠ äº§å“</button>
                    <button class="btn btn-success" onclick="downloadImportTemplate()">ğŸ“¥ ä¸‹è½½å¯¼å…¥æ¨¡æ¿</button>
                    <button class="btn btn-info" onclick="importProducts()">å¯¼å…¥äº§å“</button>
                </div>
            </div>
        </div>

        <!-- æ±‡æ€»é¡µé¢ -->
        <div id="summary" class="tab-content">
            <h2 class="section-title">æŠ•èµ„æ–¹æ¡ˆæ±‡æ€»</h2>
            
            <div class="summary-card">
                <h3>ä¸“æˆ·æ¦‚å†µ</h3>
                <div class="summary-item">
                    <span>ä¸“æˆ·æ€»å¸‚å€¼</span>
                    <span id="summaryTotalValue">0.00 ä¸‡å…ƒ</span>
                </div>
                <div class="summary-item">
                    <span>ä¹°å…¥æ€»é‡‘é¢</span>
                    <span id="summaryBuyAmount">0.00 ä¸‡å…ƒ</span>
                </div>
                <div class="summary-item">
                    <span>å–å‡ºæ€»é‡‘é¢</span>
                    <span id="summarySellAmount">0.00 ä¸‡å…ƒ</span>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <div class="card">
                        <h3>è°ƒä»“åæŒä»“åˆ†å¸ƒæƒé‡</h3>
                        <table id="summaryAllocationTable">
                            <colgroup>
                                <col style="width: 50px;">
                                <col style="width: 180px;">
                                <col style="width: 120px;">
                                <col style="width: 100px;">
                                <col style="width: 100px;">
                                <col style="width: 80px;">
                            </colgroup>
                            <thead>
                                <tr>
                                    <th>åºå·</th>
                                    <th>äº§å“åç§°</th>
                                    <th>ç­–ç•¥ç±»å‹</th>
                                    <th>å½“å‰å¸‚å€¼</th>
                                    <th>è°ƒä»“åå¸‚å€¼</th>
                                    <th>å æ¯”</th>
                                </tr>
                            </thead>
                            <tbody id="summaryAllocationTableBody">
                            </tbody>
                        </table>
                        <div id="summaryAllocationEmptyState" class="empty-state">
                            <i>ğŸ“‹</i>
                            <p>æš‚æ— æŒä»“æ•°æ®</p>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card">
                        <h3>æ•°æ®ç®¡ç†</h3>
                        <div class="data-management-buttons">
                            <button class="btn btn-success" onclick="saveData()">ğŸ’¾ ä¿å­˜æ•°æ®</button>
                            <button class="btn btn-info" onclick="loadData()">ğŸ“‚ åŠ è½½æ•°æ®</button>
                            <button class="btn btn-danger" onclick="clearData()">ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®</button>
                            <button class="btn btn-primary" onclick="exportToExcel()">ğŸ“Š å¯¼å‡ºExcel</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä½¿ç”¨è¯´æ˜æ¨¡æ€æ¡† -->
    <div id="helpModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ä½¿ç”¨è¯´æ˜</h2>
                <button class="close-btn" onclick="closeHelp()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="help-section">
                    <h3>ğŸ“Š åŠŸèƒ½æ¦‚è§ˆ</h3>
                    <ul>
                        <li><strong>è°ƒä»“æ“ä½œ</strong>ï¼šæ·»åŠ ä¹°å…¥å’Œå–å‡ºäº§å“ï¼Œè®¡ç®—è°ƒä»“åçš„æŒä»“å˜åŒ–å’Œæ¯”ä¾‹åˆ†å¸ƒ</li>
                        <li><strong>æŒä»“å¯¼å…¥</strong>ï¼šä¸Šä¼ åŸºé‡‘ä¼°å€¼è¡¨ï¼ˆ.xls/.xlsxï¼‰ï¼Œè‡ªåŠ¨æå–å·²æŠ•åŸºé‡‘ã€å¯æŠ•ç§‘ç›®ã€éœ€æ”¯ä»˜ç§‘ç›®</li>
                        <li><strong>äº§å“æ± </strong>ï¼šæŸ¥çœ‹å’Œç®¡ç†å¯æŠ•äº§å“ï¼ˆå…±55ä¸ªäº§å“ï¼‰</li>
                        <li><strong>æ±‡æ€»æŠ¥è¡¨</strong>ï¼šç”Ÿæˆå®Œæ•´çš„æŠ•èµ„æ–¹æ¡ˆExcelæŠ¥å‘Šï¼ŒåŒ…å«è°ƒä»“åæŒä»“åˆ†å¸ƒæƒé‡</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>ğŸ“¥ æŒä»“å¯¼å…¥æµç¨‹</h3>
                    <ul>
                        <li><strong>æ­¥éª¤1</strong>ï¼šåœ¨"æŒä»“å¯¼å…¥"tabä¸­ç‚¹å‡»"ä¸Šä¼ åŸºé‡‘ä¼°å€¼è¡¨"æŒ‰é’®</li>
                        <li><strong>æ­¥éª¤2</strong>ï¼šé€‰æ‹©åŸºé‡‘ä¼°å€¼è¡¨æ–‡ä»¶ï¼ˆ.xlsæˆ–.xlsxæ ¼å¼ï¼‰</li>
                        <li><strong>æ­¥éª¤3</strong>ï¼šç³»ç»Ÿè‡ªåŠ¨æå–å·²æŠ•åŸºé‡‘ã€å¯æŠ•ç§‘ç›®ã€éœ€æ”¯ä»˜ç§‘ç›®</li>
                        <li><strong>æ­¥éª¤4</strong>ï¼šè‡ªåŠ¨è§¦å‘äº§å“åŒ¹é…ï¼Œç¡®è®¤åŒ¹é…ç»“æœ</li>
                        <li><strong>æ­¥éª¤5</strong>ï¼šå¯¹äºæœªåŒ¹é…çš„äº§å“ï¼Œå¯ä»¥æ‰‹åŠ¨é€‰æ‹©èµ„äº§ç±»åˆ«ã€ç­–ç•¥ç±»å‹ã€äº§å“ç­–ç•¥</li>
                        <li><strong>æ­¥éª¤6</strong>ï¼šç‚¹å‡»"ä¿å­˜"æŒ‰é’®ä¿å­˜æŒä»“æ•°æ®</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>ğŸ”„ äº§å“åŒ¹é…è§„åˆ™</h3>
                    <ul>
                        <li><strong>ä¼˜å…ˆçº§1</strong>ï¼šæ ‡å‡†åŒ–åç§°å®Œå…¨åŒ¹é…ï¼ˆç½®ä¿¡åº¦100%ï¼‰</li>
                        <li><strong>ä¼˜å…ˆçº§2</strong>ï¼šç®¡ç†äºº+ç­–ç•¥+åºå·å®Œå…¨åŒ¹é…ï¼ˆç½®ä¿¡åº¦95%ï¼‰</li>
                        <li><strong>ä¼˜å…ˆçº§3</strong>ï¼šç®¡ç†äºº+ç­–ç•¥åŒ¹é…ï¼ˆç½®ä¿¡åº¦85%ï¼‰</li>
                        <li><strong>ä¼˜å…ˆçº§4</strong>ï¼šç®¡ç†äºº+åºå·åŒ¹é…ï¼ˆç½®ä¿¡åº¦75%ï¼‰</li>
                        <li><strong>ä¼˜å…ˆçº§5</strong>ï¼šç®¡ç†äººå”¯ä¸€åŒ¹é…ï¼ˆç½®ä¿¡åº¦60%ï¼‰</li>
                        <li><strong>é€‰é¡¹</strong>ï¼šå¯ä»¥é€‰æ‹©ä¿ç•™ä¼°å€¼è¡¨åŸå§‹åç§°ï¼Œä¸è¿›è¡ŒåŒ¹é…</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>ğŸ“Š è°ƒä»“æ“ä½œè§„åˆ™</h3>
                    <ul>
                        <li><strong>ä¹°å…¥è§„åˆ™</strong>ï¼šä¹°å…¥é‡‘é¢ä¸èƒ½è¶…è¿‡ï¼ˆå¯æŠ•ç§‘ç›®æ€»é‡‘é¢ - éœ€æ”¯ä»˜ç§‘ç›®æ€»é‡‘é¢ï¼‰</li>
                        <li><strong>å–å‡ºè§„åˆ™</strong>ï¼šåªèƒ½å–å‡ºå·²æŠ•åŸºé‡‘ï¼Œéƒ¨åˆ†èµå›æ—¶å‰©ä½™å¸‚å€¼å¿…é¡»â‰¥100ä¸‡å…ƒ</li>
                        <li><strong>äº§å“äº’æ–¥</strong>ï¼šåŒä¸€ä¸ªäº§å“ä¸èƒ½åŒæ—¶è¿›è¡Œä¹°å…¥å’Œå–å‡ºæ“ä½œ</li>
                        <li><strong>å…¨éƒ¨èµå›</strong>ï¼šå…¨éƒ¨èµå›æ— å¸‚å€¼é™åˆ¶</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>ğŸ’¾ æ•°æ®ç®¡ç†</h3>
                    <ul>
                        <li><strong>ä¿å­˜æ•°æ®</strong>ï¼šæŒä»“tabä¸­çš„"ä¿å­˜"æŒ‰é’®ï¼Œä¿å­˜å·²æŠ•åŸºé‡‘æ•°æ®åˆ°æµè§ˆå™¨æœ¬åœ°</li>
                        <li><strong>å¯¼å‡ºExcel</strong>ï¼šæŒä»“tabä¸­çš„"å¯¼å‡ºExcel"æŒ‰é’®ï¼Œä¸‹è½½æŒä»“æ•°æ®</li>
                        <li><strong>å¯¼å‡ºæ–¹æ¡ˆ</strong>ï¼šæ±‡æ€»tabä¸­çš„"å¯¼å‡ºExcel"æŒ‰é’®ï¼Œä¸‹è½½å®Œæ•´æŠ•èµ„æ–¹æ¡ˆæŠ¥å‘Š</li>
                        <li><strong>æ•°æ®åŒæ­¥</strong>ï¼šæŒä»“tabä¸­çš„ä¿®æ”¹ä¼šè‡ªåŠ¨åŒæ­¥åˆ°è°ƒä»“æ“ä½œå’Œæ±‡æ€»tab</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>âš ï¸ æ³¨æ„äº‹é¡¹</h3>
                    <ul>
                        <li>æ•°æ®ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°ï¼Œæ¸…é™¤æµè§ˆå™¨ç¼“å­˜ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±</li>
                        <li>å»ºè®®å®šæœŸä½¿ç”¨"å¯¼å‡ºExcel"åŠŸèƒ½å¤‡ä»½æ•°æ®</li>
                        <li>å•ä¸ªäº§å“æŠ•åæ¯”ä¾‹â‰¥30%ä¼šæ˜¾ç¤ºé»„è‰²è­¦å‘Š</li>
                        <li>åŸºé‡‘èµ„äº§å‡€å€¼ä¸º0æ—¶ï¼Œè¯·ç¡®è®¤ä¸Šä¼ çš„æ˜¯æ­£ç¡®çš„ä¼°å€¼è¡¨</li>
                        <li>äº§å“åŒ¹é…åå¯ä»¥ç‚¹å‡»"ä¿®æ”¹äº§å“åŒ¹é…"æŒ‰é’®é‡æ–°åŒ¹é…</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>ğŸ“ æŠ€æœ¯æ”¯æŒ</h3>
                    <ul>
                        <li>ç‰ˆæœ¬ï¼šv4.6</li>
                        <li>æ›´æ–°æ—¥æœŸï¼š2026å¹´2æœˆ15æ—¥</li>
                        <li>å¦‚é‡é—®é¢˜ï¼Œè¯·æ¸…ç©ºæ•°æ®åé‡æ–°æ“ä½œ</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- äº§å“åŒ¹é…æ¨¡æ€æ¡† -->
    <div id="productMatchModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ”„ äº§å“åŒ¹é…ç¡®è®¤</h2>
                <button class="close-btn" onclick="closeProductMatchModal()">&times;</button>
            </div>
            <div id="productMatchModalContent">
                <!-- åŠ¨æ€å†…å®¹ -->
            </div>
        </div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘äº§å“æ¨¡æ€æ¡† -->
    <div id="addPoolModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="addPoolModalTitle">æ·»åŠ äº§å“åˆ°äº§å“æ± </h2>
                <button class="close-btn" onclick="closeAddPoolModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>èµ„äº§ç±»åˆ« *</label>
                    <select id="addAssetClass">
                        <option value="">è¯·é€‰æ‹©èµ„äº§ç±»åˆ«</option>
                        <option value="è¿›å–ç±»">è¿›å–ç±»</option>
                        <option value="å¹³è¡¡ç±»">å¹³è¡¡ç±»</option>
                        <option value="ç¨³å¥ç±»">ç¨³å¥ç±»</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ç­–ç•¥ç±»å‹ *</label>
                    <select id="addStrategyType" onchange="onStrategyTypeChange()">
                        <option value="">è¯·å…ˆé€‰æ‹©èµ„äº§ç±»åˆ«</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>äº§å“ç­–ç•¥ç±»å‹ï¼ˆæŠ•èµ„æ–¹æ¡ˆç”¨ï¼‰ *</label>
                    <select id="addStrategyName">
                        <option value="">è¯·é€‰æ‹©äº§å“ç­–ç•¥ç±»å‹</option>
                        <option value="è¿›å–ç±»èµ„äº§ï¼ˆä¸»è§‚è‚¡ç¥¨å¤šå¤´ï¼‰">è¿›å–ç±»èµ„äº§ï¼ˆä¸»è§‚è‚¡ç¥¨å¤šå¤´ï¼‰</option>
                        <option value="è¿›å–ç±»èµ„äº§ï¼ˆé‡åŒ–é€‰è‚¡ï¼‰">è¿›å–ç±»èµ„äº§ï¼ˆé‡åŒ–é€‰è‚¡ï¼‰</option>
                        <option value="å¹³è¡¡ç±»èµ„äº§ï¼ˆCTAï¼‰">å¹³è¡¡ç±»èµ„äº§ï¼ˆCTAï¼‰</option>
                        <option value="å¹³è¡¡ç±»èµ„äº§ï¼ˆå®è§‚å¯¹å†²ï¼‰">å¹³è¡¡ç±»èµ„äº§ï¼ˆå®è§‚å¯¹å†²ï¼‰</option>
                        <option value="å¹³è¡¡ç±»èµ„äº§ï¼ˆå¤šç­–ç•¥ï¼‰">å¹³è¡¡ç±»èµ„äº§ï¼ˆå¤šç­–ç•¥ï¼‰</option>
                        <option value="ç¨³å¥ç±»èµ„äº§ï¼ˆå¸‚åœºä¸­æ€§ï¼‰">ç¨³å¥ç±»èµ„äº§ï¼ˆå¸‚åœºä¸­æ€§ï¼‰</option>
                        <option value="ç¨³å¥ç±»èµ„äº§ï¼ˆå€ºåˆ¸ï¼‰">ç¨³å¥ç±»èµ„äº§ï¼ˆå€ºåˆ¸ï¼‰</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>äº§å“ä»£ç  *</label>
                    <input type="text" id="addProductCode" placeholder="ä¾‹å¦‚ï¼šSNZ840">
                </div>
                <div class="form-group">
                    <label>äº§å“åç§° *</label>
                    <input type="text" id="addProductName" placeholder="ä¾‹å¦‚ï¼šæ˜æ±¯ç¨³å¥å¢é•¿6æœŸç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘">
                </div>
                <div class="form-group">
                    <label>èµ·æŠ•é—¨æ§›ï¼ˆä¸‡å…ƒï¼‰ *</label>
                    <input type="number" id="addMinInvest" placeholder="ä¾‹å¦‚ï¼š100" step="1" min="0">
                </div>
                <div style="margin-top: 25px; text-align: right;">
                    <button class="btn btn-danger" onclick="closeAddPoolModal()">å–æ¶ˆ</button>
                    <button class="btn btn-primary" onclick="confirmAddProduct()">ç¡®è®¤æ·»åŠ </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¿®æ”¹äº§å“åç§°æ¨¡æ€æ¡† -->
    <div id="editProductNameModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ä¿®æ”¹äº§å“åç§°</h2>
                <button class="close-btn" onclick="closeEditProductNameModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>å½“å‰äº§å“åç§°</label>
                    <input type="text" id="editOldProductName" readonly style="background: #e2e8f0;">
                </div>
                <div class="form-group">
                    <label>æ–°äº§å“åç§°</label>
                    <input type="text" id="editNewProductName" placeholder="è¯·è¾“å…¥æ–°çš„äº§å“åç§°">
                    <p style="color: #e53e3e; font-size: 12px; margin-top: 5px;">âš ï¸ æ³¨æ„ï¼šä»…ä¿®æ”¹äº§å“åç§°ï¼Œä¸å½±å“ä»½é¢ã€å‡€å€¼ç­‰å…¶ä»–æ•°æ®</p>
                </div>
                <div style="margin-top: 25px; text-align: right;">
                    <button class="btn btn-danger" onclick="closeEditProductNameModal()">å–æ¶ˆ</button>
                    <button class="btn btn-primary" onclick="confirmEditProductName()">ç¡®è®¤ä¿®æ”¹</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¹°å…¥äº§å“é€‰æ‹©å™¨é¢æ¿ -->
    <div id="buyProductSelectorPanel" style="display: none; position: fixed; right: 0; top: 0; bottom: 0; width: 420px; background: #ffffff; box-shadow: -2px 0 10px rgba(0,0,0,0.1); padding: 0; overflow-y: auto; z-index: 10002;">
        <div style="padding: 16px 20px; border-bottom: 1px solid #E0E0E0; background: linear-gradient(135deg, #6A5ACD 0%, #5E4AA2 100%); color: white;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 15px; font-weight: 600;">é€‰æ‹©ä¹°å…¥äº§å“</h3>
                <button onclick="closeBuyProductSelector()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: white; line-height: 1; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='none'">&times;</button>
            </div>
        </div>
        <div style="padding: 20px;">
            <div style="margin-bottom: 16px; position: relative;">
                <input type="text" id="buyProduct-search-panel" 
                       placeholder="æœç´¢äº§å“åç§°æˆ–ä»£ç ..." 
                       oninput="filterBuyProductOptionsPanel()"
                       style="width: 100%; padding: 10px 12px 10px 40px; border: 1px solid #D9D9D9; border-radius: 6px; font-size: 13px; color: #212121; transition: all 0.2s;"
                       onfocus="this.style.borderColor='#1890ff'; this.style.boxShadow='0 0 0 2px rgba(24,144,255,0.1)'"
                       onblur="this.style.borderColor='#D9D9D9'; this.style.boxShadow='none'">
                <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #999; font-size: 14px;">ğŸ”</span>
            </div>
            <div id="buyProduct-options-panel" style="max-height: calc(100vh - 300px); overflow-y: auto; padding-right: 4px;">
                <!-- åŠ¨æ€å†…å®¹ -->
            </div>
        </div>
        <div style="padding: 16px 20px; border-top: 1px solid #E0E0E0; background: #F8F9FA; text-align: right;">
            <button class="btn btn-danger" id="buyProductCancelBtn" onclick="closeBuyProductSelector()" style="background: #FFFFFF; border: 1px solid #C0C0C0; color: #595959; margin-right: 12px; width: 80px; height: 32px;">å–æ¶ˆ</button>
            <button class="btn btn-primary" id="buyProductConfirmBtn" onclick="confirmBuyProductSelection()" style="background: #1890ff; border: none; color: #FFFFFF; width: 80px; height: 32px;">ç¡®è®¤</button>
        </div>
    </div>

    <!-- è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡† -->
    <div id="confirmModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10003; align-items: center; justify-content: center;">
        <div style="background: #ffffff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-width: 400px; width: 90%; overflow: hidden;">
            <div style="padding: 20px 20px 0 20px;">
                <div style="display: flex; align-items: flex-start; gap: 12px;">
                    <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #6A5ACD 0%, #5E4AA2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <span style="font-size: 20px;">âš ï¸</span>
                    </div>
                    <div style="flex: 1;">
                        <h3 id="confirmModalTitle" style="margin: 0 0 6px 0; font-size: 16px; font-weight: 600; color: #212121;">ç¡®è®¤æ“ä½œ</h3>
                        <p id="confirmModalMessage" style="margin: 0; font-size: 13px; color: #666; line-height: 1.6; white-space: pre-line;"></p>
                    </div>
                </div>
            </div>
            <div style="padding: 16px 20px; background: #F8F9FA; display: flex; gap: 10px; justify-content: flex-end;">
                <button id="confirmModalCancel" onclick="closeConfirmModal()" style="padding: 8px 20px; border: 1px solid #D9D9D9; background: #ffffff; color: #666; border-radius: 4px; font-size: 13px; font-weight: 500; cursor: pointer;">å–æ¶ˆ</button>
                <button id="confirmModalConfirm" onclick="executeConfirmAction()" style="padding: 8px 20px; border: none; background: linear-gradient(135deg, #6A5ACD 0%, #5E4AA2 100%); color: #ffffff; border-radius: 4px; font-size: 13px; font-weight: 500; cursor: pointer;">ç¡®è®¤æ¸…ç©º</button>
            </div>
        </div>
    </div>

    <script>
        // ç¡®ä¿switchTabå‡½æ•°åœ¨é¡µé¢åŠ è½½æ—¶å°±è¢«å®šä¹‰
        window.switchTab = function(tabId) {
            // éšè—æ‰€æœ‰æ ‡ç­¾å†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„activeç±»
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾å†…å®¹
            const tabContent = document.getElementById(tabId);
            if (tabContent) {
                tabContent.classList.add('active');
            }
            // æ·»åŠ activeç±»åˆ°é€‰ä¸­çš„æ ‡ç­¾
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                if (tab.getAttribute('onclick') && tab.getAttribute('onclick').includes(`'${tabId}'`)) {
                    tab.classList.add('active');
                }
            });

            // æ›´æ–°é¡µé¢æ•°æ®
            if (typeof updateBuyTable === 'function' && tabId === 'adjustment') {
                updateBuyTable();
            }
            if (typeof updateSellTable === 'function' && tabId === 'adjustment') {
                updateSellTable();
            }
            if (typeof updateBuyTable === 'function' && tabId === 'buy') {
                updateBuyTable();
            }
            if (typeof updateSellTable === 'function' && tabId === 'sell') {
                updateSellTable();
                if (typeof updateSellProducts === 'function') {
                    updateSellProducts();
                }
            }
            if (typeof updateHoldingTable === 'function' && tabId === 'holding') {
                updateHoldingTable();
            }
            if (typeof updatePoolTable === 'function' && tabId === 'pool') {
                updatePoolTable();
            }
            if (typeof updateSummary === 'function' && tabId === 'summary') {
                updateSummary();
            }
        };
    </script>
    
    <script>
        // ç‰ˆæœ¬ä¿¡æ¯
        const APP_VERSION = '4.6';
        const APP_UPDATE_DATE = '2026-02-15';

        // å…¨å±€æ•°æ®
        let buyOrders = [];
        let sellOrders = [];
        let holdings = [];
        let productPool = [];
        let totalMarketValue = 4937.94;
let fundAssetValue = 0; // åŸºé‡‘èµ„äº§å‡€å€¼ï¼Œä»æŒä»“ä¸­è·å–
let hasImportedHoldings = false; // æ˜¯å¦å·²å¯¼å…¥æŒä»“æ•°æ®
let investableAmount = 0; // å¯æŠ•èµ„é‡‘é¢ï¼ˆå¯æŠ•ç§‘ç›®æ€»é‡‘é¢ - éœ€æ”¯ä»˜ç§‘ç›®æ€»é‡‘é¢ï¼‰
let payableAmount = 0; // éœ€æ”¯ä»˜ç§‘ç›®æ€»é‡‘é¢
let processedData = null; // å¤„ç†åçš„ä¼°å€¼è¡¨æ•°æ®

        // ç­–ç•¥ç±»å‹æ˜ å°„é…ç½®
        const STRATEGY_MAPPING = {
            'è¿›å–ç±»': {
                strategies: ['ä¸»è§‚è‚¡ç¥¨å¤šå¤´', 'é‡åŒ–é€‰è‚¡', 'ç§å‹Ÿä¸»è§‚', 'é‡åŒ–æŒ‡å¢'],
                mapping: {
                    'ä¸»è§‚è‚¡ç¥¨å¤šå¤´': 'è¿›å–ç±»èµ„äº§ï¼ˆä¸»è§‚è‚¡ç¥¨å¤šå¤´ï¼‰',
                    'é‡åŒ–é€‰è‚¡': 'è¿›å–ç±»èµ„äº§ï¼ˆé‡åŒ–é€‰è‚¡ï¼‰',
                    'ç§å‹Ÿä¸»è§‚': 'è¿›å–ç±»èµ„äº§ï¼ˆä¸»è§‚è‚¡ç¥¨å¤šå¤´ï¼‰',
                    'é‡åŒ–æŒ‡å¢': 'è¿›å–ç±»èµ„äº§ï¼ˆé‡åŒ–é€‰è‚¡ï¼‰'
                }
            },
            'å¹³è¡¡ç±»': {
                strategies: ['CTA', 'å¤šç­–ç•¥', 'å®è§‚å¯¹å†²'],
                mapping: {
                    'CTA': 'å¹³è¡¡ç±»èµ„äº§ï¼ˆCTAï¼‰',
                    'å¤šç­–ç•¥': 'å¹³è¡¡ç±»èµ„äº§ï¼ˆå¤šç­–ç•¥ï¼‰',
                    'å®è§‚å¯¹å†²': 'å¹³è¡¡ç±»èµ„äº§ï¼ˆå®è§‚å¯¹å†²ï¼‰'
                }
            },
            'ç¨³å¥ç±»': {
                strategies: ['å¸‚åœºä¸­æ€§', 'æµ·å¤–å€ºåˆ¸', 'å›ºå®šæ”¶ç›Šï¼ˆç§å‹Ÿå€ºï¼‰'],
                mapping: {
                    'å¸‚åœºä¸­æ€§': 'ç¨³å¥ç±»èµ„äº§ï¼ˆå¸‚åœºä¸­æ€§ï¼‰',
                    'æµ·å¤–å€ºåˆ¸': 'ç¨³å¥ç±»èµ„äº§ï¼ˆå€ºåˆ¸ï¼‰',
                    'å›ºå®šæ”¶ç›Šï¼ˆç§å‹Ÿå€ºï¼‰': 'ç¨³å¥ç±»èµ„äº§ï¼ˆå€ºåˆ¸ï¼‰'
                }
            }
        };

        // åˆå§‹åŒ–é»˜è®¤äº§å“æ± ï¼ˆæ–°æ–¹ç¨‹è‡»é€‰30ä¸“äº« - åŒ…å«ä¸¤ä¸ªsheetçš„æ•°æ®ï¼‰
        function initProductPool() {
            productPool = [
                // ========== Sheet1: åœ¨å”®æ—¥é”€è¡¨äº§å“ï¼ˆæœºæ„ä»½é¢ï¼‰ ==========

                // ä¸»è§‚ç­–ç•¥
                { assetClass: 'è¿›å–ç±»', strategyType: 'ä¸»è§‚è‚¡ç¥¨å¤šå¤´', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆä¸»è§‚è‚¡ç¥¨å¤šå¤´ï¼‰', code: 'TR342B', name: 'æ¯•ç››ç‹®ç¿Bç±»ä»½é¢', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'ä¸»è§‚è‚¡ç¥¨å¤šå¤´', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆä¸»è§‚è‚¡ç¥¨å¤šå¤´ï¼‰', code: 'T07830', name: 'ç€›èµåˆ›ç€›Bç±»ä»½é¢', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'ä¸»è§‚è‚¡ç¥¨å¤šå¤´', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆä¸»è§‚è‚¡ç¥¨å¤šå¤´ï¼‰', code: '23410B', name: 'å…´èšè´¢å¯Œ3å·Bç±»ä»½é¢', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'ä¸»è§‚è‚¡ç¥¨å¤šå¤´', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆä¸»è§‚è‚¡ç¥¨å¤šå¤´ï¼‰', code: 'WYE853A', name: 'èšé¸£åŒ ä¼ 6å·Aç±»ä»½é¢', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'ä¸»è§‚è‚¡ç¥¨å¤šå¤´', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆä¸»è§‚è‚¡ç¥¨å¤šå¤´ï¼‰', code: 'SEE585', name: 'å®æ³‰è‡´è¿œ10å·ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'ä¸»è§‚è‚¡ç¥¨å¤šå¤´', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆä¸»è§‚è‚¡ç¥¨å¤šå¤´ï¼‰', code: 'T07812', name: 'ç¿ç’æŠ•èµ„-ç¿æ¡ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘(Bç±»ä»½é¢)', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'ä¸»è§‚è‚¡ç¥¨å¤šå¤´', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆä¸»è§‚è‚¡ç¥¨å¤šå¤´ï¼‰', code: 'AKP57B', name: 'ä¿¡ç’æŠ•èµ„-ä»·å€¼ç²¾è‹±M1ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘Bç±»ä»½é¢', minInvest: 1000 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'ä¸»è§‚è‚¡ç¥¨å¤šå¤´', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆä¸»è§‚è‚¡ç¥¨å¤šå¤´ï¼‰', code: 'AKP57C', name: 'ä¿¡ç’æŠ•èµ„-ä»·å€¼ç²¾è‹±M1ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘Cç±»ä»½é¢', minInvest: 1000 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'ä¸»è§‚è‚¡ç¥¨å¤šå¤´', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆä¸»è§‚è‚¡ç¥¨å¤šå¤´ï¼‰', code: 'J2021A', name: 'ä»æ¡¥é²²æ·¼3æœŸç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘Aç±»ä»½é¢', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'ä¸»è§‚è‚¡ç¥¨å¤šå¤´', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆä¸»è§‚è‚¡ç¥¨å¤šå¤´ï¼‰', code: 'SCY292', name: 'å¤§ç¦¾æŠ•èµ„-æ˜é‡‘707å·ç§å‹ŸæŠ•èµ„åŸºé‡‘', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'ä¸»è§‚è‚¡ç¥¨å¤šå¤´', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆä¸»è§‚è‚¡ç¥¨å¤šå¤´ï¼‰', code: 'SX8958', name: 'ä¸¹ç¾¿-é”è¿›1å·ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'ä¸»è§‚è‚¡ç¥¨å¤šå¤´', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆä¸»è§‚è‚¡ç¥¨å¤šå¤´ï¼‰', code: 'QX490B', name: 'æœ›æ­£ä¸­å›½æˆé•¿2å·ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘Bç±»ä»½é¢', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'ä¸»è§‚è‚¡ç¥¨å¤šå¤´', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆä¸»è§‚è‚¡ç¥¨å¤šå¤´ï¼‰', code: 'T06118', name: 'åˆè¿œé›¨æ²›ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘1æœŸBç±»ä»½é¢', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'ä¸»è§‚è‚¡ç¥¨å¤šå¤´', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆä¸»è§‚è‚¡ç¥¨å¤šå¤´ï¼‰', code: 'T05382', name: 'ç“´ä»è‡´è¿œé•¿é’ä¸€æœŸç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘Bç±»ä»½é¢', minInvest: 200 },

                // é‡åŒ–é€‰è‚¡ç­–ç•¥
                { assetClass: 'è¿›å–ç±»', strategyType: 'é‡åŒ–é€‰è‚¡', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆé‡åŒ–é€‰è‚¡ï¼‰', code: 'ABP15A', name: 'å€æ¼¾é‡åŒ–é€‰è‚¡ä¸€æœŸç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘Aç±»ä»½é¢', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'é‡åŒ–é€‰è‚¡', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆé‡åŒ–é€‰è‚¡ï¼‰', code: 'BWYB61B', name: 'å› è¯ºå¤©ä¸°å‡è¡¡ä¼˜äº«27å·ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘Bç±»ä»½é¢', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'é‡åŒ–é€‰è‚¡', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆé‡åŒ–é€‰è‚¡ï¼‰', code: 'AQJ05C', name: 'ä¸–çºªå‰æ²¿ä¸­è¯A500æŒ‡æ•°å¢å¼º1å·ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘Cç±»ä»½é¢', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'é‡åŒ–é€‰è‚¡', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆé‡åŒ–é€‰è‚¡ï¼‰', code: 'SNH005', name: 'ä¸–çºªå‰æ²¿æŒ‡æ•°å¢å¼º5å·ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'é‡åŒ–é€‰è‚¡', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆé‡åŒ–é€‰è‚¡ï¼‰', code: 'XQ945B', name: 'ä¸–çºªå‰æ²¿é‡åŒ–ä¼˜é€‰3å·aæœŸç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘Bç±»ä»½é¢', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'é‡åŒ–é€‰è‚¡', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆé‡åŒ–é€‰è‚¡ï¼‰', code: 'WYM269B', name: 'é»‘ç¿¼ä¸­è¯500æŒ‡æ•°å¢å¼º3å·ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘Bç±»ä»½é¢', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'é‡åŒ–é€‰è‚¡', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆé‡åŒ–é€‰è‚¡ï¼‰', code: 'XY8078', name: 'é»‘ç¿¼ä¸­è¯1000æŒ‡æ•°å¢å¼º9å·ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘Bç±»ä»½é¢', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'é‡åŒ–é€‰è‚¡', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆé‡åŒ–é€‰è‚¡ï¼‰', code: 'ZX398B', name: 'é»‘ç¿¼é‡åŒ–æˆé•¿9å·ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘Bç±»ä»½é¢', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'é‡åŒ–é€‰è‚¡', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆé‡åŒ–é€‰è‚¡ï¼‰', code: 'SH455B', name: 'æ˜æ±¯è‚¡ç¥¨ç²¾é€‰13æœŸBç±»ä»½é¢', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'é‡åŒ–é€‰è‚¡', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆé‡åŒ–é€‰è‚¡ï¼‰', code: 'SNZ840', name: 'æ˜æ±¯ç¨³å¥å¢é•¿6æœŸç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'é‡åŒ–é€‰è‚¡', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆé‡åŒ–é€‰è‚¡ï¼‰', code: 'ND698B', name: 'æ˜æ±¯ä»·å€¼æˆé•¿5æœŸç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘Bç±»ä»½é¢', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'é‡åŒ–é€‰è‚¡', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆé‡åŒ–é€‰è‚¡ï¼‰', code: 'SNH811', name: 'è¡å¤å…´äº«æ–°åŠ¨åŠ›æŒ‡å¢ä¸€å·', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'é‡åŒ–é€‰è‚¡', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆé‡åŒ–é€‰è‚¡ï¼‰', code: 'SNP647', name: 'è¡å¤1000æŒ‡å¢ä¸€å·ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'é‡åŒ–é€‰è‚¡', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆé‡åŒ–é€‰è‚¡ï¼‰', code: 'ZWY824B', name: 'è¡å¤å°å¸‚å€¼æŒ‡æ•°å¢å¼ºä¸€å·ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘Bç±»ä»½é¢', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'é‡åŒ–é€‰è‚¡', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆé‡åŒ–é€‰è‚¡ï¼‰', code: 'BEP40C', name: 'å¾®è§‚åšæ˜“-é»å¤æŒ‡å¢åäº”å·Cç±»ä»½é¢', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'é‡åŒ–é€‰è‚¡', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆé‡åŒ–é€‰è‚¡ï¼‰', code: 'P50121', name: 'å¹³æ–¹å’Œé‡åŒ–ç²¾é€‰1å·ç§å‹ŸåŸºé‡‘Bç±»ä»½é¢', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'é‡åŒ–é€‰è‚¡', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆé‡åŒ–é€‰è‚¡ï¼‰', code: 'CQYX1B', name: 'è¯šå¥‡å…´æ³°è‚¡ç¥¨ä¼˜é€‰è¿ä½œ1å·ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘bç±»ä»½é¢', minInvest: 100 },

                // CTAç­–ç•¥
                { assetClass: 'å¹³è¡¡ç±»', strategyType: 'CTA', strategyName: 'å¹³è¡¡ç±»èµ„äº§ï¼ˆCTAï¼‰', code: 'P48455', name: 'æ´›ä¹¦ç®¡ç†æœŸè´§æ‹¾å·Aç±»ä»½é¢', minInvest: 100 },
                { assetClass: 'å¹³è¡¡ç±»', strategyType: 'CTA', strategyName: 'å¹³è¡¡ç±»èµ„äº§ï¼ˆCTAï¼‰', code: 'ATR91B', name: 'æ¶µå¾·ç›ˆå†²é‡åŒ–CTAè‡»é€‰1å·ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘Bç±»ä»½é¢', minInvest: 100 },
                { assetClass: 'å¹³è¡¡ç±»', strategyType: 'CTA', strategyName: 'å¹³è¡¡ç±»èµ„äº§ï¼ˆCTAï¼‰', code: 'SEYF203', name: 'å…ƒç››ä¸­å›½å¤šå…ƒåŒ–ä¸€å·ç§å‹ŸåŸºé‡‘', minInvest: 100 },
                { assetClass: 'å¹³è¡¡ç±»', strategyType: 'CTA', strategyName: 'å¹³è¡¡ç±»èµ„äº§ï¼ˆCTAï¼‰', code: 'SY4405', name: 'è‹±ä»•æ›¼å®é‡1å·ç§å‹ŸåŸºé‡‘', minInvest: 500 },
                { assetClass: 'å¹³è¡¡ç±»', strategyType: 'CTA', strategyName: 'å¹³è¡¡ç±»èµ„äº§ï¼ˆCTAï¼‰', code: 'SZQ252', name: 'è‹±ä»•æ›¼æ˜“é‡1å·ç§å‹ŸåŸºé‡‘', minInvest: 500 },
                { assetClass: 'å¹³è¡¡ç±»', strategyType: 'CTA', strategyName: 'å¹³è¡¡ç±»èµ„äº§ï¼ˆCTAï¼‰', code: 'SJYF304', name: 'è’™çºè‡»äº«CTAä¸€æœŸAç±»ä»½é¢', minInvest: 100 },

                // å¦ç±»ç­–ç•¥
                { assetClass: 'å¹³è¡¡ç±»', strategyType: 'å¤šç­–ç•¥', strategyName: 'å¹³è¡¡ç±»èµ„äº§ï¼ˆå¤šç­–ç•¥ï¼‰', code: 'BBR43B', name: 'æ˜æ±¯å¤šç­–ç•¥å¯¹å†²3å·ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘Bç±»ä»½é¢', minInvest: 500 },
                { assetClass: 'å¹³è¡¡ç±»', strategyType: 'å¤šç­–ç•¥', strategyName: 'å¹³è¡¡ç±»èµ„äº§ï¼ˆå¤šç­–ç•¥ï¼‰', code: 'BKW56B', name: 'é»‘ç¿¼è¡¡ç›ˆç²¾é€‰å¤šç­–ç•¥6å·ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘Bç±»ä»½é¢', minInvest: 100 },
                { assetClass: 'å¹³è¡¡ç±»', strategyType: 'å¤šç­–ç•¥', strategyName: 'å¹³è¡¡ç±»èµ„äº§ï¼ˆå¤šç­–ç•¥ï¼‰', code: 'BKW62B', name: 'é»‘ç¿¼è¡¡ç›ˆç²¾é€‰å¤šç­–ç•¥9å·ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘Bç±»ä»½é¢', minInvest: 100 },

                // ä¸­æ€§ç­–ç•¥
                { assetClass: 'ç¨³å¥ç±»', strategyType: 'å¸‚åœºä¸­æ€§', strategyName: 'ç¨³å¥ç±»èµ„äº§ï¼ˆå¸‚åœºä¸­æ€§ï¼‰', code: 'BCQ68B', name: 'å¾®è§‚åšæ˜“-å¤ç‰åä¸‰å·ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘Cç±»ä»½é¢', minInvest: 100 },
                { assetClass: 'ç¨³å¥ç±»', strategyType: 'å¸‚åœºä¸­æ€§', strategyName: 'ç¨³å¥ç±»èµ„äº§ï¼ˆå¸‚åœºä¸­æ€§ï¼‰', code: 'NR623A', name: 'è¯šå¥‡ç¿ç›ˆå¯¹å†²ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘Aç±»ä»½é¢', minInvest: 100 },
                { assetClass: 'ç¨³å¥ç±»', strategyType: 'å¸‚åœºä¸­æ€§', strategyName: 'ç¨³å¥ç±»èµ„äº§ï¼ˆå¸‚åœºä¸­æ€§ï¼‰', code: 'SAHN62', name: 'ç£æ¾å¸‚åœºä¸­æ€§2å·ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘', minInvest: 500 },

                // æµ·å¤–ç­–ç•¥
                { assetClass: 'ç¨³å¥ç±»', strategyType: 'æµ·å¤–å€ºåˆ¸', strategyName: 'ç¨³å¥ç±»èµ„äº§ï¼ˆå€ºåˆ¸ï¼‰', code: 'ST5056', name: 'æ–°æ–¹ç¨‹ä»·å€¼æŠ•èµ„æµ·å¤–ç§å‹ŸåŸºé‡‘', minInvest: 100 },
                { assetClass: 'ç¨³å¥ç±»', strategyType: 'æµ·å¤–å€ºåˆ¸', strategyName: 'ç¨³å¥ç±»èµ„äº§ï¼ˆå€ºåˆ¸ï¼‰', code: 'SANJ74', name: 'å¯Œæ•¦èšå®æ·»åˆ©ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘ï¼ˆAä»½é¢ï¼‰', minInvest: 100 },
                { assetClass: 'ç¨³å¥ç±»', strategyType: 'æµ·å¤–å€ºåˆ¸', strategyName: 'ç¨³å¥ç±»èµ„äº§ï¼ˆå€ºåˆ¸ï¼‰', code: 'SAQV87', name: 'ç€šäºšæµ·å¤–æŠ•èµ„ç¾å›½æŠ•èµ„çº§ä¼˜è´¨å…¬å¸å€ºç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘', minInvest: 1000 },
                { assetClass: 'ç¨³å¥ç±»', strategyType: 'æµ·å¤–å€ºåˆ¸', strategyName: 'ç¨³å¥ç±»èµ„äº§ï¼ˆå€ºåˆ¸ï¼‰', code: 'SEV105', name: 'éœ¸è±å…¨çƒä¿¡ç”¨å€ºå€ºåˆ¸ç§å‹ŸåŸºé‡‘', minInvest: 100 },

                // å®è§‚ç­–ç•¥
                { assetClass: 'å¹³è¡¡ç±»', strategyType: 'å®è§‚å¯¹å†²', strategyName: 'å¹³è¡¡ç±»èµ„äº§ï¼ˆå®è§‚å¯¹å†²ï¼‰', code: 'JS870A', name: 'å‡¯ä¸°å®è§‚ç­–ç•¥2å·è¯åˆ¸æŠ•èµ„ç§å‹ŸåŸºé‡‘Aç±»ä»½é¢', minInvest: 100 },
                { assetClass: 'å¹³è¡¡ç±»', strategyType: 'å®è§‚å¯¹å†²', strategyName: 'å¹³è¡¡ç±»èµ„äº§ï¼ˆå®è§‚å¯¹å†²ï¼‰', code: 'AWYD29B', name: 'æ³“æ¹–ç§¯æé…ç½®äºŒå·Bç±»ä»½é¢', minInvest: 100 },

                // ========== Sheet2: è‡»é€‰30æ± 202601 ==========

                // è¿›å–ç±» - ç§å‹Ÿä¸»è§‚
                { assetClass: 'è¿›å–ç±»', strategyType: 'ç§å‹Ÿä¸»è§‚', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆä¸»è§‚è‚¡ç¥¨å¤šå¤´ï¼‰', code: 'AKP57B', name: 'ä¿¡ç’æŠ•èµ„-ä»·å€¼ç²¾è‹±M1ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘Bç±»ä»½é¢', minInvest: 1000 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'ç§å‹Ÿä¸»è§‚', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆä¸»è§‚è‚¡ç¥¨å¤šå¤´ï¼‰', code: 'AKP57C', name: 'ä¿¡ç’æŠ•èµ„-ä»·å€¼ç²¾è‹±M1ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘Cç±»ä»½é¢', minInvest: 1000 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'ç§å‹Ÿä¸»è§‚', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆä¸»è§‚è‚¡ç¥¨å¤šå¤´ï¼‰', code: 'J2021A', name: 'ä»æ¡¥é²²æ·¼3æœŸç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘Aç±»ä»½é¢', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'ç§å‹Ÿä¸»è§‚', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆä¸»è§‚è‚¡ç¥¨å¤šå¤´ï¼‰', code: 'P48485', name: 'å·¨æ‰å‡€å€¼çº¿16å·Aä»½é¢', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'ç§å‹Ÿä¸»è§‚', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆä¸»è§‚è‚¡ç¥¨å¤šå¤´ï¼‰', code: 'SCY292', name: 'å¤§ç¦¾æŠ•èµ„-æ˜é‡‘707å·ç§å‹ŸæŠ•èµ„åŸºé‡‘', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'ç§å‹Ÿä¸»è§‚', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆä¸»è§‚è‚¡ç¥¨å¤šå¤´ï¼‰', code: 'X5605B', name: 'ç¿ç’æŠ•èµ„-ç¿ä¿¡ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘Bç±»ä»½é¢', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'ç§å‹Ÿä¸»è§‚', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆä¸»è§‚è‚¡ç¥¨å¤šå¤´ï¼‰', code: 'QP333A', name: 'ç£æ³½æ‰¬å¸†é˜³å…‰3å·Aç±»ä»½é¢', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'ç§å‹Ÿä¸»è§‚', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆä¸»è§‚è‚¡ç¥¨å¤šå¤´ï¼‰', code: 'B5370B', name: 'æ¯•ç››ç‹®è¿œ2å·ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘Bç±»ä»½é¢', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'ç§å‹Ÿä¸»è§‚', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆä¸»è§‚è‚¡ç¥¨å¤šå¤´ï¼‰', code: 'TW897A', name: 'é™ç‘çµåŠ¨å¢é•¿Aç±»ä»½é¢', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'ç§å‹Ÿä¸»è§‚', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆä¸»è§‚è‚¡ç¥¨å¤šå¤´ï¼‰', code: 'P49168', name: 'å‹¤è¾°æ£®è£•2å·ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘Cç±»ä»½é¢', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'ç§å‹Ÿä¸»è§‚', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆä¸»è§‚è‚¡ç¥¨å¤šå¤´ï¼‰', code: 'T07830', name: 'ç€›èµåˆ›ç€›ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘Bç±»ä»½é¢', minInvest: 100 },

                // è¿›å–ç±» - é‡åŒ–æŒ‡å¢
                { assetClass: 'è¿›å–ç±»', strategyType: 'é‡åŒ–æŒ‡å¢', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆé‡åŒ–é€‰è‚¡ï¼‰', code: 'STE790', name: 'é¡½å²©ä¸­è¯500æŒ‡æ•°å¢å¼º3å·ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'é‡åŒ–æŒ‡å¢', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆé‡åŒ–é€‰è‚¡ï¼‰', code: 'XY8078', name: 'é»‘ç¿¼ä¸­è¯1000æŒ‡æ•°å¢å¼º9å·ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘Bç±»ä»½é¢', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'é‡åŒ–æŒ‡å¢', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆé‡åŒ–é€‰è‚¡ï¼‰', code: 'ABP15A', name: 'å€æ¼¾é‡åŒ–é€‰è‚¡ä¸€æœŸç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘Aç±»ä»½é¢', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'é‡åŒ–æŒ‡å¢', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆé‡åŒ–é€‰è‚¡ï¼‰', code: 'SNZ840', name: 'æ˜æ±¯ç¨³å¥å¢é•¿6æœŸç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'é‡åŒ–æŒ‡å¢', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆé‡åŒ–é€‰è‚¡ï¼‰', code: 'SNH005', name: 'ä¸–çºªå‰æ²¿æŒ‡æ•°å¢å¼º5å·ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'é‡åŒ–æŒ‡å¢', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆé‡åŒ–é€‰è‚¡ï¼‰', code: 'AAS43A', name: 'ç¨³åšä¸­è¯2000æŒ‡æ•°å¢å¼º1å·Aç±»ä»½é¢', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'é‡åŒ–æŒ‡å¢', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆé‡åŒ–é€‰è‚¡ï¼‰', code: 'ANJ04B', name: 'è¡å¤ç›ˆèšä¸­è¯å…¨æŒ‡æŒ‡å¢ä¸€å·ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘Bç±»ä»½é¢', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'é‡åŒ–æŒ‡å¢', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆé‡åŒ–é€‰è‚¡ï¼‰', code: 'SH455B', name: 'æ˜æ±¯è‚¡ç¥¨ç²¾é€‰13æœŸBç±»ä»½é¢', minInvest: 100 },
                { assetClass: 'è¿›å–ç±»', strategyType: 'é‡åŒ–æŒ‡å¢', strategyName: 'è¿›å–ç±»èµ„äº§ï¼ˆé‡åŒ–é€‰è‚¡ï¼‰', code: 'TH545A', name: 'å‡¡äºŒé‡åŒ–é€‰è‚¡3å·1æœŸAç±»ä»½é¢', minInvest: 100 },

                // å¹³è¡¡ç±» - CTA
                { assetClass: 'å¹³è¡¡ç±»', strategyType: 'CTA', strategyName: 'å¹³è¡¡ç±»èµ„äº§ï¼ˆCTAï¼‰', code: 'NR346C', name: 'å‡¯ä¸°å¾¡é£1å·åŸºæœ¬é¢é‡åŒ–CTAè¯åˆ¸æŠ•èµ„ç§å‹ŸåŸºé‡‘Cç±»ä»½é¢', minInvest: 100 },
                { assetClass: 'å¹³è¡¡ç±»', strategyType: 'CTA', strategyName: 'å¹³è¡¡ç±»èµ„äº§ï¼ˆCTAï¼‰', code: 'P49062', name: 'å‡æˆCTAç¨³å¥3å·ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘Aç±»ä»½é¢', minInvest: 100 },
                { assetClass: 'å¹³è¡¡ç±»', strategyType: 'CTA', strategyName: 'å¹³è¡¡ç±»èµ„äº§ï¼ˆCTAï¼‰', code: 'ZB342B', name: 'åŠé…CTAå‡è¡¡1å·Bç±»ä»½é¢', minInvest: 100 },

                // å¹³è¡¡ç±» - å®è§‚å¯¹å†²
                { assetClass: 'å¹³è¡¡ç±»', strategyType: 'å®è§‚å¯¹å†²', strategyName: 'å¹³è¡¡ç±»èµ„äº§ï¼ˆå®è§‚å¯¹å†²ï¼‰', code: 'ZB1148', name: 'æ³“æ¹–é«˜è…¾åšå–»å®è§‚ç­–ç•¥ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘Bç±»ä»½é¢', minInvest: 100 },

                // å¹³è¡¡ç±» - å¤šç­–ç•¥
                { assetClass: 'å¹³è¡¡ç±»', strategyType: 'å¤šç­–ç•¥', strategyName: 'å¹³è¡¡ç±»èµ„äº§ï¼ˆå¤šç­–ç•¥ï¼‰', code: 'BBR43B', name: 'æ˜æ±¯å¤šç­–ç•¥å¯¹å†²3å·ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘Bç±»ä»½é¢', minInvest: 500 },

                // ç¨³å¥ç±» - å¸‚åœºä¸­æ€§
                { assetClass: 'ç¨³å¥ç±»', strategyType: 'å¸‚åœºä¸­æ€§', strategyName: 'ç¨³å¥ç±»èµ„äº§ï¼ˆå¸‚åœºä¸­æ€§ï¼‰', code: 'BCQ68C', name: 'å¾®è§‚åšæ˜“-å¤ç‰åä¸‰å·ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘Cç±»ä»½é¢', minInvest: 100 },
                { assetClass: 'ç¨³å¥ç±»', strategyType: 'å¸‚åœºä¸­æ€§', strategyName: 'ç¨³å¥ç±»èµ„äº§ï¼ˆå¸‚åœºä¸­æ€§ï¼‰', code: 'SB9398', name: 'ç£æ¾å¸‚åœºä¸­æ€§1å·ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘', minInvest: 200 },

                // ç¨³å¥ç±» - å›ºå®šæ”¶ç›Šï¼ˆç§å‹Ÿå€ºï¼‰
                { assetClass: 'ç¨³å¥ç±»', strategyType: 'å›ºå®šæ”¶ç›Šï¼ˆç§å‹Ÿå€ºï¼‰', strategyName: 'ç¨³å¥ç±»èµ„äº§ï¼ˆå€ºåˆ¸ï¼‰', code: 'NG199B', name: 'ä¸‡æŸè¯ºé‡‘2å·Bä»½é¢', minInvest: 100 },
                { assetClass: 'ç¨³å¥ç±»', strategyType: 'å›ºå®šæ”¶ç›Šï¼ˆç§å‹Ÿå€ºï¼‰', strategyName: 'ç¨³å¥ç±»èµ„äº§ï¼ˆå€ºåˆ¸ï¼‰', code: 'SVL345', name: 'å®ˆæœ´é•¿ç›ˆ3å·ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘', minInvest: 100 },
                { assetClass: 'ç¨³å¥ç±»', strategyType: 'å›ºå®šæ”¶ç›Šï¼ˆç§å‹Ÿå€ºï¼‰', strategyName: 'ç¨³å¥ç±»èµ„äº§ï¼ˆå€ºåˆ¸ï¼‰', code: 'ND732B', name: 'åˆ©ä½å®è§‚å¯¹å†²ç¯çƒäºŒå·ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘ï¼ˆBç±»ä»½é¢ï¼‰', minInvest: 100 },
                { assetClass: 'ç¨³å¥ç±»', strategyType: 'å›ºå®šæ”¶ç›Šï¼ˆç§å‹Ÿå€ºï¼‰', strategyName: 'ç¨³å¥ç±»èµ„äº§ï¼ˆå€ºåˆ¸ï¼‰', code: 'SXX452', name: 'è¥¿éƒ¨è¯åˆ¸å®‰ç›ˆæ³“åˆ©6æœˆæœŸ2å·é›†åˆèµ„äº§ç®¡ç†è®¡åˆ’', minInvest: 30 },
                { assetClass: 'ç¨³å¥ç±»', strategyType: 'å›ºå®šæ”¶ç›Šï¼ˆç§å‹Ÿå€ºï¼‰', strategyName: 'ç¨³å¥ç±»èµ„äº§ï¼ˆå€ºåˆ¸ï¼‰', code: 'P49124', name: 'é“¶å¶è†ç‰æº¯æ´„ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘Bç±»ä»½é¢', minInvest: 100 }
            ];

            // å»é‡ï¼ˆæŒ‰äº§å“ä»£ç ï¼‰
            const seen = new Set();
            productPool = productPool.filter(product => {
                if (seen.has(product.code)) {
                    return false;
                }
                seen.add(product.code);
                return true;
            });
            
            console.log('=== äº§å“æ± åˆå§‹åŒ–å®Œæˆ ===');
            console.log('äº§å“æ± é•¿åº¦:', JSON.stringify(productPool.length));
            console.log('äº§å“æ± å‰5ä¸ªäº§å“:', JSON.stringify(productPool.slice(0, 5)));
            
            
        }

        // äº§å“åŒ¹é…å…¨å±€å˜é‡
        let productMatchResults = []; // å­˜å‚¨åŒ¹é…ç»“æœ
        let productMapping = {};      // å­˜å‚¨ä¼°å€¼è¡¨äº§å“åˆ°äº§å“æ± çš„æ˜ å°„å…³ç³»

        // æ™ºèƒ½äº§å“åç§°åŒ¹é…å‡½æ•°
        function matchProductByName(ä¼°å€¼è¡¨äº§å“åç§°, äº§å“æ± ) {
            // 1. æ ‡å‡†åŒ–åç§°ï¼šå»é™¤æ‰€æœ‰å¹²æ‰°ä¿¡æ¯
            function normalizeName(name) {
                return name
                    .replace(/[ABC]ç±»ä»½é¢/g, '')
                    .replace(/ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘|ç§å‹ŸåŸºé‡‘/g, '')
                    .replace(/\(|\)/g, '')
                    .replace(/\s+/g, '')
                    .replace(/-|_/g, '')
                    .trim();
            }

            // 2. æå–æ ¸å¿ƒç‰¹å¾è¯ï¼ˆç®¡ç†äºº + ç­–ç•¥ + åºå·ï¼‰
            function extractCoreFeatures(name) {
                const features = {
                    manager: '',
                    strategy: '',
                    index: '',
                    version: ''
                };

                // æå–ç®¡ç†äºº
                const managers = ['æ˜æ±¯', 'é»‘ç¿¼', 'ä¸–çºªå‰æ²¿', 'ä¿¡ç’', 'è¡å¤', 'ä»æ¡¥', 'å¤§ç¦¾', 'ç£æ³½',
                                'é™ç‘', 'å‹¤è¾°', 'ç€›èµ', 'å·¨æ‰', 'ç¿ç’', 'æ¯•ç››', 'ä¸¹ç¾¿', 'æœ›æ­£',
                                'åˆè¿œ', 'ç“´ä»', 'å€æ¼¾', 'å› è¯º', 'å¾®è§‚åšæ˜“', 'è¯šå¥‡', 'å¹³æ–¹å’Œ', 'å‡¡äºŒ',
                                'é¡½å²©', 'ç¨³åš', 'å‡¯ä¸°', 'æ¶µå¾·', 'å…ƒç››', 'è‹±ä»•æ›¼', 'è’™çº', 'æ³“æ¹–',
                                'æ´›ä¹¦', 'å‡æˆ', 'åŠé…', 'ç£æ¾', 'ä¸‡æŸ', 'å®ˆæœ´', 'åˆ©ä½', 'è¥¿éƒ¨è¯åˆ¸', 'é“¶å¶'];
                for (const manager of managers) {
                    if (name.includes(manager)) {
                        features.manager = manager;
                        break;
                    }
                }

                // æå–ç­–ç•¥å…³é”®è¯
                const strategies = ['ç¨³å¥å¢é•¿', 'æŒ‡æ•°å¢å¼º', 'é‡åŒ–', 'CTA', 'ä¸­æ€§', 'å¯¹å†²', 'æŒ‡å¢',
                                  'ä»·å€¼ç²¾è‹±', 'é²²æ·¼', 'æ˜é‡‘', 'åŒ ä¼ ', 'è‡´è¿œ', 'åˆ›ç€›', 'è´¢å¯Œ',
                                  'ç¿ä¿¡', 'ç¿æ¡', 'å‡€å€¼çº¿', 'æ‰¬å¸†', 'ç‹®è¿œ', 'çµåŠ¨', 'æ£®è£•',
                                  'é‡åŒ–é€‰è‚¡', 'ä¸­è¯A500', 'é‡åŒ–ä¼˜é€‰', 'è‚¡ç¥¨ç²¾é€‰', 'ä»·å€¼æˆé•¿',
                                  'é»å¤', 'é‡åŒ–ç²¾é€‰', 'å…´æ³°è‚¡ç¥¨', 'å¾¡é£', 'ç›ˆå†²', 'å¤šå…ƒåŒ–',
                                  'å®é‡', 'æ˜“é‡', 'è‡»äº«', 'è¡¡ç›ˆ', 'å¤ç‰', 'ç¿ç›ˆ', 'è¯ºé‡‘',
                                  'é•¿ç›ˆ', 'å®è§‚å¯¹å†²', 'å®‰ç›ˆæ³“åˆ©', 'è†ç‰æº¯æ´„'];
                for (const strategy of strategies) {
                    if (name.includes(strategy)) {
                        features.strategy = strategy;
                        break;
                    }
                }

                // æå–æŒ‡æ•°
                const indices = ['300', '500', '1000', '2000', 'A500', 'å…¨æŒ‡'];
                for (const index of indices) {
                    if (name.includes(index)) {
                        features.index = index;
                        break;
                    }
                }

                // æå–åºå·
                const numberMatch = name.match(/(\d+)(æœŸ|å·)/);
                if (numberMatch) {
                    features.number = numberMatch[1];
                }

                // æå–ç‰ˆæœ¬
                const versionMatch = name.match(/V(\d+)/);
                if (versionMatch) {
                    features.version = versionMatch[1];
                }

                return features;
            }

            // 3. å¤šå±‚çº§åŒ¹é…ç­–ç•¥
            const normalizedName = normalizeName(ä¼°å€¼è¡¨äº§å“åç§°);
            const features = extractCoreFeatures(ä¼°å€¼è¡¨äº§å“åç§°);

            // ç¬¬ä¸€ä¼˜å…ˆçº§ï¼šæ ‡å‡†åŒ–åç§°å®Œå…¨åŒ¹é…
            let exactMatch = null;
            for (const poolProduct of äº§å“æ± ) {
                const poolNormalizedName = normalizeName(poolProduct.name);
                if (poolNormalizedName === normalizedName) {
                    return { product: poolProduct, confidence: 100, method: 'exact_match' };
                }
            }

            // ç¬¬äºŒä¼˜å…ˆçº§ï¼šç®¡ç†äºº+ç­–ç•¥+åºå·å®Œå…¨åŒ¹é…
            for (const poolProduct of äº§å“æ± ) {
                const poolFeatures = extractCoreFeatures(poolProduct.name);
                if (features.manager === poolFeatures.manager &&
                    features.strategy === poolFeatures.strategy &&
                    features.number === poolFeatures.number) {
                    return { product: poolProduct, confidence: 95, method: 'feature_match' };
                }
            }

            // ç¬¬ä¸‰ä¼˜å…ˆçº§ï¼šç®¡ç†äºº+ç­–ç•¥åŒ¹é…ï¼ˆå¿½ç•¥åºå·ï¼‰
            for (const poolProduct of äº§å“æ± ) {
                const poolFeatures = extractCoreFeatures(poolProduct.name);
                if (features.manager === poolFeatures.manager &&
                    features.strategy === poolFeatures.strategy &&
                    features.manager && features.strategy) {
                    return { product: poolProduct, confidence: 85, mechanism: 'manager_strategy_match' };
                }
            }

            // ç¬¬å››ä¼˜å…ˆçº§ï¼šç®¡ç†äºº+åºå·åŒ¹é…
            for (const poolProduct of äº§å“æ± ) {
                const poolFeatures = extractCoreFeatures(poolProduct.name);
                if (features.manager === poolFeatures.manager &&
                    features.number === poolFeatures.number &&
                    features.manager && features.number) {
                    return { product: poolProduct, confidence: 75, method: 'manager_number_match' };
                }
            }

            // ç¬¬äº”ä¼˜å…ˆçº§ï¼šç®¡ç†äººåŒ¹é…ï¼ˆå”¯ä¸€ç®¡ç†äººï¼‰
            const managerProducts = äº§å“æ± .filter(p => extractCoreFeatures(p.name).manager === features.manager);
            if (managerProducts.length === 1 && features.manager) {
                return { product: managerProducts[0], confidence: 60, method: 'unique_manager' };
            }

            return null;
        }

        // æ˜¾ç¤ºäº§å“åŒ¹é…æ¨¡æ€æ¡†
        function showProductMatchModal(investFunds, preserveMatches = false) {
            if (!investFunds || investFunds.length === 0) {
                return;
            }

            try {
                // å¦‚æœä¸éœ€è¦ä¿ç•™ä¹‹å‰çš„åŒ¹é…ç»“æœï¼Œåˆ™æ¸…ç©º
                if (!preserveMatches) {
                    productMatchResults = [];
                    productMapping = {};
                }

                // ä¸ºæ¯ä¸ªå·²æŠ•åŸºé‡‘è¿›è¡ŒåŒ¹é…
                investFunds.forEach(fund => {
                    let productName = fund['äº§å“åç§°ï¼ˆå«ä»½é¢ç±»åˆ«ï¼‰'] || '';
                    let originalProductName = productName;

                    // å¦‚æœåç§°åŒ…å«" â˜…"æ ‡è®°ï¼Œè¯´æ˜å·²ç»è¢«åŒ¹é…è¿‡ï¼Œå°è¯•è·å–åŸå§‹åç§°
                    if (productName.includes(' â˜…')) {
                        originalProductName = fund['åŸå§‹äº§å“åç§°'] || productName.replace(' â˜…', '');
                    }

                    // å¦‚æœä¿ç•™åŒ¹é…ç»“æœä¸”è¯¥äº§å“å·²æœ‰åŒ¹é…ç»“æœï¼Œåˆ™ä¿ç•™ï¼ˆä½¿ç”¨åŸå§‹åç§°æŸ¥æ‰¾ï¼‰
                    if (preserveMatches && productMapping[originalProductName]) {
                        const existingMatch = productMapping[originalProductName];
                        productMatchResults.push({
                            valuationProductName: productName,
                            originalProductName: originalProductName,
                            matchResult: existingMatch.matched ? { product: existingMatch, confidence: 100, method: 'manual' } : null,
                            selectedProductCode: existingMatch.code || '',
                            confidence: existingMatch.matched ? 100 : 0,
                            matchMethod: existingMatch.matched ? 'manual' : 'no_match'
                        });
                        return;
                    }

                    // å¦åˆ™è¿›è¡Œæ–°çš„åŒ¹é…ï¼ˆä½¿ç”¨åŸå§‹åç§°ï¼‰
                    const matchResult = matchProductByName(originalProductName, productPool);
                    productMatchResults.push({
                        valuationProductName: productName,
                        originalProductName: originalProductName,
                        matchResult: matchResult,
                        selectedProductCode: matchResult ? matchResult.product.code : '',
                        confidence: matchResult ? matchResult.confidence : 0,
                        matchMethod: matchResult ? matchResult.method : 'no_match'
                    });

                    // ä¿å­˜æ˜ å°„å…³ç³»ï¼ˆä½¿ç”¨åŸå§‹åç§°ä½œä¸ºkeyï¼‰ï¼Œåªæœ‰ç½®ä¿¡åº¦â‰¥70%æ‰è‡ªåŠ¨åŒ¹é…
                    if (matchResult && matchResult.confidence >= 70) {
                        productMapping[originalProductName] = {
                            name: matchResult.product.name,
                            code: matchResult.product.code,
                            assetClass: matchResult.product.assetClass || '',
                            strategyType: matchResult.product.strategyType || '',
                            strategyName: matchResult.product.strategyName || '',
                            minInvest: matchResult.product.minInvest || 0,
                            matched: true
                        };
                    } else {
                        productMapping[originalProductName] = { 
                            name: originalProductName, 
                            code: '', 
                            assetClass: '',
                            strategyType: '',
                            strategyName: '',
                            matched: false 
                        };
                    }
                });

                // ç”Ÿæˆæ¨¡æ€æ¡†å†…å®¹
                const modalContent = document.getElementById('productMatchModalContent');
                if (!modalContent) {
                    return;
                }

                // æŒ‰ç½®ä¿¡åº¦ä»ä½åˆ°é«˜æ’åº
                productMatchResults.sort((a, b) => a.confidence - b.confidence);

                // ç»Ÿè®¡åŒ¹é…æƒ…å†µ
                const matchedCount = productMatchResults.filter(r => r.confidence >= 85).length;
                const totalCount = productMatchResults.length;
                const unmatchedCount = totalCount - matchedCount;

                let html = `
                    <div class="match-summary">
                        <p>å·²æ£€æµ‹åˆ° <strong>${totalCount}</strong> ä¸ªå·²æŠ•åŸºé‡‘</p>
                        <p>âœ… é«˜ç½®ä¿¡åº¦åŒ¹é…ï¼ˆâ‰¥85%ï¼‰ï¼š${matchedCount} ä¸ª</p>
                        <p>âš ï¸ éœ€è¦ç¡®è®¤æˆ–æ‰‹åŠ¨åŒ¹é…ï¼š${unmatchedCount} ä¸ª</p>
                    </div>
                    <div id="matchTableScrollContainer" class="match-table-scroll-container">
                        <table class="match-table">
                            <thead>
                                <tr>
                                    <th>ä¼°å€¼è¡¨äº§å“åç§°</th>
                                    <th>åŒ¹é…åˆ°çš„äº§å“æ± äº§å“</th>
                                    <th>ç½®ä¿¡åº¦</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                productMatchResults.forEach((item, index) => {
                    const matchInfo = item.matchResult;
                    const poolProduct = matchInfo ? matchInfo.product : null;
                    const confidence = item.confidence;

                    let confidenceColor = '#e53e3e';
                    let confidenceText = 'æœªåŒ¹é…';
                    if (confidence >= 100) {
                        confidenceColor = '#38a169';
                        confidenceText = '100%';
                    } else if (confidence >= 95) {
                        confidenceColor = '#48bb78';
                        confidenceText = '95%';
                    } else if (confidence >= 85) {
                        confidenceColor = '#ecc94b';
                        confidenceText = '85%';
                    } else if (confidence >= 75) {
                        confidenceColor = '#ed8936';
                        confidenceText = '75%';
                    } else if (confidence >= 60) {
                        confidenceColor = '#ed8936';
                        confidenceText = '60%';
                    }

                    html += `
                        <tr data-index="${index}" data-confidence="${confidence}">
                            <td>${item.valuationProductName}</td>
                            <td>
                                ${poolProduct ? `<span class="matched-product">${poolProduct.name}</span>` : '<span class="unmatched-product">æœªæ‰¾åˆ°åŒ¹é…</span>'}
                            </td>
                            <td class="confidence-${confidence >= 85 ? 'high' : confidence >= 60 ? 'medium' : 'low'}">
                                ${confidenceText}
                            </td>
                            <td>
                                <button class="btn btn-xs btn-info" onclick="openProductSelector(${index})">é€‰æ‹©äº§å“</button>
                            </td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-danger" onclick="closeProductMatchModal()">å–æ¶ˆ</button>
                        <button class="btn btn-primary" onclick="confirmProductMatch()">ç¡®è®¤åŒ¹é…</button>
                    </div>
                `;

                modalContent.innerHTML = html;

                const modal = document.getElementById('productMatchModal');
                if (modal) {
                    modal.style.display = 'block';
                    modal.style.opacity = '1';
                    modal.style.visibility = 'visible';
                    modal.style.animation = 'none';
                    // ç¦æ­¢bodyæ»šåŠ¨
                    document.body.classList.add('modal-open');
                }
            } catch (error) {
                showAlert('äº§å“åŒ¹é…åŠŸèƒ½å‡ºé”™ï¼š' + error.message, 'error');
            }
        }

        // æ›´æ–°äº§å“åŒ¹é…ï¼ˆå·²åºŸå¼ƒï¼Œç”± selectProduct å‡½æ•°æ›¿ä»£ï¼‰
        function updateProductMatch(index, selectedCode) {
            // æ­¤å‡½æ•°å·²åºŸå¼ƒï¼Œç°åœ¨ä½¿ç”¨ selectProduct å‡½æ•°
            // ä¿ç•™æ­¤å‡½æ•°ä»¥é¿å…å¯èƒ½çš„å¼•ç”¨é”™è¯¯
            selectProduct(index, selectedCode);
        }

        // ç¡®è®¤äº§å“åŒ¹é…
        function confirmProductMatch() {
            // å…³é—­æ¨¡æ€æ¡†
            closeProductMatchModal();

            // åŒæ­¥æ›´æ–°æŒä»“æ•°æ®ä¸­çš„äº§å“åç§°ä¸ºäº§å“æ± åç§°
            if (processedData && processedData['å·²æŠ•åŸºé‡‘éƒ¨åˆ†']) {
                processedData['å·²æŠ•åŸºé‡‘éƒ¨åˆ†'].forEach((item, idx) => {
                    // ä¼˜å…ˆä½¿ç”¨åŸå§‹äº§å“åç§°æŸ¥æ‰¾æ˜ å°„
                    let lookupName = item['äº§å“åç§°ï¼ˆå«ä»½é¢ç±»åˆ«ï¼‰'];
                    if (item['åŸå§‹äº§å“åç§°']) {
                        lookupName = item['åŸå§‹äº§å“åç§°'];
                    } else if (lookupName.includes(' â˜…')) {
                        lookupName = lookupName.replace(' â˜…', '');
                    }

                    const mappedProduct = productMapping[lookupName];

                    if (mappedProduct && mappedProduct.matched) {
                        // ä¿å­˜åŸå§‹åç§°ï¼ˆå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡åŒ¹é…ï¼‰
                        if (!item['åŸå§‹äº§å“åç§°']) {
                            item['åŸå§‹äº§å“åç§°'] = lookupName;
                        }
                        // æ›´æ–°ä¸ºäº§å“æ± çš„äº§å“åç§°ï¼ˆå¸¦æ ‡æ³¨ï¼‰
                        item['äº§å“åç§°ï¼ˆå«ä»½é¢ç±»åˆ«ï¼‰'] = mappedProduct.name + ' â˜…';
                        item['äº§å“ä»£ç '] = mappedProduct.code;
                        item['å·²åŒ¹é…'] = true;

                        // åŒæ­¥æ›´æ–°ç­–ç•¥ç±»å‹å­—æ®µï¼ˆç¡®ä¿æ‰€æœ‰å­—æ®µéƒ½è¢«æ­£ç¡®è®¾ç½®ï¼‰
                        item['èµ„äº§ç±»åˆ«'] = mappedProduct.assetClass || '';
                        item['ç­–ç•¥ç±»å‹'] = mappedProduct.strategyType || '';
                        item['äº§å“ç­–ç•¥'] = mappedProduct.strategyName || '';
                        
                        console.log(`å·²æ›´æ–°äº§å“åŒ¹é… - åŸå§‹åç§°: ${lookupName}, æ–°åç§°: ${mappedProduct.name}, èµ„äº§ç±»åˆ«: ${mappedProduct.assetClass}, ç­–ç•¥ç±»å‹: ${mappedProduct.strategyType}, äº§å“ç­–ç•¥: ${mappedProduct.strategyName}`);
                    } else {
                        // å¦‚æœæœªåŒ¹é…ï¼Œç¡®ä¿ç­–ç•¥ç±»å‹å­—æ®µä¸ºç©ºå­—ç¬¦ä¸²
                        item['èµ„äº§ç±»åˆ«'] = '';
                        item['ç­–ç•¥ç±»å‹'] = '';
                        item['äº§å“ç­–ç•¥'] = '';
                    }
                });
            }

            // åŒæ­¥æ›´æ–°holdingsæ•°ç»„ä¸­çš„äº§å“åç§°
            holdings.forEach((holding, idx) => {
                if (holding.category === 'å·²æŠ•åŸºé‡‘') {
                    // ä¼˜å…ˆä½¿ç”¨åŸå§‹åç§°æŸ¥æ‰¾æ˜ å°„
                    let lookupName = holding.name;
                    if (holding.originalName) {
                        lookupName = holding.originalName;
                    } else if (lookupName.includes(' â˜…')) {
                        lookupName = lookupName.replace(' â˜…', '');
                    }

                    const mappedProduct = productMapping[lookupName];
                    if (mappedProduct && mappedProduct.matched) {
                        // ä¿å­˜åŸå§‹åç§°
                        if (!holding.originalName) {
                            holding.originalName = lookupName;
                        }
                        // æ›´æ–°ä¸ºäº§å“æ± çš„äº§å“åç§°ï¼ˆå¸¦æ ‡æ³¨ï¼‰
                        holding.name = mappedProduct.name + ' â˜…';
                        holding.productCode = mappedProduct.code;
                        holding.matched = true;

                        // åŒæ­¥æ›´æ–°ç­–ç•¥ç±»å‹å­—æ®µï¼ˆç¡®ä¿æ‰€æœ‰å­—æ®µéƒ½è¢«æ­£ç¡®è®¾ç½®ï¼‰
                        holding.assetClass = mappedProduct.assetClass || '';
                        holding.strategyType = mappedProduct.strategyType || '';
                        holding.strategyName = mappedProduct.strategyName || '';
                    } else {
                        // å¦‚æœæœªåŒ¹é…ï¼Œç¡®ä¿ç­–ç•¥ç±»å‹å­—æ®µä¸ºç©ºå­—ç¬¦ä¸²
                        holding.assetClass = '';
                        holding.strategyType = '';
                        holding.strategyName = '';
                    }
                }
            });

            // åŒæ­¥æ›´æ–°å–å‡ºåˆ—è¡¨ä¸­çš„äº§å“åç§°
            sellOrders.forEach((order, idx) => {
                // ä¼˜å…ˆä½¿ç”¨åŸå§‹åç§°æŸ¥æ‰¾æ˜ å°„
                let lookupName = order.productName;
                if (order.originalProductName) {
                    lookupName = order.originalProductName;
                } else if (lookupName.includes(' â˜…')) {
                    lookupName = lookupName.replace(' â˜…', '');
                }

                const mappedProduct = productMapping[lookupName];
                if (mappedProduct && mappedProduct.matched) {
                    // ä¿å­˜åŸå§‹åç§°
                    if (!order.originalProductName) {
                        order.originalProductName = lookupName;
                    }
                    // æ›´æ–°ä¸ºäº§å“æ± çš„äº§å“åç§°ï¼ˆå¸¦æ ‡æ³¨ï¼‰
                    order.productName = mappedProduct.name + ' â˜…';
                    order.productCode = mappedProduct.code;
                    order.matched = true;
                }
            });

            // åˆ·æ–°æ‰€æœ‰ç›¸å…³ç•Œé¢
            updateInvestFundTable(processedData['å·²æŠ•åŸºé‡‘éƒ¨åˆ†']);
            updateHoldingTable();
            updateSellTable();
            updateSellProducts();

            showAlert('âœ… äº§å“åŒ¹é…å·²ç¡®è®¤ï¼å·²åŒæ­¥æ›´æ–°æ‰€æœ‰ç•Œé¢çš„äº§å“åç§°', 'success');
            // æ˜¾ç¤º"ä¿®æ”¹äº§å“åŒ¹é…"æŒ‰é’®
            document.getElementById('reMatchBtn').style.display = 'inline-block';
        }

        // é‡æ–°æ‰“å¼€äº§å“åŒ¹é…æ¨¡æ€æ¡†
        function reopenProductMatchModal() {
            if (!processedData || !processedData['å·²æŠ•åŸºé‡‘éƒ¨åˆ†']) {
                showAlert('è¯·å…ˆå¯¼å…¥ä¼°å€¼è¡¨æ•°æ®', 'error');
                return;
            }
            // ä¼ é€’ true å‚æ•°ï¼Œä¿ç•™ä¹‹å‰çš„åŒ¹é…ç»“æœ
            showProductMatchModal(processedData['å·²æŠ•åŸºé‡‘éƒ¨åˆ†'], true);
        }

        // å…³é—­äº§å“åŒ¹é…æ¨¡æ€æ¡†
        function closeProductMatchModal() {
            const modal = document.getElementById('productMatchModal');
            if (modal) {
                modal.style.display = 'none';
                // æ¢å¤bodyæ»šåŠ¨
                document.body.classList.remove('modal-open');
            }
        }

        // æŒ‰ç­–ç•¥ç±»å‹åˆ†ç»„äº§å“æ± 
        function groupProductPoolByStrategy() {
            const grouped = {};
            productPool.forEach(product => {
                const strategy = product.strategyName || 'æœªåˆ†ç±»';
                if (!grouped[strategy]) {
                    grouped[strategy] = [];
                }
                grouped[strategy].push(product);
            });
            return grouped;
        }

        // æ‰“å¼€äº§å“é€‰æ‹©å™¨ï¼ˆå¸¦æœç´¢å’Œåˆ†ç»„ï¼‰
        function openProductSelector(index) {
            const item = productMatchResults[index];
            const currentSelection = item.selectedProductCode;
            const groupedPool = groupProductPoolByStrategy();

            const selectorPanel = document.getElementById('productSelectorPanel');
            const modalContent = document.querySelector('#productMatchModal .modal-content');
            const mainContent = document.getElementById('productMatchModalContent');

            // æ–¹æ³•2ï¼šè®¿é—®å‰ä½œåˆ¤æ–­
            if (!modalContent) {
                console.error('Modal content not found!');
                return;
            }
            if (!mainContent) {
                console.error('Main content not found!');
                return;
            }

            let createdPanel = null;
            
            if (!selectorPanel) {
                // ç¬¬ä¸€æ¬¡ç‚¹å‡»ï¼šåˆ›å»ºå³ä¾§é¢æ¿
                const panelDiv = document.createElement('div');
                panelDiv.id = 'productSelectorPanel';
                panelDiv.className = 'selector-panel';
                
                // åˆ›å»ºå¤´éƒ¨ï¼ˆä¸å·¦ä¾§è¡¨å¤´å¯¹é½ï¼‰
                const headerDiv = document.createElement('div');
                headerDiv.className = 'selector-header';
                headerDiv.innerHTML = `
                    <h3>äº§å“æ± äº§å“</h3>
                    <button class="selector-close" onclick="closeProductSelectorPanel()">&times;</button>
                `;
                
                // åˆ›å»ºä¸»ä½“ï¼ˆåŒ…å«å›ºå®šé¡¶éƒ¨å’Œå¯æ»šåŠ¨åˆ—è¡¨ï¼‰
                const bodyDiv = document.createElement('div');
                bodyDiv.className = 'selector-body';
                bodyDiv.innerHTML = `
                    <div class="selector-fixed-top">
                        <div class="search-container">
                            <input type="text" id="product-search-panel" placeholder="æœç´¢äº§å“åç§°æˆ–ä»£ç ..." oninput="filterProductOptionsPanel()">
                            <span class="search-icon">ğŸ”</span>
                        </div>
                        <div class="option-hint" id="product-options-hint">
                            ğŸ’¡ <strong>æç¤ºï¼š</strong>å¦‚éœ€ä¿ç•™ä¼°å€¼è¡¨åŸå§‹åç§°æˆ–å–æ¶ˆåŒ¹é…ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹çš„"-- ä¿ç•™ä¼°å€¼è¡¨åŸå§‹åç§° --"é€‰é¡¹
                        </div>
                    </div>
                    <div id="product-options-panel" class="product-options"></div>
                `;
                
                // åˆ›å»ºåº•éƒ¨
                const footerDiv = document.createElement('div');
                footerDiv.className = 'selector-footer';
                footerDiv.innerHTML = `
                    <button class="btn btn-danger" onclick="closeProductSelectorPanel()">å–æ¶ˆ</button>
                    <button class="btn btn-primary" onclick="confirmProductSelectionPanel()">ç¡®è®¤</button>
                `;
                
                panelDiv.appendChild(headerDiv);
                panelDiv.appendChild(bodyDiv);
                panelDiv.appendChild(footerDiv);
                modalContent.appendChild(panelDiv);
                
                // ä¿å­˜å¼•ç”¨ï¼Œé¿å…å†æ¬¡æŸ¥è¯¢DOM
                createdPanel = panelDiv;
            }

            // æ–¹æ³•1ï¼šä½¿ç”¨åˆ›å»ºçš„å¼•ç”¨è€Œä¸æ˜¯é‡æ–°æŸ¥è¯¢
            const panelToUse = createdPanel || selectorPanel;
            
            // æ–¹æ³•2ï¼šå†æ¬¡æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
            if (!panelToUse) {
                console.error('Selector panel not found after creation!');
                return;
            }

            // æ¯æ¬¡æ‰“å¼€éƒ½é‡æ–°ç”Ÿæˆäº§å“é€‰é¡¹å†…å®¹
            updateProductOptionsPanel(currentSelection, groupedPool);

            // åœ¨å›ºå®šé¡¶éƒ¨åŒºåŸŸæ·»åŠ "ä¿ç•™ä¼°å€¼è¡¨åŸå§‹åç§°"é€‰é¡¹
            const fixedTopContainer = document.querySelector('.selector-fixed-top');
            if (fixedTopContainer && !document.getElementById('retain-original-name-option')) {
                const retainOption = document.createElement('div');
                retainOption.id = 'retain-original-name-option';
                retainOption.className = `option-item ${currentSelection === '' ? 'selected' : 'unmatched'}`;
                retainOption.style.marginTop = '8px';
                retainOption.style.padding = '10px 12px';
                retainOption.style.cursor = 'pointer';
                retainOption.style.borderRadius = '6px';
                retainOption.style.border = '1px solid transparent';
                retainOption.style.transition = 'background-color 0.2s';
                retainOption.onclick = function() {
                    selectProductOptionPanel('', '');
                    // æ›´æ–°é€‰ä¸­çŠ¶æ€
                    const allOptions = fixedTopContainer.querySelectorAll('.option-item');
                    allOptions.forEach(opt => opt.classList.remove('selected'));
                    retainOption.classList.add('selected');
                };
                
                if (currentSelection === '') {
                    retainOption.innerHTML = `<span class="option-left-border"></span><div class="option-name" style="color: #1890ff; font-weight: 500;">ğŸ“‹ -- ä¿ç•™ä¼°å€¼è¡¨åŸå§‹åç§° --</div><div class="option-hint-text" style="font-size: 11px; color: #999; margin-top: 4px;">ç‚¹å‡»æ­¤é¡¹å–æ¶ˆåŒ¹é…ï¼Œä½¿ç”¨ä¼°å€¼è¡¨åŸå§‹åç§°</div>`;
                } else {
                    retainOption.innerHTML = `<div class="option-name" style="color: #595959; font-weight: 500;">ğŸ“‹ -- ä¿ç•™ä¼°å€¼è¡¨åŸå§‹åç§° --</div><div class="option-hint-text" style="font-size: 11px; color: #999; margin-top: 4px;">ç‚¹å‡»æ­¤é¡¹å–æ¶ˆåŒ¹é…ï¼Œä½¿ç”¨ä¼°å€¼è¡¨åŸå§‹åç§°</div>`;
                }
                
                fixedTopContainer.appendChild(retainOption);
            }

            // è®¾ç½®é¢æ¿ä¸ºå¯è§
            panelToUse.style.display = 'flex';
            panelToUse.style.animation = 'slideInRight 0.3s ease';

            // æ”¶ç¼©å·¦ä¾§å†…å®¹åŒºåŸŸï¼Œä¸ºå³ä¾§é¢æ¿è…¾å‡ºç©ºé—´
            mainContent.classList.add('has-sidebar');

            const searchInput = document.getElementById('product-search-panel');
            if (searchInput) {
                searchInput.value = '';
            }

            window.currentMatchingIndex = index;
            window.tempGroupedPool = groupedPool;
            window.tempProductSelection = currentSelection;

            highlightCurrentRow(index);
        }

        // é«˜äº®å½“å‰æ­£åœ¨åŒ¹é…çš„è¡Œ
        function highlightCurrentRow(index) {
            // ç§»é™¤æ‰€æœ‰é«˜äº®
            const rows = document.querySelectorAll('#matchTableScrollContainer tbody tr');
            rows.forEach(row => {
                row.style.background = '';
            });

            // é«˜äº®å½“å‰è¡Œ
            if (rows[index]) {
                rows[index].style.background = '#ebf8ff';
                rows[index].scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // ç”Ÿæˆäº§å“é€‰é¡¹é¢æ¿HTML
        function generateProductOptionsPanelHTML(currentSelection, groupedPool) {
            let html = '';

            // æŒ‰ç­–ç•¥ç±»å‹åˆ†ç»„æ˜¾ç¤ºäº§å“æ± ï¼ˆç§»é™¤"æœªé€‰æ‹©äº§å“"åˆ†ç»„ï¼Œå› ä¸ºå·²ç»æ”¾åˆ°å›ºå®šé¡¶éƒ¨åŒºåŸŸï¼‰
            Object.keys(groupedPool).forEach(strategy => {
                const products = groupedPool[strategy];
                const groupId = `panel-group-${strategy.replace(/\s/g, '')}`;
                html += `<div class="option-group">`;
                html += `<div class="option-group-header" onclick="toggleGroupPanel('${groupId}', this)">`;
                html += `<span>â–¼</span> ${strategy} (${products.length}ä¸ª)`;
                html += `</div>`;
                html += `<div id="${groupId}" class="option-group-body">`;
                products.forEach(product => {
                    const isSelected = currentSelection === product.code;
                    html += `<div class="option-item ${isSelected ? 'selected' : ''}" onclick="selectProductOptionPanel('${product.code}', '${product.name.replace(/'/g, "\\'")}')">`;
                    if (isSelected) {
                        html += `<span class="option-left-border"></span>`;
                    }
                    html += `<div class="option-name">${product.name}</div>`;
                    html += `<div class="option-code">ä»£ç ï¼š${product.code}</div>`;
                    html += `</div>`;
                });
                html += `</div>`;
                html += `</div>`;
            });

            return html;
        }

        // æ›´æ–°äº§å“é€‰é¡¹é¢æ¿
        function updateProductOptionsPanel(currentSelection, groupedPool) {
            const optionsContainer = document.getElementById('product-options-panel');
            if (optionsContainer) {
                optionsContainer.innerHTML = generateProductOptionsPanelHTML(currentSelection, groupedPool);
                
                // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (optionsContainer._clickHandler) {
                    optionsContainer.removeEventListener('click', optionsContainer._clickHandler);
                }
                
                // HTMLä¸­å·²ç»æœ‰onclickå±æ€§ï¼Œä¸éœ€è¦é¢å¤–çš„äº‹ä»¶å§”æ‰˜
                // ä¿ç•™ç©ºå‡½æ•°ä»¥é¿å…é”™è¯¯
                optionsContainer._clickHandler = function(e) {};
                
                optionsContainer.addEventListener('click', optionsContainer._clickHandler);
            }
        }

        // åˆ‡æ¢åˆ†ç»„å±•å¼€/æŠ˜å ï¼ˆé¢æ¿ç‰ˆï¼‰
        function toggleGroupPanel(groupId, element) {
            console.log('toggleGroupPanel called:', groupId, element);
            const group = document.getElementById(groupId);
            console.log('Group element found:', group);
            if (group) {
                // è·å–å½“å‰displayçŠ¶æ€ï¼Œå¦‚æœä¸ºç©ºåˆ™é»˜è®¤ä¸ºblockï¼ˆå±•å¼€çŠ¶æ€ï¼‰
                const currentDisplay = group.style.display || 'block';
                const isHidden = currentDisplay === 'none';
                console.log('Current display:', currentDisplay, 'Is hidden:', isHidden);
                
                if (isHidden) {
                    // ä»æŠ˜å çŠ¶æ€åˆ‡æ¢åˆ°å±•å¼€çŠ¶æ€
                    group.style.display = 'block';
                    // æ‰¾åˆ°spanæ ‡ç­¾ä¸­çš„ç®­å¤´å›¾æ ‡å¹¶æ›´æ–°
                    const arrowSpan = element.querySelector('span');
                    if (arrowSpan) {
                        arrowSpan.textContent = 'â–¼';
                        console.log('Arrow changed to â–¼');
                    }
                } else {
                    // ä»å±•å¼€çŠ¶æ€åˆ‡æ¢åˆ°æŠ˜å çŠ¶æ€
                    group.style.display = 'none';
                    // æ‰¾åˆ°spanæ ‡ç­¾ä¸­çš„ç®­å¤´å›¾æ ‡å¹¶æ›´æ–°
                    const arrowSpan = element.querySelector('span');
                    if (arrowSpan) {
                        arrowSpan.textContent = 'â–¶';
                        console.log('Arrow changed to â–¶');
                    }
                }
                console.log('New display:', group.style.display);
            } else {
                console.error('Group not found with id:', groupId);
            }
        }

        // é€‰æ‹©äº§å“é€‰é¡¹ï¼ˆé¢æ¿ç‰ˆï¼‰- å®æ—¶æ›´æ–°ä¸»è¡¨æ ¼
        function selectProductOptionPanel(productCode, productName) {
            // å…ˆæ£€æŸ¥é‡å¤åŒ¹é…
            if (window.currentMatchingIndex !== undefined) {
                const item = productMatchResults[window.currentMatchingIndex];
                const keyName = item.originalProductName || item.valuationProductName;
                
                // å¦‚æœé€‰æ‹©äº†äº§å“ï¼Œæ£€æŸ¥æ˜¯å¦å·²è¢«å…¶ä»–æŒä»“äº§å“åŒ¹é…
                if (productCode) {
                    const isProductAlreadyMatched = Object.keys(productMapping).some(k => {
                        const mapped = productMapping[k];
                        return k !== keyName && mapped.matched && mapped.code === productCode;
                    });

                    if (isProductAlreadyMatched) {
                        // æ‰¾åˆ°æ˜¯å“ªä¸ªæŒä»“äº§å“å·²ç»åŒ¹é…äº†è¿™ä¸ªäº§å“
                        const existingMatchKey = Object.keys(productMapping).find(k => {
                            const mapped = productMapping[k];
                            return k !== keyName && mapped.matched && mapped.code === productCode;
                        });
                        const existingProduct = productMapping[existingMatchKey];

                        // åœ¨åŒ¹é…ç•Œé¢ç›´æ¥æ˜¾ç¤ºè­¦å‘Šæç¤º
                        showDuplicateMatchWarning(existingProduct.name, existingMatchKey);
                        
                        // é‡ç½®é€‰æ‹©ï¼Œä¸æ›´æ–°ä»»ä½•å†…å®¹
                        return;
                    }
                }
            }

            // æ›´æ–°ä¸´æ—¶é€‰æ‹©
            window.tempProductSelection = productCode;
            
            // æ›´æ–°ä¸»è¡¨æ ¼æ˜¾ç¤º
            if (window.currentMatchingIndex !== undefined) {
                const item = productMatchResults[window.currentMatchingIndex];
                item.selectedProductCode = productCode;
                
                // æ›´æ–°æ˜ å°„å…³ç³»
                const keyName = item.originalProductName || item.valuationProductName;
                if (!productCode) {
                    productMapping[keyName] = {
                        name: keyName,
                        code: '',
                        assetClass: '',
                        strategyType: '',
                        strategyName: '',
                        matched: false
                    };
                } else {
                    const selectedProduct = productPool.find(p => p.code === productCode);
                    if (selectedProduct) {
                        productMapping[keyName] = {
                            name: selectedProduct.name,
                            code: selectedProduct.code,
                            assetClass: selectedProduct.assetClass || '',
                            strategyType: selectedProduct.strategyType || '',
                            strategyName: selectedProduct.strategyName || '',
                            minInvest: selectedProduct.minInvest || 0,
                            matched: true
                        };
                    }
                }
                
                // ç«‹å³æ›´æ–°ä¸»è¡¨æ ¼æ˜¾ç¤º
                updateMatchTableRow(window.currentMatchingIndex);
            }
            
            // æœ€åæ›´æ–°é€‰é¡¹é¢æ¿æ˜¾ç¤ºï¼ˆç¡®ä¿é€‰æ‹©çŠ¶æ€æ­£ç¡®ï¼‰
            updateProductOptionsPanel(window.tempProductSelection, window.tempGroupedPool);
        }

        // æ˜¾ç¤ºé‡å¤åŒ¹é…è­¦å‘Šï¼ˆåœ¨äº§å“åŒ¹é…æ¨¡æ€æ¡†å†…æ˜¾ç¤ºï¼‰
        function showDuplicateMatchWarning(productName, holdingName) {
            // å…ˆç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§è­¦å‘Š
            const existingModal = document.getElementById('duplicateMatchWarningModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const warningMessage = `âš ï¸ äº§å“åŒ¹é…å†²çªï¼\n\näº§å“"${productName}"å·²è¢«"${holdingName}"åŒ¹é…ï¼Œæ— æ³•é‡å¤é€‰æ‹©ã€‚\n\nè¯·é€‰æ‹©å…¶ä»–äº§å“ã€‚`;
            
            // åˆ›å»ºè­¦å‘Šå¼¹çª—
            const warningModal = document.createElement('div');
            warningModal.id = 'duplicateMatchWarningModal';
            warningModal.className = 'duplicate-match-warning-modal';
            
            // åˆ›å»ºç¡®å®šæŒ‰é’®
            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'duplicate-match-warning-btn';
            confirmBtn.textContent = 'ç¡®å®š';
            confirmBtn.type = 'button'; // ç¡®ä¿ç±»å‹ä¸ºbutton
            
            // ç«‹å³ç§»é™¤å‡½æ•°
            function closeModal() {
                const modalToRemove = document.getElementById('duplicateMatchWarningModal');
                if (modalToRemove) {
                    modalToRemove.remove();
                }
            }
            
            // ç»‘å®šç¡®å®šæŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼ˆåªç»‘å®šä¸€æ¬¡ï¼‰
            confirmBtn.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                closeModal();
                return false;
            };
            
            // æ„å»ºå¼¹çª—å†…å®¹
            const contentDiv = document.createElement('div');
            contentDiv.className = 'duplicate-match-warning-content';
            contentDiv.onclick = function(e) {
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°èƒŒæ™¯
            };
            
            const iconDiv = document.createElement('div');
            iconDiv.className = 'duplicate-match-warning-icon';
            iconDiv.textContent = 'âš ï¸';
            
            const textDiv = document.createElement('div');
            textDiv.className = 'duplicate-match-warning-text';
            textDiv.innerHTML = warningMessage.replace(/\n/g, '<br>');
            
            contentDiv.appendChild(iconDiv);
            contentDiv.appendChild(textDiv);
            contentDiv.appendChild(confirmBtn);
            warningModal.appendChild(contentDiv);
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            warningModal.onclick = function(e) {
                if (e.target === warningModal) {
                    e.preventDefault();
                    e.stopPropagation();
                    closeModal();
                    return false;
                }
            };
            
            // æ·»åŠ åˆ°äº§å“åŒ¹é…æ¨¡æ€æ¡†å†…å®¹ä¸­
            const modalContent = document.querySelector('#productMatchModal .modal-content');
            modalContent.appendChild(warningModal);
            
            console.log('æ˜¾ç¤ºé‡å¤åŒ¹é…è­¦å‘Š:', productName, holdingName);
        }

        // æ›´æ–°åŒ¹é…è¡¨æ ¼è¡Œçš„æ˜¾ç¤º
        function updateMatchTableRow(index) {
            const item = productMatchResults[index];
            const rows = document.querySelectorAll('#productMatchModalContent tbody tr');
            const row = rows[index];
            
            if (!row) return;
            
            const cells = row.querySelectorAll('td');
            const matchedCell = cells[1]; // åŒ¹é…åˆ°çš„äº§å“æ± äº§å“åˆ—
            const confidenceCell = cells[2]; // ç½®ä¿¡åº¦åˆ—
            
            // æŸ¥æ‰¾åŒ¹é…çš„äº§å“
            let matchedProduct = null;
            if (item.selectedProductCode) {
                matchedProduct = productPool.find(p => p.code === item.selectedProductCode);
            }
            
            // æ›´æ–°åŒ¹é…äº§å“æ˜¾ç¤º
            if (matchedProduct) {
                matchedCell.innerHTML = `<span style="color: #2E8B57; font-weight: 500;">${matchedProduct.name}</span>`;
                confidenceCell.innerHTML = `<span style="color: #2E8B57; font-weight: bold;">100%</span>`;
            } else {
                matchedCell.innerHTML = `<span style="color: #E53935;">æœªæ‰¾åˆ°åŒ¹é…</span>`;
                confidenceCell.innerHTML = `<span style="color: #E53935; font-weight: bold;">æœªåŒ¹é…</span>`;
            }
        }

        // è¿‡æ»¤äº§å“é€‰é¡¹ï¼ˆé¢æ¿ç‰ˆï¼‰
        function filterProductOptionsPanel() {
            const searchTerm = document.getElementById('product-search-panel').value.trim().toLowerCase();
            const optionsContainer = document.getElementById('product-options-panel');

            if (!searchTerm) {
                updateProductOptionsPanel(window.tempProductSelection, window.tempGroupedPool);
                return;
            }

            let html = '';
            let hasResults = false;

            // æœç´¢"æœªé€‰æ‹©äº§å“"é€‰é¡¹
            if ('ä¿ç•™ä¼°å€¼è¡¨åŸå§‹åç§°'.toLowerCase().includes(searchTerm)) {
                hasResults = true;
                const isSelected = window.tempProductSelection === '';
                html += `<div class="option-item ${isSelected ? 'selected' : ''}" onclick="selectProductOptionPanel('', '')">`;
                if (isSelected) {
                    html += `<span class="option-left-border"></span>`;
                }
                html += `<div class="option-name" style="color: ${isSelected ? '#1890ff' : '#595959'}; font-weight: 500;">-- ä¿ç•™ä¼°å€¼è¡¨åŸå§‹åç§° --</div>`;
                html += `</div>`;
            }

            // æœç´¢äº§å“æ± 
            Object.keys(window.tempGroupedPool).forEach(strategy => {
                const products = window.tempGroupedPool[strategy];
                const matchedProducts = products.filter(p =>
                    p.name.toLowerCase().includes(searchTerm) ||
                    p.code.toLowerCase().includes(searchTerm)
                );

                if (matchedProducts.length > 0) {
                    hasResults = true;
                    html += `<div class="option-group">`;
                    html += `<div class="option-group-header" onclick="toggleGroupPanel('temp-group-${strategy.replace(/\s/g, '')}', this)">`;
                    html += `<span>â–¼</span> ${strategy} (${matchedProducts.length}ä¸ª)`;
                    html += `</div>`;
                    html += `<div id="temp-group-${strategy.replace(/\s/g, '')}" class="option-group-body">`;
                    matchedProducts.forEach(product => {
                        const isSelected = window.tempProductSelection === product.code;
                        html += `<div class="option-item ${isSelected ? 'selected' : ''}" onclick="selectProductOptionPanel('${product.code}', '${product.name.replace(/'/g, "\\'")}')">`;
                        if (isSelected) {
                            html += `<span class="option-left-border"></span>`;
                        }
                        html += `<div class="option-name">${product.name}</div>`;
                        html += `<div class="option-code">ä»£ç ï¼š${product.code}</div>`;
                        html += `</div>`;
                    });
                    html += `</div>`;
                    html += `</div>`;
                }
            });

            if (!hasResults) {
                html = `<div style="padding: 40px 20px; text-align: center; color: #999999; font-size: 13px;">æœªæ‰¾åˆ°åŒ¹é…çš„äº§å“</div>`;
            }

            optionsContainer.innerHTML = html;
            
            // é‡æ–°ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            if (optionsContainer._clickHandler) {
                optionsContainer.removeEventListener('click', optionsContainer._clickHandler);
            }
            
            // HTMLä¸­å·²ç»æœ‰onclickå±æ€§ï¼Œä¸éœ€è¦é¢å¤–çš„äº‹ä»¶å§”æ‰˜
            optionsContainer._clickHandler = function(e) {};
            
            optionsContainer.addEventListener('click', optionsContainer._clickHandler);
        }

        // ç¡®è®¤äº§å“é€‰æ‹©ï¼ˆé¢æ¿ç‰ˆï¼‰
        function confirmProductSelectionPanel() {
            if (window.currentMatchingIndex !== undefined) {
                selectProduct(window.currentMatchingIndex, window.tempProductSelection);
            }
            closeProductSelectorPanel();
        }

        // å…³é—­äº§å“é€‰æ‹©å™¨é¢æ¿
        function closeProductSelectorPanel() {
            const selectorPanel = document.getElementById('productSelectorPanel');
            const mainContent = document.getElementById('productMatchModalContent');

            if (selectorPanel) {
                selectorPanel.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    selectorPanel.style.display = 'none';
                    // æ¢å¤å·¦ä¾§å†…å®¹åŒºåŸŸå®½åº¦
                    mainContent.classList.remove('has-sidebar');
                    // ç§»é™¤è¡Œé«˜äº®
                    const rows = document.querySelectorAll('#productMatchModalContent tbody tr');
                    rows.forEach(row => {
                        row.style.background = '';
                    });
                    // ç§»é™¤æ»šåŠ¨åŒæ­¥ç›‘å¬å™¨
                    if (window.scrollSyncHandler) {
                        mainContent.removeEventListener('scroll', window.scrollSyncHandler);
                        window.scrollSyncHandler = null;
                    }
                }, 300);
            }
        }

        // ç”Ÿæˆäº§å“é€‰é¡¹HTMLï¼ˆæŒ‰ç­–ç•¥ç±»å‹åˆ†ç»„ï¼‰
        function generateProductOptionsHTML(selectorId, currentSelection, groupedPool) {
            let html = `<div style="margin-bottom: 15px;">`;
            html += `<div style="font-weight: bold; color: #667eea; margin-bottom: 8px; padding: 8px; background: #f7fafc; border-radius: 4px;">`;
            html += `<span style="cursor: pointer;" onclick="toggleGroup('${selectorId}-holding-group', this)">â–¼ ã€æœªé€‰æ‹©äº§å“ã€‘</span>`;
            html += `</div>`;
            html += `<div id="${selectorId}-holding-group" style="margin-left: 10px;">`;
            html += `<div style="padding: 8px; background: #fff5f5; border-radius: 4px; cursor: pointer; margin-bottom: 5px;" 
                        onclick="selectProductOption('${selectorId}', '', '')">`;
            html += `<span style="color: #e53e3e;">-- ä¿ç•™ä¼°å€¼è¡¨åŸå§‹åç§° --</span>`;
            if (currentSelection === '') {
                html += ` <span style="color: #38a169;">âœ“</span>`;
            }
            html += `</div>`;
            html += `</div>`;
            html += `</div>`;

            // æŒ‰ç­–ç•¥ç±»å‹åˆ†ç»„æ˜¾ç¤ºäº§å“æ± 
            Object.keys(groupedPool).forEach(strategy => {
                const products = groupedPool[strategy];
                const groupId = `${selectorId}-group-${strategy.replace(/\s/g, '')}`;
                html += `<div style="margin-bottom: 15px;">`;
                html += `<div style="font-weight: bold; color: #667eea; margin-bottom: 8px; padding: 8px; background: #f7fafc; border-radius: 4px;">`;
                html += `<span style="cursor: pointer;" onclick="toggleGroup('${groupId}', this)">â–¼ ${strategy} (${products.length}ä¸ª)</span>`;
                html += `</div>`;
                html += `<div id="${groupId}" style="margin-left: 10px;">`;
                products.forEach(product => {
                    const isSelected = currentSelection === product.code;
                    html += `<div style="padding: 8px; background: ${isSelected ? '#c6f6d5' : '#fff'}; border-radius: 4px; cursor: pointer; margin-bottom: 5px; border: 1px solid ${isSelected ? '#48bb78' : '#e2e8f0'};" 
                                onclick="selectProductOption('${selectorId}', '${product.code}', '${product.name.replace(/'/g, "\\'")}')">`;
                    html += `<span style="font-size: 13px;">${product.name}</span>`;
                    html += `<span style="font-size: 11px; color: #718096; margin-left: 8px;">(${product.code})</span>`;
                    if (isSelected) {
                        html += ` <span style="color: #38a169; float: right;">âœ“</span>`;
                    }
                    html += `</div>`;
                });
                html += `</div>`;
                html += `</div>`;
            });

            return html;
        }

        // åˆ‡æ¢åˆ†ç»„å±•å¼€/æŠ˜å 
        function toggleGroup(groupId, element) {
            const group = document.getElementById(groupId);
            if (group) {
                if (group.style.display === 'none') {
                    group.style.display = 'block';
                    // æ‰¾åˆ°spanæ ‡ç­¾ä¸­çš„ç®­å¤´å›¾æ ‡å¹¶æ›´æ–°
                    const arrowSpan = element.querySelector('span');
                    if (arrowSpan) {
                        arrowSpan.textContent = 'â–¼';
                    }
                } else {
                    group.style.display = 'none';
                    // æ‰¾åˆ°spanæ ‡ç­¾ä¸­çš„ç®­å¤´å›¾æ ‡å¹¶æ›´æ–°
                    const arrowSpan = element.querySelector('span');
                    if (arrowSpan) {
                        arrowSpan.textContent = 'â–¶';
                    }
                }
            }
        }

        // é€‰æ‹©äº§å“é€‰é¡¹
        function selectProductOption(selectorId, productCode, productName) {
            window.tempProductSelection = productCode;
            
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            const optionsContainer = document.getElementById(`product-options-${selectorId}`);
            const allOptions = optionsContainer.querySelectorAll('div[onclick*="selectProductOption"]');
            allOptions.forEach(opt => {
                const onclickValue = opt.getAttribute('onclick');
                if (onclickValue.includes(`'${productCode}'`)) {
                    opt.style.background = '#c6f6d5';
                    opt.style.borderColor = '#48bb78';
                    if (!opt.innerHTML.includes('âœ“')) {
                        const checkMark = document.createElement('span');
                        checkMark.style.color = '#38a169';
                        checkMark.style.float = 'right';
                        checkMark.textContent = 'âœ“';
                        opt.appendChild(checkMark);
                    }
                } else {
                    opt.style.background = '#fff';
                    opt.style.borderColor = '#e2e8f0';
                    const checkMark = opt.querySelector('span[style*="float: right"]');
                    if (checkMark) {
                        checkMark.remove();
                    }
                }
            });
        }

        // è¿‡æ»¤äº§å“é€‰é¡¹
        function filterProductOptions(selectorId) {
            const searchTerm = document.getElementById(`product-search-${selectorId}`).value.trim().toLowerCase();
            const optionsContainer = document.getElementById(`product-options-${selectorId}`);
            
            if (!searchTerm) {
                // æ¸…ç©ºæœç´¢ï¼Œæ¢å¤é»˜è®¤æ˜¾ç¤º
                optionsContainer.innerHTML = generateProductOptionsHTML(selectorId, window.tempProductSelection, window.tempGroupedPool);
                return;
            }

            let html = '';
            let hasResults = false;

            // æœç´¢"æœªé€‰æ‹©äº§å“"é€‰é¡¹
            if ('ä¿ç•™ä¼°å€¼è¡¨åŸå§‹åç§°'.toLowerCase().includes(searchTerm)) {
                hasResults = true;
                html += `<div style="padding: 8px; background: #fff5f5; border-radius: 4px; cursor: pointer; margin-bottom: 5px;" 
                            onclick="selectProductOption('${selectorId}', '', '')">`;
                html += `<span style="color: #e53e3e;">-- ä¿ç•™ä¼°å€¼è¡¨åŸå§‹åç§° --</span>`;
                if (window.tempProductSelection === '') {
                    html += ` <span style="color: #38a169;">âœ“</span>`;
                }
                html += `</div>`;
            }

            // æœç´¢äº§å“æ± 
            Object.keys(window.tempGroupedPool).forEach(strategy => {
                const products = window.tempGroupedPool[strategy];
                const matchedProducts = products.filter(p => 
                    p.name.toLowerCase().includes(searchTerm) || 
                    p.code.toLowerCase().includes(searchTerm)
                );

                if (matchedProducts.length > 0) {
                    hasResults = true;
                    html += `<div style="margin-bottom: 15px;">`;
                    html += `<div style="font-weight: bold; color: #667eea; margin-bottom: 8px; padding: 8px; background: #f7fafc; border-radius: 4px;">`;
                    html += `<span>â–¼ ${strategy} (${matchedProducts.length}ä¸ª)</span>`;
                    html += `</div>`;
                    html += `<div style="margin-left: 10px;">`;
                    matchedProducts.forEach(product => {
                        const isSelected = window.tempProductSelection === product.code;
                        html += `<div style="padding: 8px; background: ${isSelected ? '#c6f6d5' : '#fff'}; border-radius: 4px; cursor: pointer; margin-bottom: 5px; border: 1px solid ${isSelected ? '#48bb78' : '#e2e8f0'};" 
                                    onclick="selectProductOption('${selectorId}', '${product.code}', '${product.name.replace(/'/g, "\\'")}')">`;
                        html += `<span style="font-size: 13px;">${product.name}</span>`;
                        html += `<span style="font-size: 11px; color: #718096; margin-left: 8px;">(${product.code})</span>`;
                        if (isSelected) {
                            html += ` <span style="color: #38a169; float: right;">âœ“</span>`;
                        }
                        html += `</div>`;
                    });
                    html += `</div>`;
                    html += `</div>`;
                }
            });

            if (!hasResults) {
                html = `<div style="padding: 20px; text-align: center; color: #718096;">æœªæ‰¾åˆ°åŒ¹é…çš„äº§å“</div>`;
            }

            optionsContainer.innerHTML = html;
        }

        // ç¡®è®¤äº§å“é€‰æ‹©
        function confirmProductSelection(selectorId, index) {
            selectProduct(index, window.tempProductSelection);
            closeProductSelector(selectorId);
        }

        // å…³é—­äº§å“é€‰æ‹©å™¨
        function closeProductSelector(selectorId) {
            const modal = document.getElementById(selectorId);
            if (modal) {
                modal.remove();
            }
        }

        // ç”Ÿæˆäº§å“åˆ—è¡¨HTML
        // é€‰æ‹©äº§å“ï¼ˆé€‚é…åŸç”Ÿselectæ§ä»¶ï¼‰
        function selectProduct(index, productCode) {
            const item = productMatchResults[index];
            const previousProductCode = item.selectedProductCode;
            item.selectedProductCode = productCode;

            // ä½¿ç”¨åŸå§‹åç§°ä½œä¸ºkeyæ¥æ›´æ–°æ˜ å°„å…³ç³»
            const keyName = item.originalProductName || item.valuationProductName;

            // å¦‚æœé€‰æ‹©äº†äº§å“æ± äº§å“ï¼Œæ£€æŸ¥æ˜¯å¦å·²è¢«å…¶ä»–æŒä»“äº§å“åŒ¹é…
            if (productCode) {
                const isProductAlreadyMatched = Object.keys(productMapping).some(key => {
                    const mapped = productMapping[key];
                    return key !== keyName && mapped.matched && mapped.code === productCode;
                });

                if (isProductAlreadyMatched) {
                    const existingMatchKey = Object.keys(productMapping).find(key => {
                        const mapped = productMapping[key];
                        return key !== keyName && mapped.matched && mapped.code === productCode;
                    });
                    const existingProduct = productMapping[existingMatchKey];

                    showAlert(`âŒâš ï¸ åŒ¹é…å¤±è´¥ï¼\n\näº§å“"${existingProduct.name}"å·²ç»è¢«å…¶ä»–æŒä»“äº§å“"${existingMatchKey}"åŒ¹é…ï¼\n\näº§å“æ± ä¸­çš„æ¯ä¸ªäº§å“åªèƒ½è¢«åŒ¹é…ä¸€æ¬¡ã€‚\n\nè¯·é€‰æ‹©å…¶ä»–äº§å“ã€‚`, 'error');

                    item.selectedProductCode = previousProductCode;
                    const selectElement = document.getElementById(`product-select-${index}`);
                    if (selectElement) {
                        selectElement.value = previousProductCode || '';
                    }
                    return;
                }
            }

            // æ›´æ–°æ˜ å°„å…³ç³»
            if (!productCode) {
                productMapping[keyName] = {
                    name: keyName,
                    code: '',
                    matched: false
                };
            } else {
                const selectedProduct = productPool.find(p => p.code === productCode);
                if (selectedProduct) {
                    productMapping[keyName] = {
                        ...selectedProduct,
                        matched: true
                    };
                }
            }
        }

        // åˆå§‹åŒ–é»˜è®¤æŒä»“
        function initHoldings() {
            holdings = [
                { name: 'ä¿¡ç’æŠ•èµ„-ä»·å€¼ç²¾è‹±M1ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘B', shares: 346.764685, nav: 1.4829 },
                { name: 'ä¸–çºªå‰æ²¿æ¾æŸé‡åŒ–å¯¹å†²6å·ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘C', shares: 372.12764, nav: 1.0924 },
                { name: 'å‡¯ä¸°å¾¡é£1å·åŸºæœ¬é¢é‡åŒ–CTAè¯åˆ¸æŠ•èµ„ç§å‹ŸåŸºé‡‘C', shares: 656.598818, nav: 1.288 },
                { name: 'ç£æ¾å¸‚åœºä¸­æ€§2å·ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘', shares: 514.403292, nav: 1.1703 },
                { name: 'å¤§ç¦¾æŠ•èµ„-æ˜é‡‘707å·ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘', shares: 53.347559, nav: 3.911 },
                { name: 'å‡æˆCTAç¨³å¥3å·ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘A', shares: 684.344595, nav: 1.1799 },
                { name: 'æ³“æ¹–é«˜è…¾åšå–»å®è§‚ç­–ç•¥ç§å‹Ÿè¯åˆ¸æŠ•èµ„åŸºé‡‘B', shares: 627.008386, nav: 1.3751 },
                { name: 'è‹±ä»•æ›¼å®é‡1å·ç§å‹ŸåŸºé‡‘B', shares: 301.54542, nav: 1.4095 }
            ];
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabId) {
            console.log('=== switchTab è¢«è°ƒç”¨ ===');
            console.log('tabId:', tabId);
            
            // éšè—æ‰€æœ‰æ ‡ç­¾å†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„activeç±»
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾å†…å®¹
            const tabContent = document.getElementById(tabId);
            if (tabContent) {
                tabContent.classList.add('active');
            }
            // æ·»åŠ activeç±»åˆ°é€‰ä¸­çš„æ ‡ç­¾ï¼ˆé€šè¿‡tabIdæ‰¾åˆ°å¯¹åº”çš„æŒ‰é’®ï¼‰
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                if (tab.getAttribute('onclick').includes(`'${tabId}'`)) {
                    tab.classList.add('active');
                }
            });

            // æ›´æ–°é¡µé¢æ•°æ®
            if (tabId === 'adjustment') {
                updateBuyTable();
                updateSellTable();
            }
            if (tabId === 'buy') updateBuyTable();
            if (tabId === 'sell') {
                updateSellTable();
                updateSellProducts(); // åˆ‡æ¢åˆ°å–å‡ºtabæ—¶æ›´æ–°å–å‡ºäº§å“åˆ—è¡¨
            }
            if (tabId === 'holding') updateHoldingTable();
            if (tabId === 'pool') updatePoolTable();
            if (tabId === 'summary') updateSummary();
        }

        // æŠ˜å /å±•å¼€è°ƒä»“æ“ä½œéƒ¨åˆ†
        function toggleAdjustmentSection(sectionId, toggleId) {
            const section = document.getElementById(sectionId);
            const toggle = document.getElementById(toggleId);
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                toggle.textContent = 'â–¼';
                toggle.style.transform = 'rotate(0deg)';
            } else {
                section.style.display = 'none';
                toggle.textContent = 'â–¶';
                toggle.style.transform = 'rotate(-90deg)';
            }
        }

        // æ›´æ–°ä¹°å…¥äº§å“ä¸‹æ‹‰æ¡†
        function updateBuyProducts() {
            const strategyType = document.getElementById('buyStrategyType').value;
            const dataList = document.getElementById('buyProductList');
            const productInput = document.getElementById('buyProductName');
            dataList.innerHTML = '';
            productInput.value = '';

            if (!strategyType) {
                productInput.placeholder = 'ğŸ” è¯·è¾“å…¥äº§å“åç§°æˆ–ä»£ç æœç´¢ï¼ˆå¦‚ï¼šæ˜æ±¯ã€SNZ840ï¼‰';
                return;
            }

            const filteredProducts = productPool.filter(p => p.strategyName === strategyType);
            if (filteredProducts.length === 0) {
                productInput.placeholder = 'è¯¥ç­–ç•¥ç±»å‹ä¸‹æš‚æ— äº§å“';
                return;
            }

            productInput.placeholder = 'ğŸ” è¯·é€‰æ‹©äº§å“æˆ–è¾“å…¥äº§å“åç§°æœç´¢';

            filteredProducts.forEach(product => {
                const option = document.createElement('option');
                option.value = product.name;
                option.label = `${product.name} (${product.code}) | èµ·æŠ•: ${product.minInvest}ä¸‡`;
                option.dataset.code = product.code;
                option.dataset.strategyName = product.strategyName;
                option.dataset.strategyType = product.strategyType;
                option.dataset.assetClass = product.assetClass;
                option.dataset.minInvest = product.minInvest;
                dataList.appendChild(option);
            });
        }

        // ä¹°å…¥äº§å“è¾“å…¥äº‹ä»¶ï¼ˆå®æ—¶æœç´¢ï¼‰
        function onBuyProductInput() {
            const searchValue = document.getElementById('buyProductName').value.trim().toLowerCase();
            const dataList = document.getElementById('buyProductList');
            const strategyType = document.getElementById('buyStrategyType').value;
            
            dataList.innerHTML = '';

            if (!searchValue) {
                // å¦‚æœä¸ºç©ºï¼Œæ ¹æ®ç­–ç•¥ç±»å‹è¿‡æ»¤
                updateBuyProducts();
                return;
            }

            // å…¨å±€æœç´¢ï¼šæ ¹æ®äº§å“åç§°ã€äº§å“ä»£ç æœç´¢
            let filteredProducts = productPool.filter(p => {
                const nameMatch = p.name.toLowerCase().includes(searchValue);
                const codeMatch = p.code.toLowerCase().includes(searchValue);
                return nameMatch || codeMatch;
            });

            // å¦‚æœé€‰æ‹©äº†ç­–ç•¥ç±»å‹ï¼Œè¿›ä¸€æ­¥è¿‡æ»¤
            if (strategyType) {
                filteredProducts = filteredProducts.filter(p => p.strategyName === strategyType);
            }

            if (filteredProducts.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.disabled = true;
                option.textContent = 'æœªæ‰¾åˆ°åŒ¹é…çš„äº§å“';
                dataList.appendChild(option);
                return;
            }

            filteredProducts.forEach(product => {
                const option = document.createElement('option');
                option.value = product.name;
                option.label = `${product.name} (${product.code}) | èµ·æŠ•: ${product.minInvest}ä¸‡`;
                option.dataset.code = product.code;
                option.dataset.strategyName = product.strategyName;
                option.dataset.strategyType = product.strategyType;
                option.dataset.assetClass = product.assetClass;
                option.dataset.minInvest = product.minInvest;
                dataList.appendChild(option);
            });
        }

        // è·å–æŒä»“ä¸­çš„äº§å“ï¼ˆä¸åœ¨äº§å“æ± ä¸­çš„ï¼‰
        function getHoldingProductsNotInPool() {
            const holdingProductsNotInPool = [];
            
            // éå†æŒä»“æ•°æ®
            if (processedData && processedData['å·²æŠ•åŸºé‡‘éƒ¨åˆ†']) {
                processedData['å·²æŠ•åŸºé‡‘éƒ¨åˆ†'].forEach(fund => {
                    const productName = fund['äº§å“åç§°ï¼ˆå«ä»½é¢ç±»åˆ«ï¼‰'];
                    const productCode = fund['äº§å“ä»£ç '] || '';
                    
                    // æ£€æŸ¥æ˜¯å¦åœ¨äº§å“æ± ä¸­
                    const inPool = productPool.some(p => p.code === productCode);
                    
                    // å¦‚æœä¸åœ¨äº§å“æ± ä¸­ï¼Œæ·»åŠ åˆ°åˆ—è¡¨
                    if (!inPool && productName) {
                        holdingProductsNotInPool.push({
                            name: productName,
                            code: productCode,
                            isPoolProduct: false,
                            // ä½¿ç”¨æŒä»“ä¸­çš„åˆ†ç±»ä¿¡æ¯
                            assetClass: fund['èµ„äº§ç±»åˆ«'] || '',
                            strategyType: fund['ç­–ç•¥ç±»å‹'] || '',
                            strategyName: fund['äº§å“ç­–ç•¥'] || '',
                            // ä½¿ç”¨æŒä»“ä¸­çš„å‡€å€¼
                            currentNav: fund['æ ‡çš„å‡€å€¼'] || 1.0,
                            currentShares: fund['å½“å‰ä»½é¢'] || 0
                        });
                    }
                });
            }
            
            return holdingProductsNotInPool;
        }

        // æŒ‰ç­–ç•¥ç±»å‹åˆ†ç»„æ‰€æœ‰äº§å“ï¼ˆæŒä»“+äº§å“æ± ï¼‰
        function groupBuyProductsByStrategy() {
            console.log('=== groupBuyProductsByStrategy è¢«è°ƒç”¨ ===');
            console.log('productPoolé•¿åº¦:', JSON.stringify(productPool.length));
            console.log('productPoolå†…å®¹:', JSON.stringify(productPool));
            console.log('holdingsé•¿åº¦:', JSON.stringify(holdings.length));
            console.log('holdingså†…å®¹:', JSON.stringify(holdings));
            
            const grouped = {};
            
            // 1. æ·»åŠ æŒä»“äº§å“ï¼ˆä¸åœ¨äº§å“æ± ä¸­çš„ï¼‰
            const holdingProducts = getHoldingProductsNotInPool();
            console.log('æŒä»“äº§å“(ä¸åœ¨æ± ä¸­):', JSON.stringify(holdingProducts));
            holdingProducts.forEach(product => {
                const strategy = product.strategyName || 'æœªåˆ†ç±»';
                if (!grouped[strategy]) {
                    grouped[strategy] = [];
                }
                grouped[strategy].push(product);
            });
            
            // 2. æ·»åŠ äº§å“æ± ä¸­çš„äº§å“
            productPool.forEach(product => {
                const strategy = product.strategyName || 'æœªåˆ†ç±»';
                if (!grouped[strategy]) {
                    grouped[strategy] = [];
                }
                grouped[strategy].push(product);
            });
            
            console.log('æœ€ç»ˆåˆ†ç»„ç»“æœ:', JSON.stringify(grouped));
            
            // æ›´æ–°è°ƒè¯•ä¿¡æ¯æ˜¾ç¤º
            return grouped;
        }

        // æ‰“å¼€ä¹°å…¥äº§å“é€‰æ‹©å™¨
        function openBuyProductSelector() {
            const currentSelection = document.getElementById('buyProductName').value;
            const groupedProducts = groupBuyProductsByStrategy();
            
            // æ˜¾ç¤ºé€‰æ‹©å™¨é¢æ¿
            const selectorPanel = document.getElementById('buyProductSelectorPanel');
            selectorPanel.style.display = 'block';
            selectorPanel.style.animation = 'slideInRight 0.3s ease';
            
            // æ¸…ç©ºæœç´¢æ¡†
            const searchInput = document.getElementById('buyProduct-search-panel');
            if (searchInput) {
                searchInput.value = '';
            }
            
            // æ›´æ–°äº§å“é€‰é¡¹
            updateBuyProductOptionsPanel(currentSelection, groupedProducts);
            
            // å­˜å‚¨ä¸´æ—¶æ•°æ®
            window.tempBuyGroupedProducts = groupedProducts;
            window.tempBuyProductSelection = currentSelection;
        }

        // ç”Ÿæˆä¹°å…¥äº§å“é€‰é¡¹é¢æ¿HTML
        function generateBuyProductOptionsPanelHTML(currentSelection, groupedProducts) {
            // è½¬ä¹‰å‡½æ•°ï¼Œé˜²æ­¢å•å¼•å·å¯¼è‡´JavaScripté”™è¯¯
            function escapeStr(str) {
                if (!str) return '';
                return str.replace(/'/g, "\\'").replace(/"/g, '\\"');
            }
            
            let html = '';
            
            // 1. æŒä»“äº§å“ç»„ï¼ˆä¼˜å…ˆæ˜¾ç¤ºï¼‰
            const holdingProducts = getHoldingProductsNotInPool();
            if (holdingProducts.length > 0) {
                html += `<div style="margin-bottom: 16px;">`;
                html += `<div style="font-weight: 600; color: #FFFFFF; font-size: 13px; margin-bottom: 8px; padding: 10px 12px; background: linear-gradient(135deg, #FF6B6B 0%, #EE5A5A 100%); border-radius: 4px; letter-spacing: 0.5px;">`;
                html += `<span style="cursor: pointer; display: flex; align-items: center;" onclick="toggleBuyGroupPanel('buy-holding-group', this)"><span style="margin-right: 6px;">â–¼</span> ã€æŒä»“äº§å“ã€‘(${holdingProducts.length}ä¸ª)</span>`;
                html += `</div>`;
                html += `<div id="buy-holding-group" style="margin-left: 0;">`;
                holdingProducts.forEach(product => {
                    const isSelected = currentSelection === product.name;
                    html += `<div style="padding: 12px 16px; background: ${isSelected ? '#E6F7FF' : '#FFFFFF'}; border-radius: 4px; cursor: pointer; margin-bottom: 4px; border: 1px solid ${isSelected ? '#1890ff' : '#E4E7ED'}; transition: all 0.2s; position: relative;" 
                                onmouseover="this.style.background='${isSelected ? '#BAE7FF' : '#F5F7FA'}'; this.style.borderColor='${isSelected ? '#1890ff' : '#C0C4CC'}'" 
                                onmouseout="this.style.background='${isSelected ? '#E6F7FF' : '#FFFFFF'}'; this.style.borderColor='${isSelected ? '#1890ff' : '#E4E7ED'}'"
                                onclick="selectBuyProductOption('${escapeStr(product.name)}', '${escapeStr(product.code)}', '${escapeStr(product.strategyName)}', '${escapeStr(product.strategyType)}', '${escapeStr(product.assetClass)}', ${product.isPoolProduct})">`;
                    if (isSelected) {
                        html += `<span style="position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: #1890ff; border-radius: 4px 0 0 4px;"></span>`;
                    }
                    html += `<div style="font-size: 13px; font-weight: 400; color: #333333; line-height: 1.5;">${product.name} ${!product.isPoolProduct ? '<span style="color: #FF6B6B; font-size: 11px; margin-left: 6px;">â˜… (éæ± äº§å“)</span>' : ''}</div>`;
                    if (product.code) {
                        html += `<div style="font-size: 12px; color: #999999; margin-top: 4px;">ä»£ç ï¼š${product.code}</div>`;
                    }
                    html += `</div>`;
                });
                html += `</div>`;
                html += `</div>`;
            }
            
            // 2. äº§å“æ± ç»„ï¼ˆæŒ‰ç­–ç•¥ç±»å‹åˆ†ç»„ï¼‰
            Object.keys(groupedProducts).forEach(strategy => {
                const products = groupedProducts[strategy];
                // è¿‡æ»¤æ‰æŒä»“äº§å“ï¼ˆé¿å…é‡å¤ï¼‰
                const poolProducts = products.filter(p => p.isPoolProduct !== false);
                
                if (poolProducts.length > 0) {
                    const groupId = `buy-group-${strategy.replace(/\s/g, '')}`;
                    html += `<div style="margin-bottom: 16px;">`;
                    html += `<div style="font-weight: 600; color: #FFFFFF; font-size: 13px; margin-bottom: 8px; padding: 10px 12px; background: linear-gradient(135deg, #6A5ACD 0%, #5E4AA2 100%); border-radius: 4px; letter-spacing: 0.5px;">`;
                    html += `<span style="cursor: pointer; display: flex; align-items: center;" onclick="toggleBuyGroupPanel('${groupId}', this)"><span style="margin-right: 6px;">â–¼</span> ${strategy} (${poolProducts.length}ä¸ª)</span>`;
                    html += `</div>`;
                    html += `<div id="${groupId}" style="margin-left: 0;">`;
                    poolProducts.forEach(product => {
                        const isSelected = currentSelection === product.name;
                        html += `<div style="padding: 12px 16px; background: ${isSelected ? '#E6F7FF' : '#FFFFFF'}; border-radius: 4px; cursor: pointer; margin-bottom: 4px; border: 1px solid ${isSelected ? '#1890ff' : '#E4E7ED'}; transition: all 0.2s; position: relative;" 
                                    onmouseover="this.style.background='${isSelected ? '#BAE7FF' : '#F5F7FA'}'; this.style.borderColor='${isSelected ? '#1890ff' : '#C0C4CC'}'" 
                                    onmouseout="this.style.background='${isSelected ? '#E6F7FF' : '#FFFFFF'}'; this.style.borderColor='${isSelected ? '#1890ff' : '#E4E7ED'}'"
                                    onclick="selectBuyProductOption('${escapeStr(product.name)}', '${escapeStr(product.code)}', '${escapeStr(product.strategyName)}', '${escapeStr(product.strategyType)}', '${escapeStr(product.assetClass)}', true)">`;
                        if (isSelected) {
                            html += `<span style="position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: #1890ff; border-radius: 4px 0 0 4px;"></span>`;
                        }
                        html += `<div style="font-size: 13px; font-weight: 400; color: #333333; line-height: 1.5;">${escapeStr(product.name)}</div>`;
                        html += `<div style="font-size: 12px; color: #999999; margin-top: 4px;">ä»£ç ï¼š${escapeStr(product.code)}</div>`;
                        html += `</div>`;
                    });
                    html += `</div>`;
                    html += `</div>`;
                }
            });
            
            return html;
        }

        // æ›´æ–°ä¹°å…¥äº§å“é€‰é¡¹é¢æ¿
        function updateBuyProductOptionsPanel(currentSelection, groupedProducts) {
            const optionsContainer = document.getElementById('buyProduct-options-panel');
            if (optionsContainer) {
                optionsContainer.innerHTML = generateBuyProductOptionsPanelHTML(currentSelection, groupedProducts);
            }
        }

        // åˆ‡æ¢ä¹°å…¥äº§å“åˆ†ç»„å±•å¼€/æŠ˜å 
        function toggleBuyGroupPanel(groupId, element) {
            const group = document.getElementById(groupId);
            if (group) {
                if (group.style.display === 'none') {
                    group.style.display = 'block';
                    element.textContent = element.textContent.replace('â–¶', 'â–¼');
                } else {
                    group.style.display = 'none';
                    element.textContent = element.textContent.replace('â–¼', 'â–¶');
                }
            }
        }

        // é€‰æ‹©ä¹°å…¥äº§å“é€‰é¡¹
        function selectBuyProductOption(productName, productCode, strategyName, strategyType, assetClass, isPoolProduct) {
            console.log('=== selectBuyProductOption è¢«è°ƒç”¨ ===');
            console.log('productName:', productName);
            console.log('productCode:', productCode);
            console.log('strategyName:', strategyName);
            console.log('strategyType:', strategyType);
            console.log('assetClass:', assetClass);
            console.log('isPoolProduct:', isPoolProduct);
            
            window.tempBuyProductSelection = productName;
            window.tempBuySelectedProduct = {
                name: productName,
                code: productCode,
                strategyName: strategyName,
                strategyType: strategyType,
                assetClass: assetClass,
                isPoolProduct: isPoolProduct
            };
            console.log('å·²è®¾ç½® window.tempBuySelectedProduct:', window.tempBuySelectedProduct);
            updateBuyProductOptionsPanel(productName, window.tempBuyGroupedProducts);
        }

        // è¿‡æ»¤ä¹°å…¥äº§å“é€‰é¡¹
        function filterBuyProductOptionsPanel() {
            const searchTerm = document.getElementById('buyProduct-search-panel').value.trim().toLowerCase();
            const optionsContainer = document.getElementById('buyProduct-options-panel');
            
            if (!searchTerm) {
                // æ¸…ç©ºæœç´¢ï¼Œæ¢å¤é»˜è®¤æ˜¾ç¤º
                updateBuyProductOptionsPanel(window.tempBuyProductSelection, window.tempBuyGroupedProducts);
                return;
            }

            let html = '';
            let hasResults = false;

            // æœç´¢æŒä»“äº§å“
            const holdingProducts = getHoldingProductsNotInPool();
            const matchedHoldingProducts = holdingProducts.filter(p => 
                p.name.toLowerCase().includes(searchTerm) || 
                (p.code && p.code.toLowerCase().includes(searchTerm))
            );

            if (matchedHoldingProducts.length > 0) {
                hasResults = true;
                html += `<div style="margin-bottom: 16px;">`;
                html += `<div style="font-weight: 600; color: #FFFFFF; font-size: 13px; margin-bottom: 8px; padding: 10px 12px; background: linear-gradient(135deg, #FF6B6B 0%, #EE5A5A 100%); border-radius: 4px; letter-spacing: 0.5px;">`;
                html += `<span>ã€æŒä»“äº§å“ã€‘(${matchedHoldingProducts.length}ä¸ª)</span>`;
                html += `</div>`;
                html += `<div style="margin-left: 0;">`;
                matchedHoldingProducts.forEach(product => {
                    const isSelected = window.tempBuyProductSelection === product.name;
                    html += `<div style="padding: 12px 16px; background: ${isSelected ? '#E6F7FF' : '#FFFFFF'}; border-radius: 4px; cursor: pointer; margin-bottom: 4px; border: 1px solid ${isSelected ? '#1890ff' : '#E4E7ED'}; transition: all 0.2s; position: relative;" 
                                onmouseover="this.style.background='${isSelected ? '#BAE7FF' : '#F5F7FA'}'; this.style.borderColor='${isSelected ? '#1890ff' : '#C0C4CC'}'" 
                                onmouseout="this.style.background='${isSelected ? '#E6F7FF' : '#FFFFFF'}'; this.style.borderColor='${isSelected ? '#1890ff' : '#E4E7ED'}'"
                                onclick="selectBuyProductOption('${product.name}', '${product.code}', '${product.strategyName}', '${product.strategyType}', '${product.assetClass}', ${product.isPoolProduct})">`;
                    if (isSelected) {
                        html += `<span style="position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: #1890ff; border-radius: 4px 0 0 4px;"></span>`;
                    }
                    html += `<div style="font-size: 13px; font-weight: 400; color: #333333; line-height: 1.5;">${product.name} ${!product.isPoolProduct ? '<span style="color: #FF6B6B; font-size: 11px; margin-left: 6px;">â˜… (éæ± äº§å“)</span>' : ''}</div>`;
                    if (product.code) {
                        html += `<div style="font-size: 12px; color: #999999; margin-top: 4px;">ä»£ç ï¼š${product.code}</div>`;
                    }
                    html += `</div>`;
                });
                html += `</div>`;
                html += `</div>`;
            }

            // æœç´¢äº§å“æ± 
            Object.keys(window.tempBuyGroupedProducts).forEach(strategy => {
                const products = window.tempBuyGroupedProducts[strategy];
                const matchedProducts = products.filter(p => 
                    p.name.toLowerCase().includes(searchTerm) || 
                    (p.code && p.code.toLowerCase().includes(searchTerm))
                );

                if (matchedProducts.length > 0) {
                    hasResults = true;
                    html += `<div style="margin-bottom: 16px;">`;
                    html += `<div style="font-weight: 600; color: #FFFFFF; font-size: 13px; margin-bottom: 8px; padding: 10px 12px; background: linear-gradient(135deg, #6A5ACD 0%, #5E4AA2 100%); border-radius: 4px; letter-spacing: 0.5px;">`;
                    html += `<span>â–¼ ${strategy} (${matchedProducts.length}ä¸ª)</span>`;
                    html += `</div>`;
                    html += `<div style="margin-left: 0;">`;
                    matchedProducts.forEach(product => {
                        const isSelected = window.tempBuyProductSelection === product.name;
                        html += `<div style="padding: 12px 16px; background: ${isSelected ? '#E6F7FF' : '#FFFFFF'}; border-radius: 4px; cursor: pointer; margin-bottom: 4px; border: 1px solid ${isSelected ? '#1890ff' : '#E4E7ED'}; transition: all 0.2s; position: relative;" 
                                    onmouseover="this.style.background='${isSelected ? '#BAE7FF' : '#F5F7FA'}'; this.style.borderColor='${isSelected ? '#1890ff' : '#C0C4CC'}'" 
                                    onmouseout="this.style.background='${isSelected ? '#E6F7FF' : '#FFFFFF'}'; this.style.borderColor='${isSelected ? '#1890ff' : '#E4E7ED'}'"
                                    onclick="selectBuyProductOption('${product.name}', '${product.code}', '${product.strategyName}', '${product.strategyType}', '${product.assetClass}', true)">`;
                        if (isSelected) {
                            html += `<span style="position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: #1890ff; border-radius: 4px 0 0 4px;"></span>`;
                        }
                        html += `<div style="font-size: 13px; font-weight: 400; color: #333333; line-height: 1.5;">${product.name}</div>`;
                        html += `<div style="font-size: 12px; color: #999999; margin-top: 4px;">ä»£ç ï¼š${product.code}</div>`;
                        html += `</div>`;
                    });
                    html += `</div>`;
                    html += `</div>`;
                }
            });

            if (!hasResults) {
                html = `<div style="padding: 40px 20px; text-align: center; color: #999999; font-size: 13px;">æœªæ‰¾åˆ°åŒ¹é…çš„äº§å“</div>`;
            }

            optionsContainer.innerHTML = html;
        }

        // ç¡®è®¤ä¹°å…¥äº§å“é€‰æ‹©
        function confirmBuyProductSelection() {
            console.log('=== confirmBuyProductSelection è¢«è°ƒç”¨ ===');
            console.log('window.tempBuySelectedProduct:', window.tempBuySelectedProduct);

            // ä»å½“å‰æ´»åŠ¨tabä¸­è·å–è¾“å…¥æ¡†
            const activeTab = document.querySelector('.tab-content.active');
            if (!activeTab) {
                console.error('æœªæ‰¾åˆ°æ´»åŠ¨tab');
                showAlert('âš ï¸ ç³»ç»Ÿé”™è¯¯ï¼šæœªæ‰¾åˆ°æ´»åŠ¨æ ‡ç­¾é¡µ', 'error');
                return;
            }

            console.log('å½“å‰æ´»åŠ¨tab:', activeTab.id);

            // åœ¨å½“å‰æ´»åŠ¨tabä¸­æŸ¥æ‰¾è¾“å…¥æ¡†
            const buyProductNameElement = activeTab.querySelector('#buyProductName');
            const buyStrategyTypeElement = activeTab.querySelector('#buyStrategyType');

            console.log('buyProductNameElement:', buyProductNameElement);
            console.log('buyStrategyTypeElement:', buyStrategyTypeElement);

            if (window.tempBuySelectedProduct) {
                const product = window.tempBuySelectedProduct;

                // æ›´æ–°äº§å“åç§°è¾“å…¥æ¡†
                if (buyProductNameElement) {
                    buyProductNameElement.value = product.name;
                    buyProductNameElement.style.color = '#212121';
                }

                // è‡ªåŠ¨å¡«å……ç­–ç•¥ç±»å‹
                if (product.strategyName && buyStrategyTypeElement) {
                    buyStrategyTypeElement.value = product.strategyName;
                }

                // å¦‚æœæ˜¯æŒä»“äº§å“ï¼Œæ˜¾ç¤ºæç¤º
                if (!product.isPoolProduct) {
                    showAlert(`âœ… å·²é€‰æ‹©æŒä»“äº§å“"${product.name}"ï¼ˆéæ± äº§å“ï¼‰\n\nè¯¥äº§å“ä¸åœ¨äº§å“æ± ä¸­ï¼Œä½†å¯ä»¥ç»§ç»­åŠ ä»“ã€‚`, 'info');
                }
            } else {
                showAlert('âš ï¸ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªäº§å“', 'error');
            }

            closeBuyProductSelector();
        }

        // å…³é—­ä¹°å…¥äº§å“é€‰æ‹©å™¨
        function closeBuyProductSelector() {
            const selectorPanel = document.getElementById('buyProductSelectorPanel');
            if (selectorPanel) {
                selectorPanel.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    selectorPanel.style.display = 'none';
                }, 300);
            }
        }

        // è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†
        let confirmCallback = null;
        let confirmActionLevel = 0; // 0: ç¬¬ä¸€æ¬¡ç¡®è®¤, 1: ç¬¬äºŒæ¬¡ç¡®è®¤

        function showConfirmModal(title, message, callback, confirmText = 'ç¡®è®¤æ¸…ç©º') {
            confirmCallback = callback;
            document.getElementById('confirmModalTitle').textContent = title;
            document.getElementById('confirmModalMessage').textContent = message;
            document.getElementById('confirmModalConfirm').textContent = confirmText;
            
            const modal = document.getElementById('confirmModal');
            modal.style.display = 'flex';
        }

        function closeConfirmModal() {
            const modal = document.getElementById('confirmModal');
            modal.style.display = 'none';
            confirmCallback = null;
            confirmActionLevel = 0;
        }

        function executeConfirmAction() {
            if (confirmCallback) {
                confirmCallback();
            }
            closeConfirmModal();
        }

        // ä¹°å…¥äº§å“é€‰æ‹©äº‹ä»¶
        function onBuyProductSelect() {
            const selectedValue = document.getElementById('buyProductName').value;
            const dataList = document.getElementById('buyProductList');
            let selectedProduct = null;

            // æŸ¥æ‰¾é€‰ä¸­çš„äº§å“
            for (let i = 0; i < dataList.options.length; i++) {
                if (dataList.options[i].value === selectedValue) {
                    selectedProduct = dataList.options[i];
                    break;
                }
            }

            if (!selectedProduct) {
                return;
            }

            // è‡ªåŠ¨å›è°ƒäº§å“ç­–ç•¥ç±»å‹
            const strategyName = selectedProduct.dataset.strategyName;
            if (strategyName) {
                document.getElementById('buyStrategyType').value = strategyName;
            }

            // å¦‚æœéœ€è¦ï¼Œä¹Ÿå¯ä»¥å›è°ƒäº§å“ç±»å‹ï¼ˆèµ„äº§ç±»åˆ«ï¼‰
            // const assetClass = selectedProduct.dataset.assetClass;
            // if (assetClass) {
            //     // è¿™é‡Œå¯ä»¥æ ¹æ®éœ€è¦è®¾ç½®å…¶ä»–å­—æ®µ
            // }
        }

        // æ·»åŠ ä¹°å…¥è®¢å•
        function addBuyOrder() {
            console.log('=== addBuyOrder è¢«è°ƒç”¨ ===');
            
            // ä»å½“å‰æ´»åŠ¨tabä¸­è·å–è¾“å…¥æ¡†
            const activeTab = document.querySelector('.tab-content.active');
            if (!activeTab) {
                console.error('æœªæ‰¾åˆ°æ´»åŠ¨tab');
                return;
            }
            
            console.log('å½“å‰æ´»åŠ¨tab:', activeTab.id);
            
            const strategyTypeElement = activeTab.querySelector('#buyStrategyType');
            const productNameElement = activeTab.querySelector('#buyProductName');
            const amountElement = activeTab.querySelector('#buyAmount');
            
            console.log('strategyTypeElement:', strategyTypeElement);
            console.log('productNameElement:', productNameElement);
            console.log('amountElement:', amountElement);
            
            const strategyType = strategyTypeElement ? strategyTypeElement.value : '';
            const productName = productNameElement ? productNameElement.value : '';
            const amount = amountElement ? parseFloat(amountElement.value) : 0;
            
            console.log('ç­–ç•¥ç±»å‹:', strategyType);
            console.log('äº§å“åç§°:', productName);
            console.log('ç”³è´­é‡‘é¢:', amount);

            if (!strategyType) {
                showAlert('âš ï¸ è¯·å…ˆé€‰æ‹©ç­–ç•¥ç±»å‹', 'error');
                return;
            }

            if (!productName) {
                showAlert('âš ï¸ è¯·å…ˆé€‰æ‹©äº§å“', 'error');
                return;
            }

            if (!amount || amount <= 0) {
                showAlert('âš ï¸ è¯·è¾“å…¥æœ‰æ•ˆçš„ç”³è´­é‡‘é¢', 'error');
                return;
            }

            // æ£€æŸ¥è¯¥äº§å“æ˜¯å¦åœ¨å–å‡ºåˆ—è¡¨ä¸­
            const sellOrder = sellOrders.find(o => o.productName === productName);
            if (sellOrder) {
                showAlert(`âŒâš ï¸ è¯¥äº§å“"${productName}"å·²åœ¨å–å‡ºåˆ—è¡¨ä¸­ï¼\n\nåŒä¸€ä¸ªäº§å“ä¸èƒ½åŒæ—¶è¿›è¡Œä¹°å…¥å’Œå–å‡ºæ“ä½œã€‚\n\nè¯·å…ˆä»å–å‡ºåˆ—è¡¨ä¸­åˆ é™¤è¯¥äº§å“ï¼Œæˆ–é€‰æ‹©å…¶ä»–äº§å“è¿›è¡Œä¹°å…¥ã€‚`, 'error');
                return;
            }

            // æ£€æŸ¥è¯¥äº§å“æ˜¯å¦åœ¨æŒä»“ä¸­ï¼ˆå·²æŠ•åŸºé‡‘ï¼‰
            const holding = holdings.find(h => h.name === productName && h.category === 'å·²æŠ•åŸºé‡‘');

            // æ£€æŸ¥æ˜¯å¦å·²ç»æ·»åŠ è¿‡è¯¥äº§å“
            const existingOrder = buyOrders.find(o => o.productName === productName);
            if (existingOrder) {
                if (!confirm(`äº§å“"${productName}"å·²åœ¨ä¹°å…¥åˆ—è¡¨ä¸­ï¼Œæ˜¯å¦è¦ä¿®æ”¹ç”³è´­é‡‘é¢ï¼Ÿ\n\nå½“å‰é‡‘é¢ï¼š${existingOrder.amount.toFixed(2)}ä¸‡å…ƒ\næ–°é‡‘é¢ï¼š${amount.toFixed(2)}ä¸‡å…ƒ`)) {
                    return;
                }
                // æ›´æ–°ç°æœ‰è®¢å•
                existingOrder.amount = amount;
                updateBuyTable();
                clearBuyForm();
                showAlert(`âœ… äº§å“"${productName}"å·²æ›´æ–°ç”³è´­é‡‘é¢`, 'success');
                return;
            }

            // å¦‚æœäº§å“åœ¨æŒä»“ä¸­ï¼Œè¿™æ˜¯è¿½åŠ æ“ä½œ
            if (holding) {
                if (!confirm(`äº§å“"${productName}"å·²åœ¨æŒä»“ä¸­ï¼Œè¿™æ˜¯è¿½åŠ ä¹°å…¥æ“ä½œã€‚\n\nå½“å‰æŒä»“å¸‚å€¼ï¼š${(holding.shares * holding.nav).toFixed(2)}ä¸‡å…ƒ\næœ¬æ¬¡è¿½åŠ é‡‘é¢ï¼š${amount.toFixed(2)}ä¸‡å…ƒ\n\næ˜¯å¦ç»§ç»­ï¼Ÿ`)) {
                    return;
                }
            }

            // æ ¡éªŒä¹°å…¥é‡‘é¢ä¸èƒ½è¶…è¿‡ï¼ˆå¯æŠ•ç§‘ç›®æ€»é‡‘é¢ - éœ€æ”¯ä»˜ç§‘ç›®æ€»é‡‘é¢ï¼‰
            if (hasImportedHoldings) {
                // è®¡ç®—å½“å‰å·²å‹¾é€‰çš„ä¹°å…¥æ€»é‡‘é¢
                const currentCheckedBuyAmount = buyOrders.filter(o => o.checked).reduce((sum, o) => sum + o.amount, 0);

                // è®¡ç®—æ€»ä¹°å…¥é‡‘é¢ï¼ˆå½“å‰å‹¾é€‰çš„ + æ–°å¢çš„ï¼‰
                const totalBuyAmount = currentCheckedBuyAmount + amount;

                // ä¸Šé™ = å¯æŠ•ç§‘ç›®æ€»é‡‘é¢ - éœ€æ”¯ä»˜ç§‘ç›®æ€»é‡‘é¢
                const buyLimit = investableAmount;

                if (totalBuyAmount > buyLimit) {
                    showAlert(`âŒâŒâŒ è¿è§„æ“ä½œï¼ä¹°å…¥é‡‘é¢è¶…å‡ºä¸Šé™ï¼\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\näº§å“åç§°ï¼š${productName}\nç­–ç•¥ç±»å‹ï¼š${strategyType}\n\nä¹°å…¥ä¸Šé™ï¼ˆå¯ç”¨èµ„é‡‘-å¾…ä»˜è´¹ç”¨ï¼‰ï¼š${buyLimit.toFixed(6)} ä¸‡å…ƒ\nå½“å‰å·²å‹¾é€‰ä¹°å…¥ï¼š${currentCheckedBuyAmount.toFixed(6)} ä¸‡å…ƒ\næœ¬æ¬¡æ‹Ÿä¹°å…¥ï¼š${amount.toFixed(6)} ä¸‡å…ƒ\n\nâŒ åˆè®¡ä¹°å…¥ï¼š${totalBuyAmount.toFixed(6)} ä¸‡å…ƒ\nâœ… ä¹°å…¥ä¸Šé™ï¼š${buyLimit.toFixed(6)} ä¸‡å…ƒ\n\nâŒ è¶…å‡ºé‡‘é¢ï¼š${(totalBuyAmount - buyLimit).toFixed(6)} ä¸‡å…ƒ\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nğŸš« æ­¤æ“ä½œå·²è¢«é˜»æ­¢ï¼è¯·å‡å°‘ç”³è´­é‡‘é¢ï¼Œç¡®ä¿åˆè®¡ä¹°å…¥ä¸è¶…è¿‡ä¸Šé™ï¼`, 'error');
                    return;
                }
            }

            // æŸ¥æ‰¾äº§å“æ± ä¸­çš„äº§å“ä¿¡æ¯
            const product = productPool.find(p => p.name === productName);

            // æ·»åŠ æ–°è®¢å•
            const order = {
                id: Date.now(),
                strategyType: strategyType,
                productName: productName,
                amount: amount,
                checked: true,
                isAdditional: !!holding,  // æ ‡è®°æ˜¯å¦ä¸ºè¿½åŠ æ“ä½œ
                // æ·»åŠ ç­–ç•¥ç±»å‹å­—æ®µ
                assetClass: product ? product.assetClass : (holding ? holding.assetClass : ''),
                strategyName: product ? product.strategyName : (holding ? holding.strategyName : '')
            };
            buyOrders.push(order);

            updateBuyTable();
            clearBuyForm();

            // æ ¹æ®æ“ä½œç±»å‹æ˜¾ç¤ºä¸åŒçš„æç¤º
            if (order.isAdditional) {
                showAlert(`âœ… äº§å“"${productName}"å·²è¿½åŠ åˆ°ä¹°å…¥åˆ—è¡¨`, 'success');
            } else {
                showAlert(`âœ… äº§å“"${productName}"å·²æ·»åŠ åˆ°ä¹°å…¥åˆ—è¡¨`, 'success');
            }
        }

        // æ¸…ç©ºä¹°å…¥è¡¨å•
        function clearBuyForm() {
            document.getElementById('buyStrategyType').value = '';
            document.getElementById('buyProductName').value = '';
            document.getElementById('buyAmount').value = '';
        }

        // æ›´æ–°ä¹°å…¥è¡¨æ ¼
        function updateBuyTable() {
            const tbody = document.getElementById('buyTableBody');
            const emptyState = document.getElementById('buyEmptyState');
            tbody.innerHTML = '';

            if (buyOrders.length === 0) {
                emptyState.style.display = 'block';
                document.getElementById('buyTable').style.display = 'none';
                return;
            }

            emptyState.style.display = 'none';
            document.getElementById('buyTable').style.display = 'table';

            // è°ƒä»“åä¸“æˆ·æ€»å¸‚å€¼ä¿æŒä¸å˜ï¼Œä½¿ç”¨totalMarketValueè®¡ç®—æŠ•åæ¯”ä¾‹
            buyOrders.forEach((order, index) => {
                const percentage = order.checked ? ((order.amount / totalMarketValue) * 100).toFixed(2) : '0.00';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="text-align: center;"><input type="checkbox" ${order.checked ? 'checked' : ''} onchange="toggleBuyOrder(${order.id})"></td>
                    <td style="text-align: center;">${order.strategyType}</td>
                    <td style="text-align: center;">${order.productName}</td>
                    <td style="text-align: center;" class="input-number">${order.amount.toFixed(2)}</td>
                    <td style="text-align: center;" class="input-number">${percentage}%</td>
                    <td style="text-align: center;">${validatePercentage(parseFloat(percentage))}</td>
                    <td style="text-align: center;">
                        <button class="btn btn-xs btn-danger" onclick="deleteBuyOrder(${order.id})">åˆ é™¤</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // åˆ‡æ¢ä¹°å…¥è®¢å•é€‰ä¸­çŠ¶æ€
        function toggleBuyOrder(id) {
            const order = buyOrders.find(o => o.id === id);
            if (order) {
                order.checked = !order.checked;
                updateBuyTable();
                calculateRemainingBuyAmount(); // åˆ‡æ¢é€‰ä¸­çŠ¶æ€æ—¶é‡æ–°è®¡ç®—å‰©ä½™é‡‘é¢
            }
        }

        // åˆ é™¤ä¹°å…¥è®¢å•
        function deleteBuyOrder(id) {
            const order = buyOrders.find(o => o.id === id);
            if (order && confirm(`ç¡®å®šè¦åˆ é™¤"${order.productName}"å—ï¼Ÿ`)) {
                buyOrders = buyOrders.filter(o => o.id !== id);
                updateBuyTable();
                calculateRemainingBuyAmount(); // åˆ é™¤æ—¶é‡æ–°è®¡ç®—å‰©ä½™é‡‘é¢
                showAlert(`âœ… "${order.productName}"å·²åˆ é™¤`, 'success');
            }
        }

        // æ¯”ä¾‹æ ¡éªŒ
        function validatePercentage(percentage) {
            if (percentage >= 30) {
                return '<span class="badge badge-warning">â‰¥30%</span>';
            } else if (percentage <= 0) {
                return '<span class="badge badge-danger">0%</span>';
            } else {
                return '<span class="badge badge-success">æ­£å¸¸</span>';
            }
        }

        // æ›´æ–°å–å‡ºäº§å“ä¸‹æ‹‰æ¡† - åªæ˜¾ç¤ºå·²æŠ•åŸºé‡‘
        function updateSellProducts() {
            console.log('=== updateSellProducts è¢«è°ƒç”¨ ===');
            console.log('holdingsæ•°ç»„é•¿åº¦:', JSON.stringify(holdings.length));
            console.log('holdingsæ•°ç»„å†…å®¹:', JSON.stringify(holdings));
            
            // è·å–æ‰€æœ‰idä¸ºsellProductNameçš„ä¸‹æ‹‰æ¡†
            const productSelects = document.querySelectorAll('#sellProductName');
            if (productSelects.length === 0) {
                console.error('æœªæ‰¾åˆ°sellProductNameå…ƒç´ !');
                return;
            }
            
            console.log('æ‰¾åˆ°', productSelects.length, 'ä¸ªå–å‡ºä¸‹æ‹‰æ¡†');
            
            // åªç­›é€‰åˆ†ç±»ä¸º"å·²æŠ•åŸºé‡‘"çš„æŒä»“
            const investFunds = holdings.filter(h => h.category === 'å·²æŠ•åŸºé‡‘');
            
            // ç”Ÿæˆé€‰é¡¹HTML
            let optionsHtml = '<option value="">è¯·é€‰æ‹©è¦å–å‡ºçš„äº§å“</option>';
            investFunds.forEach(holding => {
                optionsHtml += `<option value="${holding.name}">${holding.name}</option>`;
                console.log('æ·»åŠ å–å‡ºäº§å“é€‰é¡¹:', JSON.stringify(holding.name));
            });

            // å¦‚æœæ²¡æœ‰å·²æŠ•åŸºé‡‘ï¼Œæ˜¾ç¤ºæç¤º
            if (investFunds.length === 0) {
                optionsHtml += '<option value="" disabled>æš‚æ— å·²æŠ•åŸºé‡‘</option>';
            }
            
            // æ›´æ–°æ‰€æœ‰å–å‡ºä¸‹æ‹‰æ¡†
            productSelects.forEach(select => {
                select.innerHTML = optionsHtml;
                console.log('å·²æ›´æ–°ä¸‹æ‹‰æ¡†:', select);
            });
            
            // é‡æ–°è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            setupSellProductChangeListeners();
        }

        // é€‰æ‹©å–å‡ºäº§å“æ—¶è‡ªåŠ¨å¡«å……å½“å‰å‡€å€¼å’Œä»½é¢
        function setupSellProductChangeListeners() {
            console.log('=== setupSellProductChangeListeners è¢«è°ƒç”¨ ===');
            const sellProductSelects = document.querySelectorAll('#sellProductName');
            console.log('æ‰¾åˆ°', sellProductSelects.length, 'ä¸ªsellProductNameå…ƒç´ ');
            
            sellProductSelects.forEach((select, index) => {
                console.log(`å…ƒç´ ${index + 1}:`, select);
                // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                select.removeEventListener('change', handleSellProductChange);
                // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
                select.addEventListener('change', handleSellProductChange);
                console.log(`å·²ä¸ºå…ƒç´ ${index + 1}æ·»åŠ changeäº‹ä»¶ç›‘å¬å™¨`);
            });
        }
        
        function handleSellProductChange() {
                    const productName = this.value;
                    const holding = holdings.find(h => h.name === productName && h.category === 'å·²æŠ•åŸºé‡‘');
        
                    // æ‰¾åˆ°å¯¹åº”çš„è¡¨å•ä¸­çš„å­—æ®µ
                    const parentForm = this.closest('.card') || this.closest('.form-group');
                    const navElement = parentForm ? parentForm.querySelector('#sellCurrentNav') : document.getElementById('sellCurrentNav');
                    const sharesElement = parentForm ? parentForm.querySelector('#sellCurrentShares') : document.getElementById('sellCurrentShares');
                    
                    if (holding) {
                        if (navElement) {
                            navElement.value = holding.nav;
                        }
                        if (sharesElement) {
                            sharesElement.value = holding.shares.toFixed(2);
                        }
                        calculateRemainingValue(); // é‡ç½®æ—¶é‡æ–°è®¡ç®—
                    } else {
                        if (navElement) navElement.value = '';
                        if (sharesElement) sharesElement.value = '';
                        const displayElement = document.getElementById('remainingValueAmount');
                        const containerElement = document.getElementById('remainingValueDisplay');
                        if (displayElement) displayElement.textContent = '--';
                        if (containerElement) containerElement.style.background = '#f7fafc';
                        // éšè—è­¦å‘Š
                        const warningElement = document.getElementById('remainingValueWarning');
                        if (warningElement) warningElement.style.display = 'none';
                    }
                }
        // å®æ—¶è®¡ç®—å–å‡ºåå‰©ä½™å¸‚å€¼
        function calculateRemainingValue() {
            // è·å–å½“å‰æ´»åŠ¨tabä¸­çš„å…ƒç´ 
            const activeTab = document.querySelector('.tab-content.active');
            if (!activeTab) return;
            
            const currentNavElement = activeTab.querySelector('#sellCurrentNav');
            const currentSharesElement = activeTab.querySelector('#sellCurrentShares');
            const redeemSharesElement = activeTab.querySelector('#sellRedeemShares');
            
            if (!currentNavElement || !currentSharesElement || !redeemSharesElement) return;
            
            const currentNav = parseFloat(currentNavElement.value);
            const currentShares = parseFloat(currentSharesElement.value);
            const redeemShares = parseFloat(redeemSharesElement.value);
            
            const displayElement = activeTab.querySelector('#remainingValueAmount');
            const containerElement = activeTab.querySelector('#remainingValueDisplay');

            if (!currentNav || !currentShares || isNaN(redeemShares)) {
                if (displayElement) displayElement.textContent = '--';
                if (containerElement) containerElement.style.background = '#f7fafc';
                
                // éšè—è­¦å‘Š
                const warningElement = activeTab.querySelector('#remainingValueWarning');
                if (warningElement) warningElement.style.display = 'none';
                
                // æ¸…ç©ºè°ƒä»“æ“ä½œtabä¸­çš„å­—æ®µ
                const sellRedeemAmountElement = activeTab.querySelector('#sellRedeemAmount');
                const sellRemainingValueElement = activeTab.querySelector('#sellRemainingValue');
                if (sellRedeemAmountElement) sellRedeemAmountElement.value = '';
                if (sellRemainingValueElement) sellRemainingValueElement.value = '';
                return;
            }

            const remainingShares = currentShares - redeemShares;
            const remainingValue = remainingShares * currentNav;
            const redeemAmount = redeemShares * currentNav;

            // æ›´æ–°è°ƒä»“æ“ä½œtabä¸­çš„å­—æ®µ
            const sellRedeemAmountElement = activeTab.querySelector('#sellRedeemAmount');
            const sellRemainingValueElement = activeTab.querySelector('#sellRemainingValue');
            if (sellRedeemAmountElement) {
                sellRedeemAmountElement.value = redeemAmount.toFixed(2);
            }
            if (sellRemainingValueElement) {
                sellRemainingValueElement.value = remainingValue.toFixed(2);
            }

            // æ›´æ–°æŒä»“tabä¸­çš„æ˜¾ç¤º
            if (displayElement) {
                displayElement.textContent = remainingValue.toFixed(2);
            }

            // åˆ¤æ–­æ˜¯å¦ä¸ºå…¨éƒ¨èµå›ï¼ˆå‰©ä½™ä»½é¢æ¥è¿‘0ï¼Œè€ƒè™‘æµ®ç‚¹æ•°ç²¾åº¦ï¼‰
            const isFullRedeem = Math.abs(remainingShares) < 0.0001;

            // è·å–è­¦å‘Šå…ƒç´ 
            const warningElement = activeTab.querySelector('#remainingValueWarning');

            // æ ¹æ®å‰©ä½™å¸‚å€¼å’Œæ˜¯å¦å…¨éƒ¨èµå›æ”¹å˜é¢œè‰²å’ŒèƒŒæ™¯
            if (containerElement) {
                if (isFullRedeem) {
                    // å…¨éƒ¨èµå›ï¼šæ˜¾ç¤ºç»¿è‰²ï¼Œè¡¨ç¤ºæ­£å¸¸
                    displayElement.style.color = '#38a169';
                    displayElement.style.fontWeight = 'bold';
                    containerElement.style.background = '#f0fff4';
                    containerElement.style.border = '2px solid #38a169';
                    // éšè—è­¦å‘Š
                    if (warningElement) warningElement.style.display = 'none';
                } else if (remainingValue < 100) {
                    // éƒ¨åˆ†èµå›ä½†å‰©ä½™å¸‚å€¼å°äº100ä¸‡ï¼šæ˜¾ç¤ºçº¢è‰²è­¦å‘Š
                    displayElement.style.color = '#e53e3e';
                    displayElement.style.fontWeight = 'bold';
                    containerElement.style.background = '#fff5f5';
                    containerElement.style.border = '2px solid #e53e3e';
                    // æ˜¾ç¤ºè­¦å‘Š
                    if (warningElement) {
                        warningElement.style.display = 'block';
                        warningElement.textContent = `âš ï¸ è­¦å‘Šï¼šå‰©ä½™å¸‚å€¼ ${remainingValue.toFixed(2)}ä¸‡å…ƒå°äº100ä¸‡å…ƒï¼éƒ¨åˆ†èµå›æ—¶å‰©ä½™å¸‚å€¼å¿…é¡» â‰¥ 100ä¸‡å…ƒï¼Œè¯·å‡å°‘èµå›ä»½é¢æˆ–é€‰æ‹©å…¨éƒ¨èµå›ã€‚`;
                    }
                } else if (remainingValue >= 100 && remainingValue < 150) {
                    // éƒ¨åˆ†èµå›ä¸”å‰©ä½™å¸‚å€¼åœ¨100-150ä¸‡ä¹‹é—´ï¼šæ˜¾ç¤ºé»„è‰²æç¤º
                    displayElement.style.color = '#d69e2e';
                    displayElement.style.fontWeight = 'bold';
                    containerElement.style.background = '#fffaf0';
                    containerElement.style.border = '2px solid #d69e2e';
                    // éšè—è­¦å‘Š
                    if (warningElement) warningElement.style.display = 'none';
                } else {
                    // éƒ¨åˆ†èµå›ä¸”å‰©ä½™å¸‚å€¼å¤§äº150ä¸‡ï¼šæ˜¾ç¤ºç»¿è‰²
                    displayElement.style.color = '#38a169';
                    displayElement.style.fontWeight = 'bold';
                    containerElement.style.background = '#f0fff4';
                    containerElement.style.border = '2px solid #38a169';
                    // éšè—è­¦å‘Š
                    if (warningElement) warningElement.style.display = 'none';
                }
                containerElement.style.display = 'block';
            }
        }

        // å…¨éƒ¨èµå›
        function redeemAllShares() {
            // æ‰¾åˆ°è°ƒç”¨æ­¤æŒ‰é’®çš„è¡¨å•ä¸­çš„å…ƒç´ 
            const activeElement = document.activeElement;
            const parentForm = activeElement ? activeElement.closest('.card') || activeElement.closest('.form-group') : null;
            
            const currentSharesElement = parentForm ? parentForm.querySelector('#sellCurrentShares') : document.getElementById('sellCurrentShares');
            const redeemSharesElement = parentForm ? parentForm.querySelector('#sellRedeemShares') : document.getElementById('sellRedeemShares');
            
            if (!currentSharesElement) {
                showAlert('æœªæ‰¾åˆ°å½“å‰ä»½é¢è¾“å…¥æ¡†', 'error');
                return;
            }
            
            const currentShares = parseFloat(currentSharesElement.value);
            
            if (!currentShares || currentShares <= 0) {
                showAlert('è¯·å…ˆé€‰æ‹©è¦å–å‡ºçš„äº§å“', 'error');
                return;
            }

            // å¡«å……å½“å‰å…¨éƒ¨ä»½é¢åˆ°èµå›ä»½é¢
            if (redeemSharesElement) {
                redeemSharesElement.value = currentShares;
            }
            
            // è§¦å‘è®¡ç®—å‰©ä½™å¸‚å€¼
            calculateRemainingValue();
            
            showAlert('âœ… å·²è‡ªåŠ¨å¡«å…¥å…¨éƒ¨ä»½é¢ã€‚å…¨éƒ¨èµå›æ—¶æ— å¸‚å€¼é™åˆ¶ï¼Œå¯ç›´æ¥æäº¤ã€‚', 'info');
        }

        // æ·»åŠ å–å‡ºè®¢å•
        function addSellOrder() {
            console.log('=== addSellOrder è¢«è°ƒç”¨ ===');
            
            // ä»å½“å‰æ´»åŠ¨tabä¸­è·å–è¾“å…¥æ¡†
            const activeTab = document.querySelector('.tab-content.active');
            if (!activeTab) {
                console.error('æœªæ‰¾åˆ°æ´»åŠ¨tab');
                return;
            }
            
            console.log('å½“å‰æ´»åŠ¨tab:', activeTab.id);
            
            const productNameElement = activeTab.querySelector('#sellProductName');
            const currentNavElement = activeTab.querySelector('#sellCurrentNav');
            const currentSharesElement = activeTab.querySelector('#sellCurrentShares');
            const redeemSharesElement = activeTab.querySelector('#sellRedeemShares');
            
            console.log('productNameElement:', productNameElement);
            console.log('currentNavElement:', currentNavElement);
            console.log('currentSharesElement:', currentSharesElement);
            console.log('redeemSharesElement:', redeemSharesElement);
            
            const productName = productNameElement ? productNameElement.value : '';
            const currentNav = currentNavElement ? parseFloat(currentNavElement.value) : 0;
            const currentShares = currentSharesElement ? parseFloat(currentSharesElement.value) : 0;
            const redeemShares = redeemSharesElement ? parseFloat(redeemSharesElement.value) : 0;
            
            console.log('è§£æçš„æ•°å€¼:');
            console.log('productName:', productName);
            console.log('currentNav:', currentNav, '(åŸå§‹å€¼:', currentNavElement ? currentNavElement.value : 'N/A', ')');
            console.log('currentShares:', currentShares, '(åŸå§‹å€¼:', currentSharesElement ? currentSharesElement.value : 'N/A', ')');
            console.log('redeemShares:', redeemShares, '(åŸå§‹å€¼:', redeemSharesElement ? redeemSharesElement.value : 'N/A', ')');
            console.log('isNaNæ£€æŸ¥:');
            console.log('currentNav is NaN:', isNaN(currentNav));
            console.log('currentShares is NaN:', isNaN(currentShares));
            console.log('redeemShares is NaN:', isNaN(redeemShares));

            if (!productName || !currentNav || !currentShares || !redeemShares || redeemShares <= 0) {
                showAlert('è¯·å®Œæ•´å¡«å†™å–å‡ºä¿¡æ¯', 'error');
                return;
            }

            if (redeemShares > currentShares) {
                showAlert('èµå›ä»½é¢ä¸èƒ½è¶…è¿‡å½“å‰ä»½é¢', 'error');
                return;
            }

            // æ£€æŸ¥è¯¥äº§å“æ˜¯å¦åœ¨ä¹°å…¥åˆ—è¡¨ä¸­
            const buyOrder = buyOrders.find(o => o.productName === productName);
            if (buyOrder) {
                showAlert(`âŒâš ï¸ è¯¥äº§å“"${productName}"å·²åœ¨ä¹°å…¥åˆ—è¡¨ä¸­ï¼\n\nåŒä¸€ä¸ªäº§å“ä¸èƒ½åŒæ—¶è¿›è¡Œä¹°å…¥å’Œå–å‡ºæ“ä½œã€‚\n\nè¯·å…ˆä»ä¹°å…¥åˆ—è¡¨ä¸­åˆ é™¤è¯¥äº§å“ï¼Œæˆ–é€‰æ‹©å…¶ä»–äº§å“è¿›è¡Œå–å‡ºã€‚`, 'error');
                return;
            }

            // éªŒè¯æ˜¯å¦ä¸ºå·²æŠ•åŸºé‡‘
            const holding = holdings.find(h => h.name === productName && h.category === 'å·²æŠ•åŸºé‡‘');
            if (!holding) {
                showAlert('åªèƒ½å–å‡ºå·²æŠ•åŸºé‡‘', 'error');
                return;
            }

            const remainingShares = currentShares - redeemShares;
            const remainingValue = remainingShares * currentNav;

            // åˆ¤æ–­æ˜¯å¦ä¸ºå…¨éƒ¨èµå›
            const isFullRedeem = Math.abs(remainingShares) < 0.0001;

            // èµå›è§„åˆ™æ ¡éªŒ
            if (!isFullRedeem && remainingValue < 100) {
                // éƒ¨åˆ†èµå›ä¸”å‰©ä½™å¸‚å€¼å°äº100ä¸‡ï¼šç¦æ­¢æ“ä½œ
                showAlert(`âŒâŒâŒ è¿è§„æ“ä½œï¼éƒ¨åˆ†èµå›æ—¶å‰©ä½™å¸‚å€¼éœ€â‰¥100ä¸‡å…ƒï¼\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\näº§å“åç§°ï¼š${productName}\nå½“å‰ä»½é¢ï¼š${currentShares.toFixed(6)} ä¸‡ä»½\nå½“å‰å‡€å€¼ï¼š${currentNav.toFixed(4)}\nå½“å‰å¸‚å€¼ï¼š${(currentShares * currentNav).toFixed(6)} ä¸‡å…ƒ\n\næ‹Ÿèµå›ä»½é¢ï¼š${redeemShares.toFixed(6)} ä¸‡ä»½\nèµå›é‡‘é¢ï¼š${(redeemShares * currentNav).toFixed(6)} ä¸‡å…ƒ\n\nâŒ èµå›åå‰©ä½™å¸‚å€¼ï¼š${remainingValue.toFixed(6)} ä¸‡å…ƒ\nâœ… æœ€å°è¦æ±‚ï¼š100.00 ä¸‡å…ƒ\n\nâŒ å·®é¢ï¼š${(100 - remainingValue).toFixed(6)} ä¸‡å…ƒ\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nğŸš« æ­¤æ“ä½œå·²è¢«é˜»æ­¢ï¼è¯·å‡å°‘èµå›ä»½é¢ï¼Œç¡®ä¿å‰©ä½™å¸‚å€¼â‰¥100ä¸‡å…ƒï¼\n\nğŸ’¡ æç¤ºï¼šå¦‚éœ€å…¨éƒ¨èµå›ï¼Œè¯·ç‚¹å‡»"å…¨éƒ¨èµå›"æŒ‰é’®`, 'error');
                return;
            }

            // å…¨éƒ¨èµå›ï¼šå…è®¸æ“ä½œï¼Œä½†ç»™å‡ºæç¤º
            if (isFullRedeem) {
                console.log('å…¨éƒ¨èµå›æ“ä½œï¼Œå‰©ä½™å¸‚å€¼æ— éœ€â‰¥100ä¸‡å…ƒ');
            }

            const order = {
                id: Date.now(),
                productName: productName,
                currentNav: currentNav,
                currentShares: currentShares,
                redeemShares: redeemShares,
                remainingValue: remainingValue,
                checked: true,
                // æ·»åŠ ç­–ç•¥ç±»å‹å­—æ®µ
                strategyType: holding.strategyType || '',
                assetClass: holding.assetClass || '',
                strategyName: holding.strategyName || ''
            };

            sellOrders.push(order);
            updateSellTable();
            // æ¸…ç©ºèµå›ä»½é¢ï¼Œä½†ä¿ç•™å…¶ä»–ä¿¡æ¯
            if (activeTab) {
                const redeemSharesElement = activeTab.querySelector('#sellRedeemShares');
                if (redeemSharesElement) {
                    redeemSharesElement.value = '';
                }
            }
            showAlert('å–å‡ºäº§å“å·²æ·»åŠ ', 'success');
        }

        // æ¸…ç©ºå–å‡ºè¡¨å•
        function clearSellForm() {
            document.getElementById('sellProductName').value = '';
            document.getElementById('sellCurrentNav').value = '';
            document.getElementById('sellCurrentShares').value = '';
            document.getElementById('sellRedeemShares').value = '';
            // æ¸…ç©ºè°ƒä»“æ“ä½œtabä¸­çš„é¢å¤–å­—æ®µ
            const sellRedeemAmountElement = document.getElementById('sellRedeemAmount');
            const sellRemainingValueElement = document.getElementById('sellRemainingValue');
            if (sellRedeemAmountElement) {
                sellRedeemAmountElement.value = '';
            }
            if (sellRemainingValueElement) {
                sellRemainingValueElement.value = '';
            }
        }

        // æ›´æ–°å–å‡ºè¡¨æ ¼
        function updateSellTable() {
            const tbody = document.getElementById('sellTableBody');
            const emptyState = document.getElementById('sellEmptyState');
            tbody.innerHTML = '';

            if (sellOrders.length === 0) {
                emptyState.style.display = 'block';
                document.getElementById('sellTable').style.display = 'none';
                return;
            }

            emptyState.style.display = 'none';
            document.getElementById('sellTable').style.display = 'table';

            // è°ƒä»“åä¸“æˆ·æ€»å¸‚å€¼ä¿æŒä¸å˜ï¼Œä½¿ç”¨totalMarketValueè®¡ç®—æŠ•åæ¯”ä¾‹
            sellOrders.forEach((order, index) => {
                const percentage = order.checked ? ((order.remainingValue / totalMarketValue) * 100).toFixed(2) : '0.00';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="text-align: center;"><input type="checkbox" ${order.checked ? 'checked' : ''} onchange="toggleSellOrder(${order.id})"></td>
                    <td style="text-align: center;">${order.productName}</td>
                    <td style="text-align: center;" class="input-number">${order.currentNav.toFixed(4)}</td>
                    <td style="text-align: center;" class="input-number">${order.currentShares.toFixed(2)}</td>
                    <td style="text-align: center;" class="input-number">${order.redeemShares.toFixed(2)}</td>
                    <td style="text-align: center;" class="input-number">${order.remainingValue.toFixed(2)}</td>
                    <td style="text-align: center;" class="input-number">${percentage}%</td>
                    <td style="text-align: center;">${validatePercentage(parseFloat(percentage))}</td>
                    <td style="text-align: center;">
                        <button class="btn btn-xs btn-danger" onclick="deleteSellOrder(${order.id})">åˆ é™¤</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // åˆ‡æ¢å–å‡ºè®¢å•é€‰ä¸­çŠ¶æ€
        function toggleSellOrder(id) {
            const order = sellOrders.find(o => o.id === id);
            if (order) {
                order.checked = !order.checked;
                updateSellTable();
            }
        }

        // åˆ é™¤å–å‡ºè®¢å•
        function deleteSellOrder(id) {
            sellOrders = sellOrders.filter(o => o.id !== id);
            updateSellTable();
            showAlert('å–å‡ºäº§å“å·²åˆ é™¤', 'success');
        }

        // æ›´æ–°æŒä»“è¡¨æ ¼ - æ”¯æŒå·²æŠ•åŸºé‡‘ã€å¯æŠ•ç§‘ç›®ã€éœ€æ”¯ä»˜ç§‘ç›®ä¸‰ç§åˆ†ç±»

                function updateHoldingTable() {

                    console.log('=== updateHoldingTable è¢«è°ƒç”¨ ===');

                    

                    // æ›´æ–°å·²æŠ•åŸºé‡‘è¡¨æ ¼

                    const investFundTbody = document.getElementById('investFundTableBody');

                    const investFundEmptyState = document.getElementById('investFundEmptyState');

                    

                    if (investFundTbody) {

                        investFundTbody.innerHTML = '';

                        const investFunds = holdings.filter(h => h.category === 'å·²æŠ•åŸºé‡‘');

                        

                        if (investFunds.length === 0) {

                            if (investFundEmptyState) investFundEmptyState.style.display = 'block';

                            document.getElementById('investFundTable').style.display = 'none';

                        } else {

                            if (investFundEmptyState) investFundEmptyState.style.display = 'none';

                            document.getElementById('investFundTable').style.display = 'table';

                            

                            investFunds.forEach((fund, index) => {

                            

                                                            const row = document.createElement('tr');

                            

                                                            

                            

                                                            // è·å–äº§å“ä¿¡æ¯

                            

                                                            const productCode = fund.productCode || '';

                            

                                                            const isUnmatched = !productCode || productCode === '';

                            

                                                            

                            

                                                            // ä»äº§å“æ± æŸ¥æ‰¾åŒ¹é…çš„äº§å“ä¿¡æ¯

                            

                                                            let matchedProduct = null;

                            

                                                            if (!isUnmatched) {

                            

                                                                matchedProduct = productPool.find(p => p.code === productCode);

                            

                                                            }

                            

                                                            

                            

                                                            // è·å–ä¸‰ä¸ªåˆ†ç±»å­—æ®µ

                            

                                                            const assetClass = matchedProduct ? matchedProduct.assetClass : (fund.assetClass || '');

                            

                                                            const strategyType = matchedProduct ? matchedProduct.strategyType : (fund.strategyType || '');

                            

                                                            const strategyName = matchedProduct ? matchedProduct.strategyName : (fund.strategyName || '');

                            

                                                            

                            

                                                            // æœªåŒ¹é…äº§å“çš„æ˜¾ç¤º
                                                            
                                                                                                                        
                                                            
                                                                                                                        const assetClassText = isUnmatched ? (assetClass || 'æœªåŒ¹é…') : assetClass;
                                                            
                                                                                                                        
                                                            
                                                                                                                        const strategyTypeText = isUnmatched ? (strategyType || 'æœªåŒ¹é…') : strategyType;
                                                            
                                                                                                                        
                                                            
                                                                                                                        const strategyNameText = isUnmatched ? (strategyName || 'æœªåŒ¹é…') : strategyName;
                                                            
                                                                                                                        
                                                            
                                                                                                                        const assetClassColor = isUnmatched && !assetClass ? '#e53e3e' : '';
                                                            
                                                                                                                        
                                                            
                                                                                                                        const strategyTypeColor = isUnmatched && !strategyType ? '#e53e3e' : '';
                                                            
                                                                                                                        
                                                            
                                                                                                                        const strategyNameColor = isUnmatched && !strategyName ? '#e53e3e' : '';
                            

                                                            

                            

                                                            row.innerHTML = `

                            

                                                                <td style="text-align: center; padding: 8px; position: relative; z-index: 1;">${productCode || '-'}</td>

                            

                                                                <td style="padding: 8px; min-width: 200px; position: relative; z-index: 1;">${fund.name}</td>

                            

                                                                <td style="text-align: center; padding: 8px; position: relative; z-index: 1;">

                            

                                                                    ${isUnmatched ? 

                            

                                                                        `<select onchange="updateProductClassification(${index}, 'assetClass', this.value)" style="padding: 4px 8px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 12px; width: 100%; position: relative; z-index: 100;">

                            

                                                                            <option value="">${assetClassText}</option>

                            

                                                                            <option value="è¿›å–ç±»">è¿›å–ç±»</option>

                            

                                                                            <option value="å¹³è¡¡ç±»">å¹³è¡¡ç±»</option>

                            

                                                                            <option value="ç¨³å¥ç±»">ç¨³å¥ç±»</option>

                            

                                                                        </select>` : 

                            

                                                                        `<span style="color: ${assetClassColor};">${assetClassText}</span>`

                            

                                                                    }

                            

                                                                </td>

                            

                                                                <td style="text-align: center; padding: 8px; position: relative; z-index: 1;">

                            

                                                                    ${isUnmatched ? 

                            

                                                                        `<select onchange="updateProductClassification(${index}, 'strategyType', this.value)" style="padding: 4px 8px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 12px; width: 100%; position: relative; z-index: 100;">

                            

                                                                            <option value="">${strategyTypeText}</option>

                            

                                                                            <option value="ä¸»è§‚è‚¡ç¥¨å¤šå¤´">ä¸»è§‚è‚¡ç¥¨å¤šå¤´</option>

                            

                                                                            <option value="é‡åŒ–é€‰è‚¡">é‡åŒ–é€‰è‚¡</option>

                            

                                                                            <option value="CTA">CTA</option>

                            

                                                                            <option value="å®è§‚å¯¹å†²">å®è§‚å¯¹å†²</option>

                            

                                                                            <option value="å¤šç­–ç•¥">å¤šç­–ç•¥</option>

                            

                                                                            <option value="å¸‚åœºä¸­æ€§">å¸‚åœºä¸­æ€§</option>

                            

                                                                            <option value="å€ºåˆ¸">å€ºåˆ¸</option>

                            

                                                                        </select>` : 

                            

                                                                        `<span style="color: ${strategyTypeColor};">${strategyTypeText}</span>`

                            

                                                                    }

                            

                                                                </td>

                            

                                                                <td style="text-align: center; padding: 8px; position: relative; z-index: 1;">

                            

                                                                    ${isUnmatched ? 

                            

                                                                        `<select onchange="updateProductClassification(${index}, 'strategyName', this.value)" style="padding: 4px 8px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 12px; width: 100%; min-width: 200px; position: relative; z-index: 100;">

                            

                                                                            <option value="">${strategyNameText}</option>

                            

                                                                            <option value="è¿›å–ç±»èµ„äº§ï¼ˆä¸»è§‚è‚¡ç¥¨å¤šå¤´ï¼‰">è¿›å–ç±»èµ„äº§ï¼ˆä¸»è§‚è‚¡ç¥¨å¤šå¤´ï¼‰</option>

                            

                                                                            <option value="è¿›å–ç±»èµ„äº§ï¼ˆé‡åŒ–é€‰è‚¡ï¼‰">è¿›å–ç±»èµ„äº§ï¼ˆé‡åŒ–é€‰è‚¡ï¼‰</option>

                            

                                                                            <option value="å¹³è¡¡ç±»èµ„äº§ï¼ˆCTAï¼‰">å¹³è¡¡ç±»èµ„äº§ï¼ˆCTAï¼‰</option>

                            

                                                                            <option value="å¹³è¡¡ç±»èµ„äº§ï¼ˆå®è§‚å¯¹å†²ï¼‰">å¹³è¡¡ç±»èµ„äº§ï¼ˆå®è§‚å¯¹å†²ï¼‰</option>

                            

                                                                            <option value="å¹³è¡¡ç±»èµ„äº§ï¼ˆå¤šç­–ç•¥ï¼‰">å¹³è¡¡ç±»èµ„äº§ï¼ˆå¤šç­–ç•¥ï¼‰</option>

                            

                                                                            <option value="ç¨³å¥ç±»èµ„äº§ï¼ˆå¸‚åœºä¸­æ€§ï¼‰">ç¨³å¥ç±»èµ„äº§ï¼ˆå¸‚åœºä¸­æ€§ï¼‰</option>

                            

                                                                            <option value="ç¨³å¥ç±»èµ„äº§ï¼ˆå€ºåˆ¸ï¼‰">ç¨³å¥ç±»èµ„äº§ï¼ˆå€ºåˆ¸ï¼‰</option>

                            

                                                                        </select>` : 

                            

                                                                        `<span style="color: ${strategyNameColor};">${strategyNameText}</span>`

                            

                                                                    }

                            

                                                                </td>

                            

                                                                <td class="input-number" style="text-align: center; padding: 8px;">${fund.shares ? fund.shares.toFixed(2) : '-'}</td>

                            

                                                                <td class="input-number" style="text-align: center; padding: 8px;">${fund.nav ? fund.nav.toFixed(4) : '-'}</td>

                            

                                                                <td class="input-number" style="text-align: center; padding: 8px;">${fund.marketValue ? fund.marketValue.toFixed(2) : '-'}</td>

                            

                                                                <td class="input-number" style="text-align: center; padding: 8px;">${fund.fundNav ? fund.fundNav.toFixed(2) : '-'}</td>

                            

                                                                <td style="text-align: center; padding: 8px;">

                            

                                                                    <div class="btn-group">

                            

                                                                                                    <button class="btn btn-xs btn-info" onclick="openEditProductNameModal(${index})">ä¿®æ”¹</button>

                            

                                                                                                    <button class="btn btn-xs btn-danger" onclick="deleteHolding(${index})">åˆ é™¤</button>

                            

                                                                                                </div>

                            

                                                                </td>

                            

                                                            `;

                            

                                                            investFundTbody.appendChild(row);

                            

                                                        });

                        }

                    }

                    

                    // æ›´æ–°å¯æŠ•ç§‘ç›®è¡¨æ ¼

                    const investableTbody = document.getElementById('investableTableBody');

                    const investableEmptyState = document.getElementById('investableEmptyState');

                    

                    if (investableTbody) {

                        investableTbody.innerHTML = '';

                        const investableItems = holdings.filter(h => h.category === 'å¯æŠ•ç§‘ç›®');

                        

                        if (investableItems.length === 0) {

                            if (investableEmptyState) investableEmptyState.style.display = 'block';

                            document.getElementById('investableTable').style.display = 'none';

                        } else {

                            if (investableEmptyState) investableEmptyState.style.display = 'none';

                            document.getElementById('investableTable').style.display = 'table';

                            

                            investableItems.forEach(item => {

                                const row = document.createElement('tr');

                                row.innerHTML = `

                                    <td>${item.name}</td>

                                    <td class="input-number" style="text-align: center;">${item.marketValue ? item.marketValue.toFixed(2) : '-'}</td>

                                `;

                                investableTbody.appendChild(row);

                            });

                        }

                    }

                    

                    // æ›´æ–°éœ€æ”¯ä»˜ç§‘ç›®è¡¨æ ¼

                    const payableTbody = document.getElementById('payableTableBody');

                    const payableEmptyState = document.getElementById('payableEmptyState');

                    

                    if (payableTbody) {

                        payableTbody.innerHTML = '';

                        const payableItems = holdings.filter(h => h.category === 'éœ€æ”¯ä»˜ç§‘ç›®');

                        

                        if (payableItems.length === 0) {

                            if (payableEmptyState) payableEmptyState.style.display = 'block';

                            document.getElementById('payableTable').style.display = 'none';

                        } else {

                            if (payableEmptyState) payableEmptyState.style.display = 'none';

                            document.getElementById('payableTable').style.display = 'table';

                            

                            payableItems.forEach(item => {

                                const row = document.createElement('tr');

                                row.innerHTML = `

                                    <td>${item.name}</td>

                                    <td class="input-number" style="text-align: center;">${item.marketValue ? item.marketValue.toFixed(2) : '-'}</td>

                                `;

                                payableTbody.appendChild(row);

                            });

                        }

                    }

                }

        // å¤„ç†æŒä»“æ–‡ä»¶ä¸Šä¼ 
        function handleHoldingFile(input) {
            console.log('=== handleHoldingFile è¢«è°ƒç”¨ ===');
            console.log('input:', input);

                    

                    const file = input.files[0];

                    console.log('é€‰æ‹©çš„æ–‡ä»¶:', file);

                    

                                if (!file) {

                                    console.log('æœªé€‰æ‹©æ–‡ä»¶ï¼Œç›´æ¥è¿”å›');

                                    return;

                                }

                    

                                console.log('å¼€å§‹å¤„ç†æ–‡ä»¶:', file.name);

                                document.getElementById('holdingFileInfo').textContent = `å·²é€‰æ‹©: ${file.name}`;

                                document.getElementById('loading').style.display = 'block';

                                console.log('å·²æ˜¾ç¤ºåŠ è½½åŠ¨ç”»');

                    

                                const reader = new FileReader();
            reader.onload = function(e) {
                console.log('=== FileReader.onload è¢«è°ƒç”¨ ===');
                console.log('æ–‡ä»¶æ•°æ®é•¿åº¦:', e.target.result.byteLength);
                
                const data = new Uint8Array(e.target.result);
                console.log('Uint8Arrayæ•°æ®é•¿åº¦:', data.length);
                
                const workbook = XLSX.read(data, { type: 'array' });
                console.log('è¯»å–åˆ°çš„workbook:', workbook);
                console.log('SheetNames:', workbook.SheetNames);
        
                setTimeout(() => {
                    try {
                        console.log('=== å¼€å§‹å¤„ç†ä¼°å€¼è¡¨æ•°æ® ===');

                        // è§„åˆ™ï¼šåªä½¿ç”¨ç¬¬ä¸€ä¸ªsheet
                        if (workbook.SheetNames.length > 1) {
                            showAlert('æ³¨æ„ï¼šæ–‡ä»¶åŒ…å«' + workbook.SheetNames.length + 'ä¸ªSheetï¼Œå°†åªä½¿ç”¨ç¬¬ä¸€ä¸ªSheet: ' + workbook.SheetNames[0], 'info');
                        }

                        console.log('å‡†å¤‡æå–Sheetæ•°æ®...');
                        const sourceSheets = {};
                        sourceSheets['Sheet1'] = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
                        console.log('æå–åˆ°çš„sourceSheet:', sourceSheets['Sheet1']);
                
                                        // ä½¿ç”¨ä¸æŒä»“æå–å·¥å…·å®Œå…¨ç›¸åŒçš„é€»è¾‘
                                        console.log('è°ƒç”¨applyPresetRules...');
                                        processedData = applyPresetRules(sourceSheets);
                                        console.log('processedData:', processedData);
                        // æ£€æŸ¥æ˜¯å¦æˆåŠŸæå–æ•°æ®
                        if (!processedData) {
                            document.getElementById('loading').style.display = 'none';
                            showAlert('âš ï¸ è­¦å‘Šï¼šæœªæ‰¾åˆ°"åŸºé‡‘èµ„äº§å‡€å€¼"ç§‘ç›®æˆ–å…¶å€¼ä¸º0ï¼è¯·é‡æ–°ä¸Šä¼ æ­£ç¡®çš„ä¼°å€¼è¡¨æ–‡ä»¶ã€‚', 'error');
                            return;
                        }

                        // æ›´æ–°ä¸‰ä¸ªè¡¨æ ¼
                        updateInvestFundTable(processedData['å·²æŠ•åŸºé‡‘éƒ¨åˆ†']);
                        updateInvestableTable(processedData['å¯æŠ•ç§‘ç›®']);
                        updatePayableTable(processedData['éœ€æ”¯ä»˜ç§‘ç›®']);

                        // åŒæ—¶æ›´æ–°holdingsæ•°ç»„ç”¨äºå–å‡ºåŠŸèƒ½
                        updateHoldingsFromProcessedData(processedData);

                        // æ£€æŸ¥æ˜¯å¦æå–åˆ°ä»»ä½•æ•°æ®
                        const hasInvestFunds = processedData['å·²æŠ•åŸºé‡‘éƒ¨åˆ†'] && processedData['å·²æŠ•åŸºé‡‘éƒ¨åˆ†'].length > 0;
                        const hasInvestable = processedData['å¯æŠ•ç§‘ç›®'] && processedData['å¯æŠ•ç§‘ç›®'].length > 0;
                        const hasPayable = processedData['éœ€æ”¯ä»˜ç§‘ç›®'] && processedData['éœ€æ”¯ä»˜ç§‘ç›®'].length > 0;

                        document.getElementById('loading').style.display = 'none';

                        if (!hasInvestFunds && !hasInvestable && !hasPayable) {
                            showAlert('âš ï¸ è­¦å‘Šï¼šä¼°å€¼è¡¨ä¸­æœªæå–åˆ°ä»»ä½•æœ‰æ•ˆæ•°æ®ï¼ˆå·²æŠ•åŸºé‡‘ã€å¯æŠ•ç§‘ç›®ã€éœ€æ”¯ä»˜ç§‘ç›®å‡ä¸ºç©ºï¼‰ã€‚è¯·æ£€æŸ¥ä¼°å€¼è¡¨æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚', 'error');
                            return;
                        }

                        // æ›´æ–°å–å‡ºäº§å“ä¸‹æ‹‰æ¡†
                        updateSellProducts();

                        // æ›´æ–°è°ƒä»“æ“ä½œtabä¸­çš„æŒä»“åˆ†å¸ƒè¡¨
                        showAlert('æŒä»“æ•°æ®å¯¼å…¥æˆåŠŸï¼', 'success');

                        // æå–å¹¶æ˜¾ç¤ºå½“å‰ä¼°å€¼è¡¨çš„äº§å“åç§°
                        const fileName = file.name;
                        // ç§»é™¤æ–‡ä»¶æ‰©å±•å
                        let productName = fileName.replace(/\.(xlsx|xls|XLS|XLSX)$/, '');
                        // ç§»é™¤å¸¸è§çš„æ–‡ä»¶ååç¼€ï¼ˆå¦‚ä¼°å€¼è¡¨ã€ä¼°å€¼ç­‰ï¼‰
                        productName = productName.replace(/ä¼°å€¼è¡¨|ä¼°å€¼|æŒä»“|äº§å“$/g, '').trim();

                        if (productName) {
                            const displayElement = document.getElementById('currentValuationProduct');
                            const nameElement = document.getElementById('currentValuationProductName');
                            nameElement.textContent = productName;
                            displayElement.style.display = 'inline-block';
                        }

                        // å¦‚æœæœ‰å·²æŠ•åŸºé‡‘ï¼Œæ˜¾ç¤º"ä¿®æ”¹äº§å“åŒ¹é…"æŒ‰é’®
                        if (processedData['å·²æŠ•åŸºé‡‘éƒ¨åˆ†'] && processedData['å·²æŠ•åŸºé‡‘éƒ¨åˆ†'].length > 0) {
                            document.getElementById('reMatchBtn').style.display = 'inline-block';
                        }

                        // å¯¼å…¥æˆåŠŸåè‡ªåŠ¨è§¦å‘äº§å“åŒ¹é…
                        if (processedData['å·²æŠ•åŸºé‡‘éƒ¨åˆ†'] && processedData['å·²æŠ•åŸºé‡‘éƒ¨åˆ†'].length > 0) {
                            setTimeout(() => {
                                showProductMatchModal(processedData['å·²æŠ•åŸºé‡‘éƒ¨åˆ†']);
                            }, 500);
                        }
                    } catch (error) {
                        console.error('=== å¤„ç†ä¼°å€¼è¡¨æ—¶å‘ç”Ÿé”™è¯¯ ===');
                        console.error('é”™è¯¯å¯¹è±¡:', error);
                        console.error('é”™è¯¯æ¶ˆæ¯:', error.message);
                        console.error('é”™è¯¯å †æ ˆ:', error.stack);

                        document.getElementById('loading').style.display = 'none';
                        showAlert('å¤„ç†å¤±è´¥ï¼š' + error.message, 'error');
                    }
                }, 500);
            };
            reader.readAsArrayBuffer(file);
        }
        
        // ä½¿ç”¨æŒä»“æå–å·¥å…·çš„é¢„è®¾è§„åˆ™
        function applyPresetRules(sourceSheets) {
            console.log('=== applyPresetRules è¢«è°ƒç”¨ ===');
            console.log('sourceSheets:', sourceSheets);
            
            const result = {};
            const sourceSheet = sourceSheets['Sheet1'];
            console.log('sourceSheet:', sourceSheet);
        
            // æå–åŸºé‡‘èµ„äº§å‡€å€¼ - æŸ¥æ‰¾"åŸºé‡‘èµ„äº§å‡€å€¼"è¡Œ
            let navValue = 0;

            // å…ˆæ‰¾åˆ°è¡¨å¤´ï¼Œç¡®å®š"å¸‚å€¼"å’Œ"å¸‚ä»·"åˆ—çš„ä½ç½®
            let marketValueColIndex = -1;
            let marketPriceColIndex = -1;
            sourceSheet.forEach((row, index) => {
                if (row[0] === 'ç§‘ç›®ä»£ç ' && row[1] === 'ç§‘ç›®åç§°') {
                    marketValueColIndex = row.indexOf('å¸‚å€¼');
                    marketPriceColIndex = row.indexOf('å¸‚ä»·');
                }
            });

            // å¦‚æœæ‰¾ä¸åˆ°å¸‚å€¼åˆ—ï¼Œé»˜è®¤ä½¿ç”¨ç¬¬8åˆ—ï¼ˆç´¢å¼•7ï¼‰
            if (marketValueColIndex === -1) {
                marketValueColIndex = 7;
            }

            // å¦‚æœæ‰¾ä¸åˆ°å¸‚ä»·åˆ—ï¼Œé»˜è®¤ä½¿ç”¨ç¬¬7åˆ—ï¼ˆç´¢å¼•6ï¼‰
            if (marketPriceColIndex === -1) {
                marketPriceColIndex = 6;
            }

            console.log('å¸‚å€¼åˆ—ç´¢å¼•:', marketValueColIndex, 'å¸‚ä»·åˆ—ç´¢å¼•:', marketPriceColIndex);

            // è¾…åŠ©å‡½æ•°ï¼šæå–å¸‚å€¼æ•°å€¼ï¼Œå¤„ç†å¤šç§æ ¼å¼
            function extractMarketValue(cell) {
                if (cell === null || cell === undefined) return 0;
                if (typeof cell === 'number') return cell;
                if (typeof cell === 'string') {
                    // å°è¯•è§£æå­—ç¬¦ä¸²
                    const parsed = parseFloat(cell);
                    if (!isNaN(parsed)) return parsed;
                }
                if (typeof cell === 'object') {
                    // å¦‚æœæ˜¯å¯¹è±¡ï¼Œå°è¯•æå–å¸¸è§çš„æ•°å€¼å±æ€§
                    if (cell.v !== undefined && typeof cell.v === 'number') return cell.v;
                    if (cell.w !== undefined) {
                        const parsed = parseFloat(cell.w);
                        if (!isNaN(parsed)) return parsed;
                    }
                    // å°è¯•æ‰€æœ‰å±æ€§
                    for (let key in cell) {
                        const val = cell[key];
                        if (typeof val === 'number') return val;
                        if (typeof val === 'string') {
                            const parsed = parseFloat(val);
                            if (!isNaN(parsed)) return parsed;
                        }
                    }
                }
                return 0;
            }

            // è¾…åŠ©å‡½æ•°ï¼šæå–äº§å“åç§°ï¼Œå¤„ç†å¤šç§æ ¼å¼
            function extractProductName(cell) {
                if (cell === null || cell === undefined) return '';
                if (typeof cell === 'string') return cell.trim();
                if (typeof cell === 'object') {
                    // å¦‚æœæ˜¯å¯¹è±¡ï¼Œå°è¯•æå–å¸¸è§çš„æ–‡æœ¬å±æ€§
                    if (cell.v !== undefined && typeof cell.v === 'string') return cell.v.trim();
                    if (cell.w !== undefined && typeof cell.w === 'string') return cell.w.trim();
                    if (cell.m !== undefined && typeof cell.m === 'string') return cell.m.trim();
                    // å°è¯•æ‰€æœ‰å±æ€§
                    for (let key in cell) {
                        const val = cell[key];
                        if (typeof val === 'string' && val) return val.trim();
                    }
                }
                return '';
            }

            // æŸ¥æ‰¾"åŸºé‡‘èµ„äº§å‡€å€¼"è¡Œå¹¶æå–å…¶å¸‚å€¼
            sourceSheet.forEach((row, index) => {
                // åœ¨æ•´è¡Œä¸­æŸ¥æ‰¾"åŸºé‡‘èµ„äº§å‡€å€¼"å­—ç¬¦ä¸²
                let foundNav = false;
                for (let col = 0; col < row.length; col++) {
                    const cellValue = row[col] ? row[col].toString() : '';
                    if (cellValue.includes('åŸºé‡‘èµ„äº§å‡€å€¼')) {
                        foundNav = true;
                        console.log('åœ¨ç¬¬', index, 'è¡Œç¬¬', col, 'åˆ—æ‰¾åˆ°"åŸºé‡‘èµ„äº§å‡€å€¼"');
                        break;
                    }
                }
                
                if (foundNav && marketValueColIndex >= 0 && marketValueColIndex < row.length) {
                    navValue = extractMarketValue(row[marketValueColIndex]);
                    console.log('æ‰¾åˆ°åŸºé‡‘èµ„äº§å‡€å€¼è¡Œï¼Œè¡Œå·:', index, 'å¸‚å€¼åˆ—ç´¢å¼•:', marketValueColIndex, 'å¸‚å€¼:', navValue);
                }
            });
        
            const navInWan = navValue / 10000;
        
            // éªŒè¯åŸºé‡‘èµ„äº§å‡€å€¼æ˜¯å¦æå–æˆåŠŸ
            if (navValue === 0) {
                console.log('åŸºé‡‘èµ„äº§å‡€å€¼ä¸º0ï¼Œè¿”å›undefined');
                return undefined; // è¿”å›undefinedï¼Œè®©è°ƒç”¨æ–¹å¤„ç†
            }
        
            // åŸºé‡‘èµ„äº§å‡€å€¼ä¸ä¸º0ï¼Œç»§ç»­è¿›è¡Œä¼°å€¼è¡¨å’Œäº§å“æ± çš„æ ¡éªŒ
            console.log('åŸºé‡‘èµ„äº§å‡€å€¼éªŒè¯é€šè¿‡ï¼Œå€¼ä¸ºï¼š', navInWan, 'ä¸‡å…ƒ');
        
            // å¤„ç†å·²æŠ•åŸºé‡‘éƒ¨åˆ†
            const å·²æŠ•åŸºé‡‘éƒ¨åˆ† = [];
            let index = 1;
            let scannedCodes = []; // è®°å½•æ‰«æåˆ°çš„ç§‘ç›®ä»£ç 

            sourceSheet.forEach(row => {
                const code = String(row[0] || '');
                const name = extractProductName(row[1]);
                const quantity = row[2] || 0;
                const price = row[marketPriceColIndex] || 0;
                const marketValue = extractMarketValue(row[marketValueColIndex]);

                // è®°å½•æ‰«æåˆ°çš„ç§‘ç›®ä»£ç ï¼ˆç”¨äºè°ƒè¯•ï¼‰
                if (code && code !== 'ç§‘ç›®ä»£ç ') {
                    scannedCodes.push({ code, name, marketValue });
                }

                // ç­›é€‰ç§å‹ŸåŸºé‡‘äº§å“ (ç§‘ç›®ä»£ç ä»¥11090601å¼€å¤´ï¼Œä¸”ä¸æ˜¯æ±‡æ€»è¡Œï¼Œä¸”ä¸æ˜¯"å…¶ä»–æŠ•èµ„_ç§å‹Ÿç†è´¢äº§å“æˆæœ¬")
                if (code.match(/^11090601[A-Z0-9]*$/) && !code.includes('99') && name && name !== 'ç§‘ç›®åç§°' && 
                    !name.includes('å…¶ä»–æŠ•èµ„_ç§å‹Ÿç†è´¢äº§å“æˆæœ¬') && !name.includes('å…¶ä»–æŠ•èµ„') && 
                    !name.includes('ç§å‹Ÿç†è´¢äº§å“æˆæœ¬') && !name.includes('æˆæœ¬') && 
                    !name.includes('æ±‡æ€»') && !name.includes('åˆè®¡') && marketValue > 0) {
                    
                    // åŸå§‹ä¼°å€¼è¡¨çš„ä»½é¢å•ä½ç»Ÿä¸€ä¸º"ä»½"ï¼Œç›´æ¥è½¬æ¢ä¸ºä¸‡ä»½
                    const sharesInWan = quantity / 10000;
                    
                    // ç‰¹æ®Šè°ƒè¯•ï¼šé’ˆå¯¹"æ˜æ±¯è‚¡ç¥¨ç²¾é€‰13æœŸ"
                    if (name.includes('æ˜æ±¯è‚¡ç¥¨ç²¾é€‰13æœŸ')) {
                        console.log('========================================');
                        console.log('ã€æ˜æ±¯è‚¡ç¥¨ç²¾é€‰13æœŸã€‘æ•°æ®å¤„ç†:');
                        console.log('========================================');
                        console.log(`åŸå§‹ä»½é¢: ${quantity} ä»½`);
                        console.log(`å‡€å€¼: ${price} å…ƒ/ä»½`);
                        console.log(`åŸå§‹å¸‚å€¼: ${marketValue} å…ƒ`);
                        console.log(`è½¬æ¢åä»½é¢: ${sharesInWan.toFixed(2)} ä¸‡ä»½`);
                        console.log(`è½¬æ¢åå¸‚å€¼: ${(marketValue / 10000).toFixed(2)} ä¸‡å…ƒ`);
                        console.log(`è®¡ç®—å¸‚å€¼éªŒè¯: ${(sharesInWan * price).toFixed(2)} ä¸‡å…ƒ`);
                        console.log('========================================');
                    }
                    
                    å·²æŠ•åŸºé‡‘éƒ¨åˆ†.push({
                        'æ ‡çš„åŸºé‡‘èµ„äº§': index,
                        'äº§å“ä»£ç ': '',
                        'äº§å“åç§°ï¼ˆå«ä»½é¢ç±»åˆ«ï¼‰': name,
                        'å½“å‰ä»½é¢': sharesInWan,
                        'æ ‡çš„å‡€å€¼': price,
                        'å¸‚å€¼': marketValue / 10000,
                        'åŸºé‡‘èµ„äº§å‡€å€¼': navInWan,
                        'èµ„äº§ç±»åˆ«': '',
                        'ç­–ç•¥ç±»å‹': '',
                        'äº§å“ç­–ç•¥': '',
                        'å·²åŒ¹é…': false,
                        'åŸå§‹äº§å“åç§°': ''
                    });
                    index++;
                    console.log('åŒ¹é…åˆ°å·²æŠ•åŸºé‡‘:', code, name, 'ä»½é¢:', sharesInWan.toFixed(2), 'ä¸‡ä»½, å¸‚å€¼:', marketValue / 10000, 'ä¸‡å…ƒ');
                }
            });

            console.log('æ‰«æåˆ°çš„ç§‘ç›®ä»£ç æ•°é‡:', scannedCodes.length);
            console.log('åŒ¹é…åˆ°çš„å·²æŠ•åŸºé‡‘æ•°é‡:', å·²æŠ•åŸºé‡‘éƒ¨åˆ†.length);
            if (å·²æŠ•åŸºé‡‘éƒ¨åˆ†.length === 0) {
                console.log('æœªåŒ¹é…åˆ°å·²æŠ•åŸºé‡‘ï¼Œæ‰«æçš„éƒ¨åˆ†ä»£ç :', scannedCodes.slice(0, 10));
            }

            result['å·²æŠ•åŸºé‡‘éƒ¨åˆ†'] = å·²æŠ•åŸºé‡‘éƒ¨åˆ†;

            // å¤„ç†å¯æŠ•ç§‘ç›®
            const å¯æŠ•ç§‘ç›® = [];
            let æ´»æœŸå­˜æ¬¾å¸‚å€¼ = 0;
            let è´§å¸åŸºé‡‘å¸‚å€¼ = 0;

            // æå–æ´»æœŸå­˜æ¬¾å¸‚å€¼ï¼ˆç§‘ç›®ä»£ç ä¸º10020102ï¼‰
                        sourceSheet.forEach(row => {
                            const code = String(row[0] || '');
                            if (code === '10020102') {
                                æ´»æœŸå­˜æ¬¾å¸‚å€¼ = extractMarketValue(row[marketValueColIndex]);
                            }
                        });

                        // æå–è´§å¸åŸºé‡‘å¸‚å€¼ï¼ˆç§‘ç›®åç§°åŒ…å«"è´§å¸"ï¼‰
                        sourceSheet.forEach(row => {
                            const name = String(row[1] || '');
                            const marketValue = extractMarketValue(row[marketValueColIndex]);
                            if (name.includes('è´§å¸') && marketValue > 0) {
                                è´§å¸åŸºé‡‘å¸‚å€¼ += marketValue;
                            }
                        });        
            // æ·»åŠ æ´»æœŸå­˜æ¬¾
            å¯æŠ•ç§‘ç›®.push({
                'å¯æŠ•ç§‘ç›®': 1,
                'åˆ†ç±»': 'æ´»æœŸå­˜æ¬¾',
                'å¸‚å€¼': æ´»æœŸå­˜æ¬¾å¸‚å€¼ / 10000,
                'åŸºé‡‘èµ„äº§å‡€å€¼': navInWan
            });
        
            // æ·»åŠ è´§å¸åŸºé‡‘
            å¯æŠ•ç§‘ç›®.push({
                'å¯æŠ•ç§‘ç›®': 2,
                'åˆ†ç±»': 'è´§å¸åŸºé‡‘',
                'å¸‚å€¼': è´§å¸åŸºé‡‘å¸‚å€¼ / 10000,
                'åŸºé‡‘èµ„äº§å‡€å€¼': navInWan
            });
        
            result['å¯æŠ•ç§‘ç›®'] = å¯æŠ•ç§‘ç›®;
        
            // å¤„ç†éœ€æ”¯ä»˜ç§‘ç›®
            const éœ€æ”¯ä»˜ç§‘ç›® = [];
            const éœ€æ”¯ä»˜ç§‘ç›®æ˜ å°„ = {
                '2205': 'åº”ä»˜å¤–åŒ…æœåŠ¡è´¹',
                '2206': 'åº”ä»˜ç®¡ç†äººæŠ¥é…¬',
                '2207': 'åº”ä»˜æ‰˜ç®¡è´¹'
            };
        
            index = 1;
                        sourceSheet.forEach(row => {
                            const code = String(row[0] || '');
                            const marketValue = extractMarketValue(row[marketValueColIndex]);
            
                            // æ£€æŸ¥æ˜¯å¦ä¸ºéœ€æ”¯ä»˜ç§‘ç›®ï¼ŒåªåŒ¹é…4ä½ç§‘ç›®ä»£ç 
                            if (éœ€æ”¯ä»˜ç§‘ç›®æ˜ å°„[code]) {
                                const category = éœ€æ”¯ä»˜ç§‘ç›®æ˜ å°„[code];
                                éœ€æ”¯ä»˜ç§‘ç›®.push({
                                    'éœ€æ”¯ä»˜ç§‘ç›®': index,
                                    'åˆ†ç±»': category,
                                    'å¸‚å€¼': marketValue / 10000,
                                    'åŸºé‡‘èµ„äº§å‡€å€¼': navInWan
                                });
                                index++;
                            }
                        });        
            result['éœ€æ”¯ä»˜ç§‘ç›®'] = éœ€æ”¯ä»˜ç§‘ç›®;
        
            return result;
        }
        
        // æ›´æ–°å·²æŠ•åŸºé‡‘è¡¨æ ¼
        function updateInvestFundTable(data) {
            const tbody = document.getElementById('investFundTableBody');
            const emptyState = document.getElementById('investFundEmptyState');
            tbody.innerHTML = '';

            if (!data || data.length === 0) {
                emptyState.style.display = 'block';
                document.getElementById('investFundTable').style.display = 'none';
                return;
            }

            emptyState.style.display = 'none';
            document.getElementById('investFundTable').style.display = 'table';

            data.forEach((row, index) => {
                const tr = document.createElement('tr');
                
                // è·å–äº§å“ä¿¡æ¯
                const productCode = row['äº§å“ä»£ç '] || '';
                const productName = row['äº§å“åç§°ï¼ˆå«ä»½é¢ç±»åˆ«ï¼‰'];
                const isUnmatched = !productCode || productCode === '';
                
                // ä»äº§å“æ± æŸ¥æ‰¾åŒ¹é…çš„äº§å“ä¿¡æ¯
                let matchedProduct = null;
                if (!isUnmatched) {
                    matchedProduct = productPool.find(p => p.code === productCode);
                }
                
                // è·å–ä¸‰ä¸ªåˆ†ç±»å­—æ®µ
                const assetClass = matchedProduct ? matchedProduct.assetClass : (row['èµ„äº§ç±»åˆ«'] || '');
                const strategyType = matchedProduct ? matchedProduct.strategyType : (row['ç­–ç•¥ç±»å‹'] || '');
                const strategyName = matchedProduct ? matchedProduct.strategyName : (row['äº§å“ç­–ç•¥'] || '');
                
                // æœªåŒ¹é…äº§å“çš„æ˜¾ç¤º
                const assetClassText = isUnmatched ? (assetClass || 'æœªåŒ¹é…') : assetClass;
                const strategyTypeText = isUnmatched ? (strategyType || 'æœªåŒ¹é…') : strategyType;
                const strategyNameText = isUnmatched ? (strategyName || 'æœªåŒ¹é…') : strategyName;
                const assetClassColor = isUnmatched && !assetClass ? '#e53e3e' : '';
                const strategyTypeColor = isUnmatched && !strategyType ? '#e53e3e' : '';
                const strategyNameColor = isUnmatched && !strategyName ? '#e53e3e' : '';
                
                tr.innerHTML = `
                    <td style="text-align: center; padding: 8px; position: relative; z-index: 1;">${productCode || '-'}</td>
                    <td style="padding: 8px; min-width: 200px; position: relative; z-index: 1;">${productName}</td>
                    <td style="text-align: center; padding: 8px; position: relative; z-index: 1;">
                        ${isUnmatched ? 
                            `<select onchange="updateProductClassification(${index}, 'assetClass', this.value)" style="padding: 4px 8px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 12px; width: 100%; position: relative; z-index: 100;">
                                <option value="">${assetClassText}</option>
                                <option value="è¿›å–ç±»">è¿›å–ç±»</option>
                                <option value="å¹³è¡¡ç±»">å¹³è¡¡ç±»</option>
                                <option value="ç¨³å¥ç±»">ç¨³å¥ç±»</option>
                            </select>` : 
                            `<span style="color: ${assetClassColor};">${assetClassText}</span>`
                        }
                    </td>
                    <td style="text-align: center; padding: 8px; position: relative; z-index: 1;">
                        ${isUnmatched ? 
                            `<select onchange="updateProductClassification(${index}, 'strategyType', this.value)" style="padding: 4px 8px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 12px; width: 100%; position: relative; z-index: 100;">
                                <option value="">${strategyTypeText}</option>
                                <option value="ä¸»è§‚è‚¡ç¥¨å¤šå¤´">ä¸»è§‚è‚¡ç¥¨å¤šå¤´</option>
                                <option value="é‡åŒ–é€‰è‚¡">é‡åŒ–é€‰è‚¡</option>
                                <option value="CTA">CTA</option>
                                <option value="å®è§‚å¯¹å†²">å®è§‚å¯¹å†²</option>
                                <option value="å¤šç­–ç•¥">å¤šç­–ç•¥</option>
                                <option value="å¸‚åœºä¸­æ€§">å¸‚åœºä¸­æ€§</option>
                                <option value="å€ºåˆ¸">å€ºåˆ¸</option>
                            </select>` : 
                            `<span style="color: ${strategyTypeColor};">${strategyTypeText}</span>`
                        }
                    </td>
                    <td style="text-align: center; padding: 8px; position: relative; z-index: 1;">
                        ${isUnmatched ? 
                            `<select onchange="updateProductClassification(${index}, 'strategyName', this.value)" style="padding: 4px 8px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 12px; width: 100%; min-width: 200px; position: relative; z-index: 100;">
                                <option value="">${strategyNameText}</option>
                                <option value="è¿›å–ç±»èµ„äº§ï¼ˆä¸»è§‚è‚¡ç¥¨å¤šå¤´ï¼‰">è¿›å–ç±»èµ„äº§ï¼ˆä¸»è§‚è‚¡ç¥¨å¤šå¤´ï¼‰</option>
                                <option value="è¿›å–ç±»èµ„äº§ï¼ˆé‡åŒ–é€‰è‚¡ï¼‰">è¿›å–ç±»èµ„äº§ï¼ˆé‡åŒ–é€‰è‚¡ï¼‰</option>
                                <option value="å¹³è¡¡ç±»èµ„äº§ï¼ˆCTAï¼‰">å¹³è¡¡ç±»èµ„äº§ï¼ˆCTAï¼‰</option>
                                <option value="å¹³è¡¡ç±»èµ„äº§ï¼ˆå®è§‚å¯¹å†²ï¼‰">å¹³è¡¡ç±»èµ„äº§ï¼ˆå®è§‚å¯¹å†²ï¼‰</option>
                                <option value="å¹³è¡¡ç±»èµ„äº§ï¼ˆå¤šç­–ç•¥ï¼‰">å¹³è¡¡ç±»èµ„äº§ï¼ˆå¤šç­–ç•¥ï¼‰</option>
                                <option value="ç¨³å¥ç±»èµ„äº§ï¼ˆå¸‚åœºä¸­æ€§ï¼‰">ç¨³å¥ç±»èµ„äº§ï¼ˆå¸‚åœºä¸­æ€§ï¼‰</option>
                                <option value="ç¨³å¥ç±»èµ„äº§ï¼ˆå€ºåˆ¸ï¼‰">ç¨³å¥ç±»èµ„äº§ï¼ˆå€ºåˆ¸ï¼‰</option>
                            </select>` : 
                            `<span style="color: ${strategyNameColor};">${strategyNameText}</span>`
                        }
                    </td>
                    <td style="text-align: center; padding: 8px;">${row['å½“å‰ä»½é¢'].toFixed(2)}</td>
                    <td style="text-align: center; padding: 8px;">${row['æ ‡çš„å‡€å€¼'].toFixed(4)}</td>
                    <td style="text-align: center; padding: 8px;">${row['å¸‚å€¼'].toFixed(2)}</td>
                    <td style="text-align: center; padding: 8px;">${row['åŸºé‡‘èµ„äº§å‡€å€¼'].toFixed(2)}</td>
                    <td style="text-align: center; padding: 8px;">
                        <button class="btn btn-xs btn-info" onclick="openEditProductNameModal(${index})">ä¿®æ”¹</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // æ›´æ–°å¯æŠ•ç§‘ç›®è¡¨æ ¼
        function updateInvestableTable(data) {
            const tbody = document.getElementById('investableTableBody');
            const emptyState = document.getElementById('investableEmptyState');
            tbody.innerHTML = '';

            if (!data || data.length === 0) {
                emptyState.style.display = 'block';
                document.getElementById('investableTable').style.display = 'none';
                return;
            }

            emptyState.style.display = 'none';
            document.getElementById('investableTable').style.display = 'table';

            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="text-align: center;">${row['åˆ†ç±»']}</td>
                    <td style="text-align: center;">${row['å¸‚å€¼'].toFixed(2)}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // æ›´æ–°éœ€æ”¯ä»˜ç§‘ç›®è¡¨æ ¼
        function updatePayableTable(data) {
            const tbody = document.getElementById('payableTableBody');
            const emptyState = document.getElementById('payableEmptyState');
            tbody.innerHTML = '';

            if (!data || data.length === 0) {
                emptyState.style.display = 'block';
                document.getElementById('payableTable').style.display = 'none';
                return;
            }

            emptyState.style.display = 'none';
            document.getElementById('payableTable').style.display = 'table';

            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="text-align: center;">${row['åˆ†ç±»']}</td>
                    <td style="text-align: center;">${row['å¸‚å€¼'].toFixed(2)}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // æ›´æ–°å¯æŠ•èµ„é‡‘é¢æ˜¾ç¤º
function updateAvailableInvestAmount() {
    const buyLimitElement = document.getElementById('buyLimitAmount');
    const remainingBuyElement = document.getElementById('remainingBuyAmount');
    const containerElement = document.getElementById('remainingBuyAmountDisplay');
    
    if (buyLimitElement && remainingBuyElement) {
        if (hasImportedHoldings) {
            buyLimitElement.textContent = investableAmount.toFixed(2);
            if (investableAmount < 0) {
                buyLimitElement.style.color = '#e53e3e';
                buyLimitElement.style.fontWeight = 'bold';
            } else {
                buyLimitElement.style.color = '#667eea';
                buyLimitElement.style.fontWeight = 'bold';
            }
            calculateRemainingBuyAmount(); // æ›´æ–°åé‡æ–°è®¡ç®—å‰©ä½™é‡‘é¢
        } else {
            buyLimitElement.textContent = '0.00';
            buyLimitElement.style.color = '#667eea';
            buyLimitElement.style.fontWeight = 'bold';
            remainingBuyElement.textContent = '--';
            containerElement.style.background = '#f7fafc';
            containerElement.style.border = 'none';
        }
    }
}

// å®æ—¶è®¡ç®—å‰©ä½™å¯æŠ•é‡‘é¢
function calculateRemainingBuyAmount() {
    // ä»å½“å‰æ´»åŠ¨tabä¸­è·å–è¾“å…¥æ¡†
    const activeTab = document.querySelector('.tab-content.active');
    if (!activeTab) {
        console.error('æœªæ‰¾åˆ°æ´»åŠ¨tab');
        return;
    }
    
    const buyAmountElement = activeTab.querySelector('#buyAmount');
    const displayElement = activeTab.querySelector('#remainingBuyAmount');
    const containerElement = activeTab.querySelector('#remainingBuyAmountDisplay');
    
    if (!buyAmountElement || !displayElement || !containerElement) {
        console.error('æœªæ‰¾åˆ°å¿…è¦çš„å…ƒç´ ');
        return;
    }
    
    const buyAmount = parseFloat(buyAmountElement.value);
    
    if (!hasImportedHoldings) {
        displayElement.textContent = '--';
        containerElement.style.background = '#f7fafc';
        containerElement.style.border = 'none';
        return;
    }
    
    if (isNaN(buyAmount) || buyAmount < 0) {
        displayElement.textContent = investableAmount.toFixed(2);
        containerElement.style.background = '#f7fafc';
        containerElement.style.border = 'none';
        return;
    }
    
    // è®¡ç®—å½“å‰å·²å‹¾é€‰çš„ä¹°å…¥æ€»é‡‘é¢ï¼ˆæ’é™¤å½“å‰æ­£åœ¨ç¼–è¾‘çš„äº§å“ï¼‰
    const currentProductNameElement = activeTab.querySelector('#buyProductName');
    const currentProductName = currentProductNameElement ? currentProductNameElement.value : '';
    
    const currentCheckedBuyAmount = buyOrders.filter(o => o.checked && o.productName !== currentProductName).reduce((sum, o) => sum + o.amount, 0);
    const totalCheckedBuyAmount = currentCheckedBuyAmount + buyAmount;
    const remainingAmount = investableAmount - totalCheckedBuyAmount;
    
    displayElement.textContent = remainingAmount.toFixed(2);
    
    // æ ¹æ®å‰©ä½™é‡‘é¢æ”¹å˜é¢œè‰²å’ŒèƒŒæ™¯
    if (remainingAmount < 0) {
        displayElement.style.color = '#e53e3e';
        displayElement.style.fontWeight = 'bold';
        containerElement.style.background = '#fff5f5';
        containerElement.style.border = '2px solid #e53e3e';
    } else if (remainingAmount >= 0 && remainingAmount < investableAmount * 0.1) {
        displayElement.style.color = '#d69e2e';
        displayElement.style.fontWeight = 'bold';
        containerElement.style.background = '#fffaf0';
        containerElement.style.border = '2px solid #d69e2e';
    } else {
        displayElement.style.color = '#38a169';
        displayElement.style.fontWeight = 'bold';
        containerElement.style.background = '#f0fff4';
        containerElement.style.border = '2px solid #38a169';
    }
}

// ä»å¤„ç†åçš„æ•°æ®æ›´æ–°holdingsæ•°ç»„ï¼ˆç”¨äºå–å‡ºåŠŸèƒ½ï¼‰

        

        function updateHoldingsFromProcessedData(processedData) {

        

            console.log('=== updateHoldingsFromProcessedData è¢«è°ƒç”¨ ===');

            console.log('processedData:', processedData);

        

            holdings = [];

        

        

        

            hasImportedHoldings = true; // æ ‡è®°å·²å¯¼å…¥æŒä»“æ•°æ®

        

        

        

        

        

            // è®¡ç®—å¯æŠ•ç§‘ç›®å’Œéœ€æ”¯ä»˜ç§‘ç›®çš„æ€»é‡‘é¢

        

        

        

            let totalInvestable = 0;

        

        

        

            let totalPayable = 0;

        

        

        

            // è·å–åŸºé‡‘èµ„äº§å‡€å€¼ï¼ˆä»å·²æŠ•åŸºé‡‘ã€å¯æŠ•ç§‘ç›®æˆ–éœ€æ”¯ä»˜ç§‘ç›®ä¸­ä»»ä¸€ä¸ªè·å–ï¼‰

        

        

        

            if (processedData['å·²æŠ•åŸºé‡‘éƒ¨åˆ†'] && processedData['å·²æŠ•åŸºé‡‘éƒ¨åˆ†'].length > 0) {

        

        

        

                fundAssetValue = processedData['å·²æŠ•åŸºé‡‘éƒ¨åˆ†'][0]['åŸºé‡‘èµ„äº§å‡€å€¼'];

        

        

        

            } else if (processedData['å¯æŠ•ç§‘ç›®'] && processedData['å¯æŠ•ç§‘ç›®'].length > 0) {

        

        

        

                fundAssetValue = processedData['å¯æŠ•ç§‘ç›®'][0]['åŸºé‡‘èµ„äº§å‡€å€¼'];

        

        

        

            } else if (processedData['éœ€æ”¯ä»˜ç§‘ç›®'] && processedData['éœ€æ”¯ä»˜ç§‘ç›®'].length > 0) {

        

        

        

                fundAssetValue = processedData['éœ€æ”¯ä»˜ç§‘ç›®'][0]['åŸºé‡‘èµ„äº§å‡€å€¼'];

        

        

        

            }

        

        

        

            console.log('åŸºé‡‘èµ„äº§å‡€å€¼:', fundAssetValue);

        

        

        

            // åŒæ­¥åŸºé‡‘èµ„äº§å‡€å€¼åˆ°ä¸“æˆ·æ€»å¸‚å€¼

        

        

        

            if (fundAssetValue > 0) {

        

        

        

                totalMarketValue = fundAssetValue;

        

        

        

                document.getElementById('totalMarketValue').value = totalMarketValue.toFixed(2);

        

        

        

                showAlert(`å·²åŒæ­¥åŸºé‡‘èµ„äº§å‡€å€¼åˆ°ä¸“æˆ·æ€»å¸‚å€¼ï¼š${totalMarketValue.toFixed(2)} ä¸‡å…ƒ`, 'success');

        

        

        

            }

        

        

        

            // æ·»åŠ å·²æŠ•åŸºé‡‘åˆ°holdings

        

        

        

        

                        if (processedData['å·²æŠ•åŸºé‡‘éƒ¨åˆ†']) {

        

        

        

                            processedData['å·²æŠ•åŸºé‡‘éƒ¨åˆ†'].forEach(item => {

        

        

        

                                const calculatedMarketValue = item['å½“å‰ä»½é¢'] * item['æ ‡çš„å‡€å€¼'];

        

        

        

        

        

        

        

                                console.log(`[holdings] ${item['äº§å“åç§°ï¼ˆå«ä»½é¢ç±»åˆ«ï¼‰']}: ä»½é¢=${item['å½“å‰ä»½é¢'].toFixed(2)}ä¸‡ä»½, å‡€å€¼=${item['æ ‡çš„å‡€å€¼']}, è®¡ç®—å¸‚å€¼=${calculatedMarketValue.toFixed(2)}ä¸‡å…ƒ, å®é™…å¸‚å€¼=${item['å¸‚å€¼'].toFixed(2)}ä¸‡å…ƒ`);

        

        

        

        

        

        

        

                                holdings.push({

        

        

        

                                    name: item['äº§å“åç§°ï¼ˆå«ä»½é¢ç±»åˆ«ï¼‰'],

        

        

        

                                    shares: item['å½“å‰ä»½é¢'],

        

        

        

                                    nav: item['æ ‡çš„å‡€å€¼'],

        

        

        

                                    marketValue: item['å¸‚å€¼'], // ç›´æ¥ä½¿ç”¨ä¼°å€¼è¡¨ä¸­çš„å¸‚å€¼

        

        

        

        

        

        

                                    category: 'å·²æŠ•åŸºé‡‘',

        

        

        

                                    index: item['æ ‡çš„åŸºé‡‘èµ„äº§'],

        

        

        

                                    fundNav: item['åŸºé‡‘èµ„äº§å‡€å€¼'],

        

        

        

                                    // åˆå§‹åŒ–ç­–ç•¥ç±»å‹å­—æ®µ

        

        

        

                                    assetClass: item['èµ„äº§ç±»åˆ«'] || '',

        

        

        

                                    strategyType: item['ç­–ç•¥ç±»å‹'] || '',

        

        

        

                                    strategyName: item['äº§å“ç­–ç•¥'] || '',

        

        

        

                                    productCode: item['äº§å“ä»£ç '] || '',

        

        

        

                                    matched: item['å·²åŒ¹é…'] || false,

        

        

        

                                    originalName: item['åŸå§‹äº§å“åç§°'] || ''

        

        

        

                                });

        

        

        

                            });

        

        

        

                        }

        

        

        

            // æ·»åŠ å¯æŠ•ç§‘ç›®åˆ°holdingså¹¶è®¡ç®—æ€»é‡‘é¢

        

            if (processedData['å¯æŠ•ç§‘ç›®']) {

        

                processedData['å¯æŠ•ç§‘ç›®'].forEach(item => {

        

                    totalInvestable += item['å¸‚å€¼'];

        

                    holdings.push({

        

                        name: item['åˆ†ç±»'],

        

                        shares: 0,

        

                        nav: 0,

        

                        category: 'å¯æŠ•ç§‘ç›®',

        

                        index: item['å¯æŠ•ç§‘ç›®'],

        

                        fundNav: item['åŸºé‡‘èµ„äº§å‡€å€¼'],

        

                        marketValue: item['å¸‚å€¼']

        

                    });

        

                });

        

                            }

        

        

        

            // æ·»åŠ éœ€æ”¯ä»˜ç§‘ç›®åˆ°holdingså¹¶è®¡ç®—æ€»é‡‘é¢

        

            if (processedData['éœ€æ”¯ä»˜ç§‘ç›®']) {

        

                processedData['éœ€æ”¯ä»˜ç§‘ç›®'].forEach(item => {

        

                    totalPayable += item['å¸‚å€¼'];

        

                    holdings.push({

        

                        name: item['åˆ†ç±»'],

        

                        shares: 0,

        

                        nav: 0,

        

                        category: 'éœ€æ”¯ä»˜ç§‘ç›®',

        

                        index: item['éœ€æ”¯ä»˜ç§‘ç›®'],

        

                        fundNav: item['åŸºé‡‘èµ„äº§å‡€å€¼'],

        

                        marketValue: item['å¸‚å€¼']

        

                    });

        

                });

        

                            }

        

        

        

            // è®¡ç®—å¯æŠ•èµ„é‡‘é¢

        

            investableAmount = totalInvestable - totalPayable;

            payableAmount = totalPayable;

        

            console.log('=== èµ„é‡‘è®¡ç®—ç»“æœ ===');

            console.log('å¯æŠ•ç§‘ç›®æ€»é‡‘é¢(totalInvestable):', totalInvestable);

            console.log('éœ€æ”¯ä»˜ç§‘ç›®æ€»é‡‘é¢(totalPayable):', totalPayable);

            console.log('å¯æŠ•èµ„é‡‘é¢(investableAmount):', investableAmount);

            console.log('ä¸“æˆ·æ€»å¸‚å€¼(totalMarketValue):', totalMarketValue);

        

        

        

            // æ›´æ–°ä¹°å…¥ç•Œé¢çš„å¯æŠ•èµ„é‡‘é¢æ˜¾ç¤º

        

        

        

                        updateAvailableInvestAmount();

        

        

        

                        

        

        

        

                        // æ›´æ–°å–å‡ºäº§å“ä¸‹æ‹‰æ¡†

        

        

        

                        updateSellProducts();

        

        

        

                        

        

        

        

                        // æ›´æ–°è°ƒè¯•ä¿¡æ¯æ˜¾ç¤º

        

        

        

                        

        

        

        

                    }        // å¤„ç†æŒä»“æ•°æ®ï¼ˆä»æŒä»“æå–å·¥å…·å¤åˆ¶è¿‡æ¥ï¼‰
        function processHoldingData(sourceSheets) {
            const result = {};
            const sourceSheet = sourceSheets['Sheet1'];
            
            if (!sourceSheet) {
                throw new Error('æœªæ‰¾åˆ°Sheet1');
            }

            let navValue = 0;

            // å…ˆæ‰¾åˆ°è¡¨å¤´ï¼Œç¡®å®š"å¸‚å€¼"å’Œ"å¸‚ä»·"åˆ—çš„ä½ç½®
            let marketValueColIndex = -1;
            let marketPriceColIndex = -1;
            sourceSheet.forEach((row, index) => {
                if (row[0] === 'ç§‘ç›®ä»£ç ' && row[1] === 'ç§‘ç›®åç§°') {
                    marketValueColIndex = row.indexOf('å¸‚å€¼');
                    marketPriceColIndex = row.indexOf('å¸‚ä»·');
                }
            });

            // å¦‚æœæ‰¾ä¸åˆ°å¸‚å€¼åˆ—ï¼Œé»˜è®¤ä½¿ç”¨ç¬¬8åˆ—ï¼ˆç´¢å¼•7ï¼‰
            if (marketValueColIndex === -1) {
                marketValueColIndex = 7;
            }

            // å¦‚æœæ‰¾ä¸åˆ°å¸‚ä»·åˆ—ï¼Œé»˜è®¤ä½¿ç”¨ç¬¬7åˆ—ï¼ˆç´¢å¼•6ï¼‰
            if (marketPriceColIndex === -1) {
                marketPriceColIndex = 6;
            }

            console.log('å¸‚å€¼åˆ—ç´¢å¼•:', marketValueColIndex, 'å¸‚ä»·åˆ—ç´¢å¼•:', marketPriceColIndex);

            // æŸ¥æ‰¾"åŸºé‡‘èµ„äº§å‡€å€¼"è¡Œå¹¶æå–å…¶å¸‚å€¼
            sourceSheet.forEach((row, index) => {
                // åœ¨æ•´è¡Œä¸­æŸ¥æ‰¾"åŸºé‡‘èµ„äº§å‡€å€¼"å­—ç¬¦ä¸²
                let foundNav = false;
                for (let col = 0; col < row.length; col++) {
                    const cellValue = row[col] ? row[col].toString() : '';
                    if (cellValue.includes('åŸºé‡‘èµ„äº§å‡€å€¼')) {
                        foundNav = true;
                        console.log('åœ¨ç¬¬', index, 'è¡Œç¬¬', col, 'åˆ—æ‰¾åˆ°"åŸºé‡‘èµ„äº§å‡€å€¼"');
                        break;
                    }
                }
                
                if (foundNav && marketValueColIndex >= 0 && marketValueColIndex < row.length) {
                    navValue = extractMarketValue(row[marketValueColIndex]);
                    console.log('æ‰¾åˆ°åŸºé‡‘èµ„äº§å‡€å€¼è¡Œï¼Œè¡Œå·:', index, 'å¸‚å€¼åˆ—ç´¢å¼•:', marketValueColIndex, 'å¸‚å€¼:', navValue);
                }
            });

            const navInWan = navValue / 10000;

            // å¤„ç†å·²æŠ•åŸºé‡‘éƒ¨åˆ†
            const å·²æŠ•åŸºé‡‘éƒ¨åˆ† = [];
            let index = 1;

            sourceSheet.forEach(row => {
                const code = String(row[0] || '');
                const name = extractProductName(row[1]);
                const quantity = row[2] || 0;
                const price = row[marketPriceColIndex] || 0;
                const marketValue = extractMarketValue(row[marketValueColIndex]);

                // ç­›é€‰ç§å‹ŸåŸºé‡‘äº§å“ (ç§‘ç›®ä»£ç ä»¥11090601å¼€å¤´ï¼Œä¸”ä¸æ˜¯æ±‡æ€»è¡Œï¼Œä¸”ä¸æ˜¯"å…¶ä»–æŠ•èµ„_ç§å‹Ÿç†è´¢äº§å“æˆæœ¬")
                if (code.match(/^11090601[A-Z0-9]*$/) && !code.includes('99') && name && name !== 'ç§‘ç›®åç§°' && 
                    !name.includes('å…¶ä»–æŠ•èµ„_ç§å‹Ÿç†è´¢äº§å“æˆæœ¬') && !name.includes('å…¶ä»–æŠ•èµ„') && 
                    !name.includes('ç§å‹Ÿç†è´¢äº§å“æˆæœ¬') && !name.includes('æˆæœ¬') && 
                    !name.includes('æ±‡æ€»') && !name.includes('åˆè®¡') && marketValue > 0) {
                    å·²æŠ•åŸºé‡‘éƒ¨åˆ†.push({
                        index: index,
                        name: name,
                        shares: quantity / 10000,
                        nav: price,
                        marketValue: marketValue / 10000,
                        fundNav: navInWan,
                        category: 'å·²æŠ•åŸºé‡‘'
                    });
                    index++;
                }
            });

            result['å·²æŠ•åŸºé‡‘éƒ¨åˆ†'] = å·²æŠ•åŸºé‡‘éƒ¨åˆ†;

            // å¤„ç†å¯æŠ•ç§‘ç›®
            const å¯æŠ•ç§‘ç›® = [];
            let æ´»æœŸå­˜æ¬¾å¸‚å€¼ = 0;
            let è´§å¸åŸºé‡‘å¸‚å€¼ = 0;
            let foundDeposit = false;
            let foundMoneyFund = false;

            // æå–æ´»æœŸå­˜æ¬¾å¸‚å€¼ï¼ˆç§‘ç›®ä»£ç 10020102ï¼‰
            sourceSheet.forEach(row => {
                const code = String(row[0] || '');
                if (code === '10020102') {
                    æ´»æœŸå­˜æ¬¾å¸‚å€¼ = extractMarketValue(row[marketValueColIndex]);
                    foundDeposit = true;
                    console.log('æ‰¾åˆ°æ´»æœŸå­˜æ¬¾:', code, 'å¸‚å€¼:', æ´»æœŸå­˜æ¬¾å¸‚å€¼, 'å®Œæ•´è¡Œ:', row);
                }
            });

            // å¦‚æœæ²¡æ‰¾åˆ°10020102ï¼Œå°è¯•å…¶ä»–æ´»æœŸå­˜æ¬¾ç›¸å…³ä»£ç 
            if (!foundDeposit) {
                sourceSheet.forEach(row => {
                    const code = String(row[0] || '');
                    const name = String(row[1] || '');
                    if (code.startsWith('1002') && name.includes('æ´»æœŸ')) {
                        æ´»æœŸå­˜æ¬¾å¸‚å€¼ = extractMarketValue(row[marketValueColIndex]);
                        foundDeposit = true;
                        console.log('é€šè¿‡åç§°æ‰¾åˆ°æ´»æœŸå­˜æ¬¾:', code, name, 'å¸‚å€¼:', æ´»æœŸå­˜æ¬¾å¸‚å€¼);
                    }
                });
            }

            // æå–è´§å¸åŸºé‡‘å¸‚å€¼ï¼ˆç§‘ç›®åç§°åŒ…å«"è´§å¸"ï¼‰
            sourceSheet.forEach(row => {
                const name = String(row[1] || '');
                const marketValue = extractMarketValue(row[marketValueColIndex]);
                if (name.includes('è´§å¸') && marketValue > 0) {
                    è´§å¸åŸºé‡‘å¸‚å€¼ += marketValue;
                    foundMoneyFund = true;
                    console.log('æ‰¾åˆ°è´§å¸åŸºé‡‘:', name, 'å¸‚å€¼:', marketValue);
                }
            });

            console.log('æ´»æœŸå­˜æ¬¾å¸‚å€¼:', æ´»æœŸå­˜æ¬¾å¸‚å€¼, 'æ‰¾åˆ°æ´»æœŸå­˜æ¬¾:', foundDeposit);
            console.log('è´§å¸åŸºé‡‘å¸‚å€¼:', è´§å¸åŸºé‡‘å¸‚å€¼, 'æ‰¾åˆ°è´§å¸åŸºé‡‘:', foundMoneyFund);

            // æ·»åŠ æ´»æœŸå­˜æ¬¾
            å¯æŠ•ç§‘ç›®.push({
                index: 1,
                name: 'æ´»æœŸå­˜æ¬¾',
                shares: 0,
                nav: 0,
                marketValue: æ´»æœŸå­˜æ¬¾å¸‚å€¼ / 10000,
                fundNav: navInWan,
                category: 'å¯æŠ•ç§‘ç›®'
            });

            // æ·»åŠ è´§å¸åŸºé‡‘
            å¯æŠ•ç§‘ç›®.push({
                index: 2,
                name: 'è´§å¸åŸºé‡‘',
                shares: 0,
                nav: 0,
                marketValue: è´§å¸åŸºé‡‘å¸‚å€¼ / 10000,
                fundNav: navInWan,
                category: 'å¯æŠ•ç§‘ç›®'
            });

            result['å¯æŠ•ç§‘ç›®'] = å¯æŠ•ç§‘ç›®;

            // å¤„ç†éœ€æ”¯ä»˜ç§‘ç›®
            const éœ€æ”¯ä»˜ç§‘ç›® = [];
            const éœ€æ”¯ä»˜ç§‘ç›®æ˜ å°„ = {
                '2205': 'åº”ä»˜å¤–åŒ…æœåŠ¡è´¹',
                '2206': 'åº”ä»˜ç®¡ç†äººæŠ¥é…¬',
                '2207': 'åº”ä»˜æ‰˜ç®¡è´¹'
            };

            index = 1;
            let foundPayment = false;
            sourceSheet.forEach(row => {
                const code = String(row[0] || '');
                const marketValue = extractMarketValue(row[marketValueColIndex]);

                // æ£€æŸ¥æ˜¯å¦ä¸ºéœ€æ”¯ä»˜ç§‘ç›®
                if (éœ€æ”¯ä»˜ç§‘ç›®æ˜ å°„[code]) {
                    const category = éœ€æ”¯ä»˜ç§‘ç›®æ˜ å°„[code];
                    éœ€æ”¯ä»˜ç§‘ç›®.push({
                        index: index,
                        name: category,
                        shares: 0,
                        nav: 0,
                        marketValue: marketValue / 10000,
                        fundNav: navInWan,
                        category: 'éœ€æ”¯ä»˜ç§‘ç›®'
                    });
                    foundPayment = true;
                    index++;
                }
            });

            result['éœ€æ”¯ä»˜ç§‘ç›®'] = éœ€æ”¯ä»˜ç§‘ç›®;

            return result;
        }

        // è½¬æ¢ä¸ºholdingsæ ¼å¼
        function convertToHoldings(processedData) {
            // æ¸…ç©ºç°æœ‰æŒä»“
            holdings = [];
            
            // åˆå¹¶æ‰€æœ‰åˆ†ç±»
            const allHoldings = [
                ...processedData['å·²æŠ•åŸºé‡‘éƒ¨åˆ†'],
                ...processedData['å¯æŠ•ç§‘ç›®'],
                ...processedData['éœ€æ”¯ä»˜ç§‘ç›®']
            ];
            
            holdings = allHoldings;
        }

        // æ·»åŠ æŒä»“
        function showAddHoldingModal() {
            const name = prompt('è¯·è¾“å…¥äº§å“åç§°ï¼š');
            if (!name) return;

            const shares = parseFloat(prompt('è¯·è¾“å…¥å½“å‰ä»½é¢ï¼ˆä¸‡ä»½ï¼‰ï¼š'));
            if (isNaN(shares) || shares <= 0) {
                showAlert('è¯·è¾“å…¥æœ‰æ•ˆçš„ä»½é¢', 'error');
                return;
            }

            const nav = parseFloat(prompt('è¯·è¾“å…¥æ ‡çš„å‡€å€¼ï¼š'));
            if (isNaN(nav) || nav <= 0) {
                showAlert('è¯·è¾“å…¥æœ‰æ•ˆçš„å‡€å€¼', 'error');
                return;
            }

            holdings.push({ name, shares, nav });
            updateHoldingTable();
            showAlert('æŒä»“å·²æ·»åŠ ', 'success');
        }

        // åˆ é™¤æŒä»“
        function deleteHolding(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæŒä»“å—ï¼Ÿ')) {
                holdings.splice(index, 1);
                updateHoldingTable();
                showAlert('æŒä»“å·²åˆ é™¤', 'success');
            }
        }

        // å¯¼å‡ºæŒä»“
        function exportHoldings() {
            let csv = 'äº§å“åç§°,å½“å‰ä»½é¢ï¼ˆä¸‡ä»½ï¼‰,æ ‡çš„å‡€å€¼,å½“å‰å¸‚å€¼ï¼ˆä¸‡å…ƒï¼‰,å å‡€å€¼æ¯”ä¾‹ï¼ˆ%ï¼‰\n';
            const totalValue = holdings.reduce((sum, h) => sum + (h.shares * h.nav), 0);

            holdings.forEach(holding => {
                const marketValue = holding.shares * holding.nav;
                const percentage = ((marketValue / totalValue) * 100).toFixed(2);
                csv += `${holding.name},${holding.shares.toFixed(2)},${holding.nav.toFixed(4)},${marketValue.toFixed(2)},${percentage}\n`;
            });

            downloadFile(csv, 'æŒä»“æ˜ç»†.csv', 'text/csv;charset=utf-8;\uFEFF');
            showAlert('å·²å¯¼å‡ºä¸ºCSVæ–‡ä»¶', 'success');
        }

        // å¯¼å…¥æŒä»“
        function importHoldings() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv,.xlsx,.xls';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        const lines = content.split('\n');
                        const importedHoldings = [];

                        // è·³è¿‡è¡¨å¤´è¡Œ
                        for (let i = 1; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (!line) continue;

                            const columns = line.split(',');
                            if (columns.length >= 3) {
                                const name = columns[0].trim();
                                const shares = parseFloat(columns[1]);
                                const nav = parseFloat(columns[2]);

                                if (name && !isNaN(shares) && !isNaN(nav)) {
                                    importedHoldings.push({ name, shares, nav });
                                }
                            }
                        }

                        if (importedHoldings.length > 0) {
                            if (confirm(`å³å°†å¯¼å…¥ ${importedHoldings.length} æ¡æŒä»“æ•°æ®ï¼Œæ˜¯å¦è¦†ç›–ç°æœ‰æŒä»“ï¼Ÿ`)) {
                                holdings = importedHoldings;
                                updateHoldingTable();
                                updateSellProducts();
                                showAlert(`æˆåŠŸå¯¼å…¥ ${importedHoldings.length} æ¡æŒä»“æ•°æ®`, 'success');
                            }
                        } else {
                            showAlert('æœªæ‰¾åˆ°æœ‰æ•ˆçš„æŒä»“æ•°æ®ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼', 'error');
                        }
                    } catch (error) {
                        showAlert('æ–‡ä»¶è§£æå¤±è´¥ï¼š' + error.message, 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // æ›´æ–°äº§å“æ± è¡¨æ ¼
        let currentPoolFilter = 'all';

        function updatePoolTable() {
            const tbody = document.getElementById('poolTableBody');
            const emptyState = document.getElementById('poolEmptyState');
            tbody.innerHTML = '';

            // æ ¹æ®å½“å‰ç­›é€‰æ¡ä»¶è¿‡æ»¤äº§å“
            let filteredProducts = productPool;
            if (currentPoolFilter !== 'all') {
                filteredProducts = productPool.filter(p => p.assetClass === currentPoolFilter);
            }

            if (filteredProducts.length === 0) {
                emptyState.style.display = 'block';
                document.getElementById('poolTable').style.display = 'none';
                emptyState.querySelector('p').textContent = currentPoolFilter === 'all' ? 'æš‚æ— äº§å“æ•°æ®' : 'è¯¥åˆ†ç±»ä¸‹æš‚æ— äº§å“';
                return;
            }

            emptyState.style.display = 'none';
            document.getElementById('poolTable').style.display = 'table';

            // æŒ‰èµ„äº§ç±»åˆ«åˆ†ç»„
            const groupedProducts = {};
            filteredProducts.forEach(product => {
                if (!groupedProducts[product.assetClass]) {
                    groupedProducts[product.assetClass] = [];
                }
                groupedProducts[product.assetClass].push(product);
            });

            // æ¸²æŸ“è¡¨æ ¼
            Object.keys(groupedProducts).forEach(assetClass => {
                const products = groupedProducts[assetClass];
                
                // æ·»åŠ åˆ†ç±»æ ‡é¢˜è¡Œ
                const headerRow = document.createElement('tr');
                headerRow.className = 'category-header';
                headerRow.innerHTML = `
                    <td colspan="7" style="background: #f0f0f0; font-weight: bold; color: #667eea;">
                        ğŸ“¦ ${assetClass} (${products.length}ä¸ªäº§å“)
                    </td>
                `;
                tbody.appendChild(headerRow);

                // æ·»åŠ è¯¥åˆ†ç±»ä¸‹çš„äº§å“
                products.forEach((product, index) => {
                    // æ‰¾åˆ°äº§å“åœ¨åŸæ•°ç»„ä¸­çš„çœŸå®ç´¢å¼•
                    const realIndex = productPool.findIndex(p => p.code === product.code);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${product.assetClass}</td>
                        <td>${product.strategyType}</td>
                        <td>${product.strategyName}</td>
                        <td>${product.code}</td>
                        <td>${product.name}</td>
                        <td style="text-align: center;">${product.minInvest}</td>
                        <td style="text-align: center;">
                            <button class="btn btn-xs btn-info" onclick="editProduct(${realIndex})">ç¼–è¾‘</button>
                            <button class="btn btn-xs btn-danger" onclick="deleteProduct(${realIndex})">åˆ é™¤</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            });
        }

        // æŒ‰åˆ†ç±»ç­›é€‰äº§å“æ± 
        function filterPoolByCategory(category) {
            currentPoolFilter = category;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.pool-category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            updatePoolTable();
        }

        // æ·»åŠ äº§å“
        function showAddPoolModal() {
            // è®¾ç½®ä¸ºæ·»åŠ æ¨¡å¼
            window.currentEditingIndex = -1;
            document.getElementById('addPoolModalTitle').textContent = 'æ·»åŠ äº§å“åˆ°äº§å“æ± ';
            document.getElementById('addProductCode').readOnly = false;

            // æ¸…ç©ºè¡¨å•
            document.getElementById('addAssetClass').value = '';
            document.getElementById('addStrategyType').value = '';
            document.getElementById('addStrategyName').value = '';
            document.getElementById('addProductCode').value = '';
            document.getElementById('addProductName').value = '';
            document.getElementById('addMinInvest').value = '';

            // æ¸…ç©ºç­–ç•¥ç±»å‹ä¸‹æ‹‰æ¡†
            const strategyTypeSelect = document.getElementById('addStrategyType');
            strategyTypeSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©èµ„äº§ç±»åˆ«</option>';

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            const modal = document.getElementById('addPoolModal');
            modal.style.display = 'block';
            modal.style.opacity = '1';
            modal.style.visibility = 'visible';
            modal.style.animation = 'none';
        }

        // ç¼–è¾‘äº§å“
        function editProduct(index) {
            const product = productPool[index];
            if (!product) return;

            // è®¾ç½®ä¸ºç¼–è¾‘æ¨¡å¼
            window.currentEditingIndex = index;
            document.getElementById('addPoolModalTitle').textContent = 'ç¼–è¾‘äº§å“';

            // å¡«å……è¡¨å•
            document.getElementById('addAssetClass').value = product.assetClass;

            // è§¦å‘èµ„äº§ç±»åˆ«æ”¹å˜ï¼Œæ›´æ–°ç­–ç•¥ç±»å‹é€‰é¡¹
            const event = new Event('change');
            document.getElementById('addAssetClass').dispatchEvent(event);

            // å»¶è¿Ÿå¡«å……ç­–ç•¥ç±»å‹ï¼ˆç­‰å¾…ä¸‹æ‹‰æ¡†æ›´æ–°ï¼‰
            setTimeout(() => {
                document.getElementById('addStrategyType').value = product.strategyType;
                document.getElementById('addStrategyName').value = product.strategyName;
                document.getElementById('addProductCode').value = product.code;
                document.getElementById('addProductName').value = product.name;
                document.getElementById('addMinInvest').value = product.minInvest;
            }, 100);

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            const modal = document.getElementById('addPoolModal');
            modal.style.display = 'block';
            modal.style.opacity = '1';
            modal.style.visibility = 'visible';
            modal.style.animation = 'none';
        }

        // èµ„äº§ç±»åˆ«æ”¹å˜æ—¶æ›´æ–°ç­–ç•¥ç±»å‹
        document.getElementById('addAssetClass').addEventListener('change', function() {
            const assetClass = this.value;
            const strategyTypeSelect = document.getElementById('addStrategyType');
            const strategyNameSelect = document.getElementById('addStrategyName');

            // æ¸…ç©ºç­–ç•¥ç±»å‹å’Œäº§å“ç­–ç•¥ç±»å‹
            strategyTypeSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ç­–ç•¥ç±»å‹</option>';
            strategyNameSelect.value = '';

            if (!assetClass) return;

            // æ ¹æ®èµ„äº§ç±»åˆ«æ›´æ–°ç­–ç•¥ç±»å‹é€‰é¡¹
            const strategies = STRATEGY_MAPPING[assetClass]?.strategies || [];
            strategies.forEach(strategy => {
                const option = document.createElement('option');
                option.value = strategy;
                option.textContent = strategy;
                strategyTypeSelect.appendChild(option);
            });
        });

        // ç­–ç•¥ç±»å‹æ”¹å˜æ—¶è‡ªåŠ¨å¡«å……äº§å“ç­–ç•¥ç±»å‹
        function onStrategyTypeChange() {
            const assetClass = document.getElementById('addAssetClass').value;
            const strategyType = document.getElementById('addStrategyType').value;
            const strategyNameSelect = document.getElementById('addStrategyName');

            if (!assetClass || !strategyType) {
                strategyNameSelect.value = '';
                return;
            }

            // æ ¹æ®æ˜ å°„å…³ç³»è‡ªåŠ¨å¡«å……äº§å“ç­–ç•¥ç±»å‹
            const strategyName = STRATEGY_MAPPING[assetClass]?.mapping[strategyType];
            if (strategyName) {
                strategyNameSelect.value = strategyName;
            }
        }

        // å…³é—­æ·»åŠ äº§å“æ¨¡æ€æ¡†
        function closeAddPoolModal() {
            document.getElementById('addPoolModal').style.display = 'none';
        }

        // ä¿®æ”¹äº§å“åç§°ç›¸å…³å‡½æ•°
        let currentEditIndex = -1;

        function openEditProductNameModal(index) {
            if (!processedData || !processedData['å·²æŠ•åŸºé‡‘éƒ¨åˆ†']) {
                showAlert('æ²¡æœ‰å¯ä¿®æ”¹çš„äº§å“æ•°æ®', 'error');
                return;
            }

            const product = processedData['å·²æŠ•åŸºé‡‘éƒ¨åˆ†'][index];
            if (!product) {
                showAlert('æœªæ‰¾åˆ°äº§å“æ•°æ®', 'error');
                return;
            }

            currentEditIndex = index;
            document.getElementById('editOldProductName').value = product['äº§å“åç§°ï¼ˆå«ä»½é¢ç±»åˆ«ï¼‰'];
            document.getElementById('editNewProductName').value = '';

            const modal = document.getElementById('editProductNameModal');
            modal.style.display = 'block';
            modal.style.opacity = '1';
            modal.style.visibility = 'visible';
            modal.style.animation = 'none';
        }

        function closeEditProductNameModal() {
            document.getElementById('editProductNameModal').style.display = 'none';
            currentEditIndex = -1;
        }

        function confirmEditProductName() {
            const oldName = document.getElementById('editOldProductName').value;
            const newName = document.getElementById('editNewProductName').value.trim();

            if (!newName) {
                showAlert('äº§å“åç§°ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }

            if (oldName === newName) {
                showAlert('äº§å“åç§°æœªä¿®æ”¹', 'info');
                closeEditProductNameModal();
                return;
            }

            // æ›´æ–°processedDataä¸­çš„äº§å“åç§°
            if (processedData && processedData['å·²æŠ•åŸºé‡‘éƒ¨åˆ†']) {
                processedData['å·²æŠ•åŸºé‡‘éƒ¨åˆ†'].forEach(item => {
                    if (item['äº§å“åç§°ï¼ˆå«ä»½é¢ç±»åˆ«ï¼‰'] === oldName) {
                        item['äº§å“åç§°ï¼ˆå«ä»½é¢ç±»åˆ«ï¼‰'] = newName;
                    }
                });
            }

            // æ›´æ–°holdingsæ•°ç»„ä¸­çš„äº§å“åç§°
            holdings.forEach(holding => {
                if (holding.category === 'å·²æŠ•åŸºé‡‘' && holding.name === oldName) {
                    holding.name = newName;
                }
            });

            // æ›´æ–°sellOrdersä¸­çš„äº§å“åç§°
            sellOrders.forEach(order => {
                if (order.productName === oldName) {
                    order.productName = newName;
                }
            });

            // æ›´æ–°buyOrdersä¸­çš„äº§å“åç§°
            buyOrders.forEach(order => {
                if (order.productName === oldName) {
                    order.productName = newName;
                }
            });

            // æ›´æ–°productMappingä¸­çš„äº§å“åç§°
            if (productMapping[oldName]) {
                productMapping[newName] = productMapping[oldName];
                delete productMapping[oldName];
            }

            // åˆ·æ–°è¡¨æ ¼æ˜¾ç¤º
            updateInvestFundTable(processedData['å·²æŠ•åŸºé‡‘éƒ¨åˆ†']);
            updateSellTable();
            
            // æ›´æ–°å–å‡ºäº§å“ä¸‹æ‹‰æ¡†ï¼Œç¡®ä¿ä¸‹æ‹‰æ¡†é€‰é¡¹ä¸æŒä»“æ•°æ®åŒæ­¥
            updateSellProducts();

            closeEditProductNameModal();
            showAlert('äº§å“åç§°ä¿®æ”¹æˆåŠŸ', 'success');
        }

        // ä¿å­˜å·²æŠ•åŸºé‡‘æ•°æ®
        function saveInvestFundData() {
            if (!processedData || !processedData['å·²æŠ•åŸºé‡‘éƒ¨åˆ†']) {
                showAlert('æ²¡æœ‰å¯ä¿å­˜çš„æ•°æ®', 'error');
                return;
            }

            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            const data = {
                version: APP_VERSION,
                saveTime: new Date().toISOString(),
                processedData: processedData,
                holdings: holdings,
                productMapping: productMapping,
                buyOrders: buyOrders,
                sellOrders: sellOrders,
                productPool: productPool,
                totalMarketValue: totalMarketValue
            };
            localStorage.setItem('investmentData', JSON.stringify(data));

            // è”åŠ¨æ›´æ–°å…¨å±€æ•°æ®ï¼ˆä½¿ç”¨holdingsæ•°ç»„ï¼Œä¸è¦†ç›–ç”¨æˆ·ä¿®æ”¹çš„æ•°æ®ï¼‰
            // 1. æ›´æ–°æŒä»“è¡¨æ ¼ï¼ˆä½¿ç”¨å½“å‰holdingsæ•°ç»„ï¼‰
            updateHoldingTable();
            
            // 2. æ›´æ–°æ±‡æ€»é¡µ
            if (typeof updateSummary === 'function') {
                updateSummary();
            }

            const saveTime = new Date().toLocaleString('zh-CN');
            showAlert(`âœ… å·²æŠ•åŸºé‡‘æ•°æ®å·²ä¿å­˜ (${saveTime})`, 'success');
        }

        // æ›´æ–°äº§å“åˆ†ç±»ï¼ˆèµ„äº§ç±»åˆ«ã€ç­–ç•¥ç±»å‹ã€äº§å“ç­–ç•¥ï¼‰
        function updateProductClassification(index, fieldType, newValue) {
            console.log('updateProductClassification è¢«è°ƒç”¨:', index, fieldType, newValue);
            
            if (!processedData || !processedData['å·²æŠ•åŸºé‡‘éƒ¨åˆ†']) {
                showAlert('æ²¡æœ‰å¯ä¿®æ”¹çš„äº§å“æ•°æ®', 'error');
                return;
            }

            const product = processedData['å·²æŠ•åŸºé‡‘éƒ¨åˆ†'][index];
            if (!product) {
                showAlert('æœªæ‰¾åˆ°äº§å“æ•°æ®', 'error');
                return;
            }

            // æ›´æ–°å¯¹åº”å­—æ®µ
            if (fieldType === 'assetClass') {
                product['èµ„äº§ç±»åˆ«'] = newValue;
                console.log('èµ„äº§ç±»åˆ«å·²æ›´æ–°ä¸º:', newValue);
            } else if (fieldType === 'strategyType') {
                product['ç­–ç•¥ç±»å‹'] = newValue;
                console.log('ç­–ç•¥ç±»å‹å·²æ›´æ–°ä¸º:', newValue);
            } else if (fieldType === 'strategyName') {
                product['äº§å“ç­–ç•¥'] = newValue;
                console.log('äº§å“ç­–ç•¥å·²æ›´æ–°ä¸º:', newValue);
            }

            // è”åŠ¨é€»è¾‘ï¼šæ ¹æ®æ˜ å°„å…³ç³»è‡ªåŠ¨å¡«å……å…¶ä»–å­—æ®µ
            if (fieldType === 'assetClass' && newValue) {
                // é€‰æ‹©èµ„äº§ç±»åˆ«åï¼Œæ¸…ç©ºç­–ç•¥ç±»å‹å’Œäº§å“ç­–ç•¥
                product['ç­–ç•¥ç±»å‹'] = '';
                product['äº§å“ç­–ç•¥'] = '';
                console.log('æ¸…ç©ºç­–ç•¥ç±»å‹å’Œäº§å“ç­–ç•¥');
            } else if (fieldType === 'strategyType' && newValue) {
                // é€‰æ‹©ç­–ç•¥ç±»å‹åï¼Œæ ¹æ®æ˜ å°„å…³ç³»è‡ªåŠ¨å¡«å……äº§å“ç­–ç•¥
                const assetClass = product['èµ„äº§ç±»åˆ«'];
                if (assetClass && STRATEGY_MAPPING[assetClass]) {
                    const mapping = STRATEGY_MAPPING[assetClass].mapping;
                    if (mapping && mapping[newValue]) {
                        product['äº§å“ç­–ç•¥'] = mapping[newValue];
                        console.log('è‡ªåŠ¨å¡«å……äº§å“ç­–ç•¥:', mapping[newValue]);
                    }
                }
            } else if (fieldType === 'strategyName' && newValue) {
                // é€‰æ‹©äº§å“ç­–ç•¥åï¼Œå¯ä»¥æ ¹æ®ç­–ç•¥åç§°åæ¨èµ„äº§ç±»åˆ«å’Œç­–ç•¥ç±»å‹
                for (const assetClass in STRATEGY_MAPPING) {
                    for (const strategyType in STRATEGY_MAPPING[assetClass].mapping) {
                        if (STRATEGY_MAPPING[assetClass].mapping[strategyType] === newValue) {
                            product['èµ„äº§ç±»åˆ«'] = assetClass;
                            product['ç­–ç•¥ç±»å‹'] = strategyType;
                            console.log('åå‘å¡«å……èµ„äº§ç±»åˆ«å’Œç­–ç•¥ç±»å‹:', assetClass, strategyType);
                            break;
                        }
                    }
                }
            }

            // åŒæ­¥æ›´æ–°holdingsæ•°ç»„
            holdings.forEach(holding => {
                if (holding.category === 'å·²æŠ•åŸºé‡‘' && holding.name === product['äº§å“åç§°ï¼ˆå«ä»½é¢ç±»åˆ«ï¼‰']) {
                    holding.assetClass = product['èµ„äº§ç±»åˆ«'];
                    holding.strategyType = product['ç­–ç•¥ç±»å‹'];
                    holding.strategyName = product['äº§å“ç­–ç•¥'];
                }
            });

            // åŒæ­¥æ›´æ–°productMappingä¸­çš„ç­–ç•¥ä¿¡æ¯
            const productName = product['äº§å“åç§°ï¼ˆå«ä»½é¢ç±»åˆ«ï¼‰'];
            if (productMapping[productName]) {
                productMapping[productName].assetClass = product['èµ„äº§ç±»åˆ«'];
                productMapping[productName].strategyType = product['ç­–ç•¥ç±»å‹'];
                productMapping[productName].strategyName = product['äº§å“ç­–ç•¥'];
            }

            // ç›´æ¥æ›´æ–°DOMå…ƒç´ ï¼Œä¸é‡æ–°æ¸²æŸ“æ•´ä¸ªè¡¨æ ¼
            const tbody = document.getElementById('investFundTableBody');
            const rows = tbody.querySelectorAll('tr');
            const row = rows[index];
            if (row) {
                const cells = row.querySelectorAll('td');
                // èµ„äº§ç±»åˆ«åˆ—ï¼ˆç´¢å¼•2ï¼‰
                if (fieldType === 'assetClass' || fieldType === 'strategyType' || fieldType === 'strategyName') {
                    const assetClassCell = cells[2];
                    const strategyTypeCell = cells[3];
                    const strategyNameCell = cells[4];
                    
                    const isUnmatched = !product['äº§å“ä»£ç '] || product['äº§å“ä»£ç '] === '';
                    
                    // æ›´æ–°èµ„äº§ç±»åˆ«
                    if (isUnmatched) {
                        assetClassCell.innerHTML = `
                            <select onchange="updateProductClassification(${index}, 'assetClass', this.value)" style="padding: 4px 8px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 12px; width: 100%; position: relative; z-index: 100;">
                                <option value="" ${product['èµ„äº§ç±»åˆ«'] === '' ? 'selected' : ''}>æœªåŒ¹é…</option>
                                <option value="è¿›å–ç±»" ${product['èµ„äº§ç±»åˆ«'] === 'è¿›å–ç±»' ? 'selected' : ''}>è¿›å–ç±»</option>
                                <option value="å¹³è¡¡ç±»" ${product['èµ„äº§ç±»åˆ«'] === 'å¹³è¡¡ç±»' ? 'selected' : ''}>å¹³è¡¡ç±»</option>
                                <option value="ç¨³å¥ç±»" ${product['èµ„äº§ç±»åˆ«'] === 'ç¨³å¥ç±»' ? 'selected' : ''}>ç¨³å¥ç±»</option>
                            </select>
                        `;
                    } else {
                        assetClassCell.innerHTML = `<span style="color: ;">${product['èµ„äº§ç±»åˆ«'] || '-'}</span>`;
                    }
                    
                    // æ›´æ–°ç­–ç•¥ç±»å‹
                    if (isUnmatched) {
                        strategyTypeCell.innerHTML = `
                            <select onchange="updateProductClassification(${index}, 'strategyType', this.value)" style="padding: 4px 8px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 12px; width: 100%; position: relative; z-index: 100;">
                                <option value="" ${product['ç­–ç•¥ç±»å‹'] === '' ? 'selected' : ''}>æœªåŒ¹é…</option>
                                <option value="ä¸»è§‚è‚¡ç¥¨å¤šå¤´" ${product['ç­–ç•¥ç±»å‹'] === 'ä¸»è§‚è‚¡ç¥¨å¤šå¤´' ? 'selected' : ''}>ä¸»è§‚è‚¡ç¥¨å¤šå¤´</option>
                                <option value="é‡åŒ–é€‰è‚¡" ${product['ç­–ç•¥ç±»å‹'] === 'é‡åŒ–é€‰è‚¡' ? 'selected' : ''}>é‡åŒ–é€‰è‚¡</option>
                                <option value="CTA" ${product['ç­–ç•¥ç±»å‹'] === 'CTA' ? 'selected' : ''}>CTA</option>
                                <option value="å®è§‚å¯¹å†²" ${product['ç­–ç•¥ç±»å‹'] === 'å®è§‚å¯¹å†²' ? 'selected' : ''}>å®è§‚å¯¹å†²</option>
                                <option value="å¤šç­–ç•¥" ${product['ç­–ç•¥ç±»å‹'] === 'å¤šç­–ç•¥' ? 'selected' : ''}>å¤šç­–ç•¥</option>
                                <option value="å¸‚åœºä¸­æ€§" ${product['ç­–ç•¥ç±»å‹'] === 'å¸‚åœºä¸­æ€§' ? 'selected' : ''}>å¸‚åœºä¸­æ€§</option>
                                <option value="å€ºåˆ¸" ${product['ç­–ç•¥ç±»å‹'] === 'å€ºåˆ¸' ? 'selected' : ''}>å€ºåˆ¸</option>
                            </select>
                        `;
                    } else {
                        strategyTypeCell.innerHTML = `<span style="color: ;">${product['ç­–ç•¥ç±»å‹'] || '-'}</span>`;
                    }
                    
                    // æ›´æ–°äº§å“ç­–ç•¥ï¼ˆå¢åŠ å®½åº¦ï¼‰
                    if (isUnmatched) {
                        strategyNameCell.innerHTML = `
                            <select onchange="updateProductClassification(${index}, 'strategyName', this.value)" style="padding: 4px 8px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 12px; width: 100%; min-width: 200px; position: relative; z-index: 100;">
                                <option value="" ${product['äº§å“ç­–ç•¥'] === '' ? 'selected' : ''}>æœªåŒ¹é…</option>
                                <option value="è¿›å–ç±»èµ„äº§ï¼ˆä¸»è§‚è‚¡ç¥¨å¤šå¤´ï¼‰" ${product['äº§å“ç­–ç•¥'] === 'è¿›å–ç±»èµ„äº§ï¼ˆä¸»è§‚è‚¡ç¥¨å¤šå¤´ï¼‰' ? 'selected' : ''}>è¿›å–ç±»èµ„äº§ï¼ˆä¸»è§‚è‚¡ç¥¨å¤šå¤´ï¼‰</option>
                                <option value="è¿›å–ç±»èµ„äº§ï¼ˆé‡åŒ–é€‰è‚¡ï¼‰" ${product['äº§å“ç­–ç•¥'] === 'è¿›å–ç±»èµ„äº§ï¼ˆé‡åŒ–é€‰è‚¡ï¼‰' ? 'selected' : ''}>è¿›å–ç±»èµ„äº§ï¼ˆé‡åŒ–é€‰è‚¡ï¼‰</option>
                                <option value="å¹³è¡¡ç±»èµ„äº§ï¼ˆCTAï¼‰" ${product['äº§å“ç­–ç•¥'] === 'å¹³è¡¡ç±»èµ„äº§ï¼ˆCTAï¼‰' ? 'selected' : ''}>å¹³è¡¡ç±»èµ„äº§ï¼ˆCTAï¼‰</option>
                                <option value="å¹³è¡¡ç±»èµ„äº§ï¼ˆå®è§‚å¯¹å†²ï¼‰" ${product['äº§å“ç­–ç•¥'] === 'å¹³è¡¡ç±»èµ„äº§ï¼ˆå®è§‚å¯¹å†²ï¼‰' ? 'selected' : ''}>å¹³è¡¡ç±»èµ„äº§ï¼ˆå®è§‚å¯¹å†²ï¼‰</option>
                                <option value="å¹³è¡¡ç±»èµ„äº§ï¼ˆå¤šç­–ç•¥ï¼‰" ${product['äº§å“ç­–ç•¥'] === 'å¹³è¡¡ç±»èµ„äº§ï¼ˆå¤šç­–ç•¥ï¼‰' ? 'selected' : ''}>å¹³è¡¡ç±»èµ„äº§ï¼ˆå¤šç­–ç•¥ï¼‰</option>
                                <option value="ç¨³å¥ç±»èµ„äº§ï¼ˆå¸‚åœºä¸­æ€§ï¼‰" ${product['äº§å“ç­–ç•¥'] === 'ç¨³å¥ç±»èµ„äº§ï¼ˆå¸‚åœºä¸­æ€§ï¼‰' ? 'selected' : ''}>ç¨³å¥ç±»èµ„äº§ï¼ˆå¸‚åœºä¸­æ€§ï¼‰</option>
                                <option value="ç¨³å¥ç±»èµ„äº§ï¼ˆå€ºåˆ¸ï¼‰" ${product['äº§å“ç­–ç•¥'] === 'ç¨³å¥ç±»èµ„äº§ï¼ˆå€ºåˆ¸ï¼‰' ? 'selected' : ''}>ç¨³å¥ç±»èµ„äº§ï¼ˆå€ºåˆ¸ï¼‰</option>
                            </select>
                        `;
                    } else {
                        strategyNameCell.innerHTML = `<span style="color: ;">${product['äº§å“ç­–ç•¥'] || '-'}</span>`;
                    }
                }
            }
            
            const fieldTypeNames = {
                'assetClass': 'èµ„äº§ç±»åˆ«',
                'strategyType': 'ç­–ç•¥ç±»å‹',
                'strategyName': 'äº§å“ç­–ç•¥'
            };
            
            showAlert(`âœ… ${fieldTypeNames[fieldType]}å·²æ›´æ–°`, 'success');
            
            // å®æ—¶åŒæ­¥åˆ°æ±‡æ€»é¡µ
            if (typeof updateSummary === 'function') {
                updateSummary();
            }
        }

        // ç¡®è®¤æ·»åŠ /ç¼–è¾‘äº§å“
        function confirmAddProduct() {
            const assetClass = document.getElementById('addAssetClass').value;
            const strategyType = document.getElementById('addStrategyType').value;
            const strategyName = document.getElementById('addStrategyName').value;
            const code = document.getElementById('addProductCode').value;
            const name = document.getElementById('addProductName').value;
            const minInvest = parseFloat(document.getElementById('addMinInvest').value);

            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!assetClass) {
                showAlert('è¯·é€‰æ‹©èµ„äº§ç±»åˆ«', 'error');
                return;
            }
            if (!strategyType) {
                showAlert('è¯·é€‰æ‹©ç­–ç•¥ç±»å‹', 'error');
                return;
            }
            if (!strategyName) {
                showAlert('è¯·é€‰æ‹©äº§å“ç­–ç•¥ç±»å‹', 'error');
                return;
            }
            if (!code) {
                showAlert('è¯·è¾“å…¥äº§å“ä»£ç ', 'error');
                return;
            }
            if (!name) {
                showAlert('è¯·è¾“å…¥äº§å“åç§°', 'error');
                return;
            }
            if (isNaN(minInvest) || minInvest < 0) {
                showAlert('è¯·è¾“å…¥æœ‰æ•ˆçš„èµ·æŠ•é—¨æ§›', 'error');
                return;
            }

            // åˆ¤æ–­æ˜¯æ·»åŠ è¿˜æ˜¯ç¼–è¾‘æ¨¡å¼
            const isEditMode = window.currentEditingIndex >= 0;

            if (isEditMode) {
                // ç¼–è¾‘æ¨¡å¼ï¼šæ›´æ–°äº§å“
                productPool[window.currentEditingIndex] = {
                    assetClass,
                    strategyType,
                    strategyName,
                    code,
                    name,
                    minInvest
                };
                showAlert('äº§å“å·²æ›´æ–°æˆåŠŸ', 'success');
            } else {
                // æ·»åŠ æ¨¡å¼ï¼šæ£€æŸ¥äº§å“ä»£ç æ˜¯å¦å·²å­˜åœ¨
                const exists = productPool.some(p => p.code === code);
                if (exists) {
                    showAlert('è¯¥äº§å“ä»£ç å·²å­˜åœ¨ï¼Œè¯·å‹¿é‡å¤æ·»åŠ ', 'error');
                    return;
                }

                // æ·»åŠ äº§å“
                productPool.push({ assetClass, strategyType, strategyName, code, name, minInvest });
                showAlert('äº§å“å·²æ·»åŠ æˆåŠŸ', 'success');
            }

            updatePoolTable();
            closeAddPoolModal();
        }

        // ä¸‹è½½å¯¼å…¥æ¨¡æ¿
        function downloadImportTemplate() {
            // åˆ›å»ºæ¨¡æ¿æ•°æ®
            const templateData = [
                {
                    'èµ„äº§ç±»åˆ«': 'è¿›å–ç±»',
                    'ç­–ç•¥ç±»å‹': 'ä¸»è§‚è‚¡ç¥¨å¤šå¤´',
                    'äº§å“ç­–ç•¥ç±»å‹ï¼ˆæŠ•èµ„æ–¹æ¡ˆç”¨ï¼‰': 'è¿›å–ç±»èµ„äº§ï¼ˆä¸»è§‚è‚¡ç¥¨å¤šå¤´ï¼‰',
                    'äº§å“ä»£ç ': 'EXAMPLE001',
                    'äº§å“åç§°': 'ç¤ºä¾‹äº§å“-ä¸»è§‚è‚¡ç¥¨å¤šå¤´',
                    'èµ·æŠ•é—¨æ§›ï¼ˆä¸‡å…ƒï¼‰': 100
                },
                {
                    'èµ„äº§ç±»åˆ«': 'å¹³è¡¡ç±»',
                    'ç­–ç•¥ç±»å‹': 'CTA',
                    'äº§å“ç­–ç•¥ç±»å‹ï¼ˆæŠ•èµ„æ–¹æ¡ˆç”¨ï¼‰': 'å¹³è¡¡ç±»èµ„äº§ï¼ˆCTAï¼‰',
                    'äº§å“ä»£ç ': 'EXAMPLE002',
                    'äº§å“åç§°': 'ç¤ºä¾‹äº§å“-CTA',
                    'èµ·æŠ•é—¨æ§›ï¼ˆä¸‡å…ƒï¼‰': 100
                },
                {
                    'èµ„äº§ç±»åˆ«': 'ç¨³å¥ç±»',
                    'ç­–ç•¥ç±»å‹': 'å¸‚åœºä¸­æ€§',
                    'äº§å“ç­–ç•¥ç±»å‹ï¼ˆæŠ•èµ„æ–¹æ¡ˆç”¨ï¼‰': 'ç¨³å¥ç±»èµ„äº§ï¼ˆå¸‚åœºä¸­æ€§ï¼‰',
                    'äº§å“ä»£ç ': 'EXAMPLE003',
                    'äº§å“åç§°': 'ç¤ºä¾‹äº§å“-å¸‚åœºä¸­æ€§',
                    'èµ·æŠ•é—¨æ§›ï¼ˆä¸‡å…ƒï¼‰': 100
                }
            ];

            // åˆ›å»ºExcelå·¥ä½œç°¿
            const wb = XLSX.utils.book_new();

            // åˆ›å»ºå·¥ä½œè¡¨
            const ws = XLSX.utils.json_to_sheet(templateData);

            // è®¾ç½®åˆ—å®½
            ws['!cols'] = [
                { wch: 12 }, // èµ„äº§ç±»åˆ«
                { wch: 20 }, // ç­–ç•¥ç±»å‹
                { wch: 30 }, // äº§å“ç­–ç•¥ç±»å‹ï¼ˆæŠ•èµ„æ–¹æ¡ˆç”¨ï¼‰
                { wch: 15 }, // äº§å“ä»£ç 
                { wch: 40 }, // äº§å“åç§°
                { wch: 12 }  // èµ·æŠ•é—¨æ§›
            ];

            // æ·»åŠ å·¥ä½œè¡¨åˆ°å·¥ä½œç°¿
            XLSX.utils.book_append_sheet(wb, ws, 'äº§å“æ± æ¨¡æ¿');

            // åˆ›å»ºä½¿ç”¨è¯´æ˜å·¥ä½œè¡¨
            const instructionsData = [
                ['äº§å“æ± å¯¼å…¥æ¨¡æ¿ä½¿ç”¨è¯´æ˜'],
                [''],
                ['ä¸€ã€å¡«å†™è¯´æ˜'],
                ['1. è¯·æŒ‰ç…§ä»¥ä¸‹æ ¼å¼å¡«å†™äº§å“ä¿¡æ¯'],
                ['2. æ‰€æœ‰å¸¦ * çš„å­—æ®µä¸ºå¿…å¡«é¡¹'],
                ['3. äº§å“ä»£ç å¿…é¡»å”¯ä¸€ï¼Œä¸èƒ½é‡å¤'],
                [''],
                ['äºŒã€å­—æ®µè¯´æ˜'],
                ['å­—æ®µåç§°', 'å¡«å†™è¦æ±‚', 'å¯é€‰å€¼'],
                ['èµ„äº§ç±»åˆ«', 'å¿…å¡«', 'è¿›å–ç±»/å¹³è¡¡ç±»/ç¨³å¥ç±»'],
                ['ç­–ç•¥ç±»å‹', 'å¿…å¡«', 'æ ¹æ®èµ„äº§ç±»åˆ«é€‰æ‹©ï¼ˆè¯¦è§ä¸‹æ–¹ï¼‰'],
                ['äº§å“ç­–ç•¥ç±»å‹ï¼ˆæŠ•èµ„æ–¹æ¡ˆç”¨ï¼‰', 'å¿…å¡«', 'æ ¹æ®ç­–ç•¥ç±»å‹è‡ªåŠ¨æ˜ å°„ï¼ˆè¯¦è§ä¸‹æ–¹ï¼‰'],
                ['äº§å“ä»£ç ', 'å¿…å¡«', 'å”¯ä¸€æ ‡è¯†ï¼Œä¸èƒ½é‡å¤'],
                ['äº§å“åç§°', 'å¿…å¡«', 'äº§å“å®Œæ•´åç§°'],
                ['èµ·æŠ•é—¨æ§›ï¼ˆä¸‡å…ƒï¼‰', 'å¿…å¡«', 'æ•°å­—ï¼Œä¾‹å¦‚ï¼š100'],
                [''],
                ['ä¸‰ã€ç­–ç•¥ç±»å‹æ˜ å°„å…³ç³»'],
                ['èµ„äº§ç±»åˆ«', 'ç­–ç•¥ç±»å‹', 'äº§å“ç­–ç•¥ç±»å‹ï¼ˆæŠ•èµ„æ–¹æ¡ˆç”¨ï¼‰'],
                ['è¿›å–ç±»', 'ä¸»è§‚è‚¡ç¥¨å¤šå¤´', 'è¿›å–ç±»èµ„äº§ï¼ˆä¸»è§‚è‚¡ç¥¨å¤šå¤´ï¼‰'],
                ['è¿›å–ç±»', 'é‡åŒ–é€‰è‚¡', 'è¿›å–ç±»èµ„äº§ï¼ˆé‡åŒ–é€‰è‚¡ï¼‰'],
                ['è¿›å–ç±»', 'ç§å‹Ÿä¸»è§‚', 'è¿›å–ç±»èµ„äº§ï¼ˆä¸»è§‚è‚¡ç¥¨å¤šå¤´ï¼‰'],
                ['è¿›å–ç±»', 'é‡åŒ–æŒ‡å¢', 'è¿›å–ç±»èµ„äº§ï¼ˆé‡åŒ–é€‰è‚¡ï¼‰'],
                ['å¹³è¡¡ç±»', 'CTA', 'å¹³è¡¡ç±»èµ„äº§ï¼ˆCTAï¼‰'],
                ['å¹³è¡¡ç±»', 'å¤šç­–ç•¥', 'å¹³è¡¡ç±»èµ„äº§ï¼ˆå¤šç­–ç•¥ï¼‰'],
                ['å¹³è¡¡ç±»', 'å®è§‚å¯¹å†²', 'å¹³è¡¡ç±»èµ„äº§ï¼ˆå®è§‚å¯¹å†²ï¼‰'],
                ['ç¨³å¥ç±»', 'å¸‚åœºä¸­æ€§', 'ç¨³å¥ç±»èµ„äº§ï¼ˆå¸‚åœºä¸­æ€§ï¼‰'],
                ['ç¨³å¥ç±»', 'æµ·å¤–å€ºåˆ¸', 'ç¨³å¥ç±»èµ„äº§ï¼ˆå€ºåˆ¸ï¼‰'],
                ['ç¨³å¥ç±»', 'å›ºå®šæ”¶ç›Šï¼ˆç§å‹Ÿå€ºï¼‰', 'ç¨³å¥ç±»èµ„äº§ï¼ˆå€ºåˆ¸ï¼‰'],
                [''],
                ['å››ã€æ³¨æ„äº‹é¡¹'],
                ['1. è¯·å‹¿ä¿®æ”¹è¡¨å¤´ï¼Œå¦åˆ™å¯¼å…¥å¤±è´¥'],
                ['2. åˆ é™¤ç¤ºä¾‹æ•°æ®åå†å¡«å†™çœŸå®æ•°æ®'],
                ['3. äº§å“ä»£ç ä¸èƒ½åŒ…å«ç‰¹æ®Šå­—ç¬¦'],
                ['4. èµ·æŠ•é—¨æ§›å¿…é¡»ä¸ºæ­£æ•°'],
                ['5. å¯¼å…¥å‰è¯·å…ˆæ£€æŸ¥æ•°æ®æ ¼å¼æ˜¯å¦æ­£ç¡®'],
                [''],
                ['äº”ã€å¯¼å…¥æ–¹æ³•'],
                ['1. ä¸‹è½½æ­¤æ¨¡æ¿æ–‡ä»¶'],
                ['2. åœ¨Excelä¸­å¡«å†™äº§å“æ•°æ®'],
                ['3. ä¿å­˜æ–‡ä»¶'],
                ['4. åœ¨å·¥å…·ä¸­ç‚¹å‡»"å¯¼å…¥äº§å“"æŒ‰é’®'],
                ['5. é€‰æ‹©æ­¤æ–‡ä»¶å®Œæˆå¯¼å…¥']
            ];

            const wsInstructions = XLSX.utils.aoa_to_sheet(instructionsData);
            wsInstructions['!cols'] = [
                { wch: 40 },
                { wch: 50 },
                { wch: 40 }
            ];

            // æ·»åŠ è¯´æ˜å·¥ä½œè¡¨åˆ°å·¥ä½œç°¿
            XLSX.utils.book_append_sheet(wb, wsInstructions, 'ä½¿ç”¨è¯´æ˜');

            // ä¸‹è½½æ–‡ä»¶
            XLSX.writeFile(wb, 'äº§å“æ± å¯¼å…¥æ¨¡æ¿.xlsx');
            showAlert('âœ… å¯¼å…¥æ¨¡æ¿å·²ä¸‹è½½ï¼ˆåŒ…å«ä½¿ç”¨è¯´æ˜ï¼‰', 'success');
        }

        // åˆ é™¤äº§å“
        function deleteProduct(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªäº§å“å—ï¼Ÿ')) {
                productPool.splice(index, 1);
                updatePoolTable();
                showAlert('äº§å“å·²åˆ é™¤', 'success');
            }
        }

        // å¯¼å…¥äº§å“
        function importProducts() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (Array.isArray(data)) {
                            productPool = data;
                            updatePoolTable();
                            showAlert('äº§å“å·²å¯¼å…¥', 'success');
                        } else {
                            showAlert('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®', 'error');
                        }
                    } catch (error) {
                        showAlert('æ–‡ä»¶è§£æå¤±è´¥', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // æ›´æ–°æ€»å¸‚å€¼
        function updateTotalMarketValue() {
            const value = parseFloat(document.getElementById('totalMarketValue').value);
            if (!isNaN(value) && value >= 0) {
                totalMarketValue = value;
                showAlert('ä¸“æˆ·æ€»å¸‚å€¼å·²æ›´æ–°', 'success');
            } else {
                showAlert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ€»å¸‚å€¼', 'error');
            }
        }

        // æ›´æ–°æ±‡æ€»
        function updateSummary() {
            // æ£€æŸ¥æ˜¯å¦å·²å¯¼å…¥æŒä»“æ•°æ®
            if (!hasImportedHoldings) {
                document.getElementById('summaryTotalValue').textContent = 'è¯·å…ˆå¯¼å…¥æŒä»“æ•°æ®';
                document.getElementById('summaryBuyAmount').textContent = '0.00 ä¸‡å…ƒ';
                            document.getElementById('summarySellAmount').textContent = '0.00 ä¸‡å…ƒ';
                return;
            }
        
            document.getElementById('totalMarketValue').value = totalMarketValue.toFixed(2);
        
            const totalBuyAmount = buyOrders.filter(o => o.checked).reduce((sum, o) => sum + o.amount, 0);
            const totalSellAmount = sellOrders.filter(o => o.checked).reduce((sum, o) => sum + (o.redeemShares * o.currentNav), 0);
            // è°ƒä»“åä¸“æˆ·æ€»å¸‚å€¼ä¿æŒä¸å˜
            const adjustedValue = totalMarketValue;
        
            document.getElementById('summaryTotalValue').textContent = totalMarketValue.toFixed(2) + ' ä¸‡å…ƒ';
                        document.getElementById('summaryBuyAmount').textContent = totalBuyAmount.toFixed(2) + ' ä¸‡å…ƒ';
                        document.getElementById('summarySellAmount').textContent = totalSellAmount.toFixed(2) + ' ä¸‡å…ƒ';
            updateAllocationAfterAdjustment(adjustedValue);
        }
// æ›´æ–°è°ƒä»“åçš„æŒä»“åˆ†å¸ƒæƒé‡
function updateAllocationAfterAdjustment(adjustedValue) {
    // æ£€æŸ¥æ˜¯å¦å·²å¯¼å…¥æŒä»“æ•°æ®
    if (!hasImportedHoldings) {
        document.getElementById('summaryAllocationTable').style.display = 'none';
        document.getElementById('summaryAllocationEmptyState').style.display = 'block';
        return;
    }

    document.getElementById('summaryAllocationTable').style.display = 'table';
    document.getElementById('summaryAllocationEmptyState').style.display = 'none';

    const tbody = document.getElementById('summaryAllocationTableBody');
    tbody.innerHTML = '';

    // 1. è®¡ç®—æ¯ä¸ªå·²æŠ•åŸºé‡‘äº§å“çš„è°ƒä»“åå¸‚å€¼
    const fundAllocation = [];

    // è·å–å½“å‰æŒä»“ä¸­çš„å·²æŠ•åŸºé‡‘
    const investFunds = holdings.filter(h => h.category === 'å·²æŠ•åŸºé‡‘');

    investFunds.forEach(fund => {
        // ä½¿ç”¨æŒä»“tabä¸­çš„å¸‚å€¼ï¼ˆä¼°å€¼è¡¨ç›´æ¥æå–çš„å€¼ï¼‰
        const currentValue = fund.marketValue || 0;

        // æ£€æŸ¥è¯¥åŸºé‡‘æ˜¯å¦æœ‰å–å‡ºè®¢å•
        const sellOrder = sellOrders.find(o => o.productName === fund.name && o.checked);
        let sellValue = 0;
        let isSold = false;
        let remainingValue = currentValue; // é¢„è®¡èµå›åå‰©ä½™å¸‚å€¼
        if (sellOrder) {
            sellValue = sellOrder.redeemShares * sellOrder.currentNav;
            remainingValue = currentValue - sellValue; // è®¡ç®—èµå›åå‰©ä½™å¸‚å€¼
            isSold = true;
        }

        // æ£€æŸ¥è¯¥åŸºé‡‘æ˜¯å¦æœ‰è¿½åŠ ä¹°å…¥ï¼ˆé€šè¿‡äº§å“åç§°åŒ¹é…ï¼‰
        let buyOrder = buyOrders.find(o => o.productName === fund.name && o.checked);
        let buyValue = 0;
        
        // å¦‚æœé€šè¿‡åç§°æ²¡æ‰¾åˆ°ï¼Œå°è¯•é€šè¿‡äº§å“ä»£ç åŒ¹é…
        if (!buyOrder) {
            // è·å–æŒä»“äº§å“çš„ä»£ç 
            let lookupName = fund.name;
            if (fund.name.includes(' â˜…')) {
                lookupName = fund.name.replace(' â˜…', '');
            }
            const holdingProduct = productMapping[lookupName] || productPool.find(p => p.name === lookupName);
            
            if (holdingProduct && holdingProduct.code) {
                // åœ¨ä¹°å…¥åˆ—è¡¨ä¸­æŸ¥æ‰¾ç›¸åŒäº§å“ä»£ç çš„è®¢å•
                buyOrder = buyOrders.find(o => {
                    const buyProduct = productPool.find(p => p.name === o.productName);
                    return buyProduct && buyProduct.code === holdingProduct.code && o.checked;
                });
            }
        }
        
        if (buyOrder) {
            buyValue = buyOrder.amount;
        }

        // è°ƒä»“åå¸‚å€¼ = é¢„è®¡èµå›åå‰©ä½™å¸‚å€¼ + ä¹°å…¥é‡‘é¢
        const adjustedValue_fund = remainingValue + buyValue;

        // è·å–ç­–ç•¥ç±»å‹ï¼šä¼˜å…ˆä½¿ç”¨holdingsæ•°ç»„ä¸­çš„ç­–ç•¥ç±»å‹ï¼ˆç”¨æˆ·æ‰‹åŠ¨ä¿®æ”¹çš„å€¼ï¼‰
        let strategyType = fund.strategyName || fund.strategyType || '';

        // å¦‚æœholdingsä¸­æ²¡æœ‰ç­–ç•¥ç±»å‹ï¼Œåˆ™å°è¯•ä»productMappingè·å–
        if (!strategyType) {
            // ä¼˜å…ˆä½¿ç”¨åŸå§‹åç§°æŸ¥æ‰¾ï¼ˆå› ä¸ºfund.nameå¯èƒ½å·²è¢«ä¿®æ”¹ä¸ºå¸¦" â˜…"çš„åç§°ï¼‰
            let lookupName = fund.name;
            if (fund.originalName) {
                lookupName = fund.originalName;
            } else if (lookupName.includes(' â˜…')) {
                lookupName = lookupName.replace(' â˜…', '');
            }

            const matchedProduct = productMapping[lookupName];
            if (matchedProduct && matchedProduct.matched && matchedProduct.code) {
                // å·²åŒ¹é…åˆ°äº§å“æ± ä¸­çš„äº§å“ï¼Œä½¿ç”¨äº§å“æ± çš„strategyNameå­—æ®µï¼ˆæŠ•èµ„æ–¹æ¡ˆç”¨çš„ç­–ç•¥ç±»å‹ï¼‰
                strategyType = matchedProduct.strategyName || matchedProduct.strategyType || '';
            } else {
                // æœªåŒ¹é…ï¼Œå°è¯•ç”¨åŸå§‹åç§°åœ¨äº§å“æ± ä¸­æŸ¥æ‰¾
                const product = productPool.find(p => p.name === lookupName);
                strategyType = product ? (product.strategyName || product.strategyType) : '';
            }
        }

        fundAllocation.push({
            index: fund.index,
            name: fund.name,
            strategyType: strategyType,
            currentValue: currentValue,
            adjustedValue: adjustedValue_fund,
            isSold: isSold,
            sellValue: sellValue,
            buyValue: buyValue
        });
    });

    // 2. æ·»åŠ ä¹°å…¥çš„äº§å“ï¼ˆæ–°è¿›å…¥æŒä»“ï¼Œæ’é™¤å·²è¿½åŠ çš„äº§å“ï¼‰
    buyOrders.filter(o => o.checked).forEach(order => {
        // æ£€æŸ¥è¯¥äº§å“æ˜¯å¦å·²ç»åœ¨æŒä»“ä¸­ï¼ˆè¿½åŠ çš„æƒ…å†µï¼‰
        // å…ˆå°è¯•é€šè¿‡äº§å“åç§°åŒ¹é…
        let existingFund = fundAllocation.find(f => f.name === order.productName);
        let isExisting = !!existingFund;
        
        // å¦‚æœåç§°ä¸åŒ¹é…ï¼Œå°è¯•é€šè¿‡äº§å“ä»£ç åŒ¹é…ï¼ˆå¤„ç†äº§å“åŒ¹é…é”™è¯¯çš„æƒ…å†µï¼‰
        if (!existingFund) {
            // è·å–ä¹°å…¥è®¢å•çš„äº§å“ä»£ç 
            const buyProduct = productPool.find(p => p.name === order.productName);
            if (buyProduct && buyProduct.code) {
                // åœ¨æŒä»“ä¸­æŸ¥æ‰¾ç›¸åŒäº§å“ä»£ç çš„äº§å“
                fundAllocation.forEach(fund => {
                    if (fund.name === order.productName) {
                        // åç§°å·²ç»åŒ¹é…ï¼Œä¸éœ€è¦ç»§ç»­æŸ¥æ‰¾
                        isExisting = true;
                        existingFund = fund;
                        return;
                    }
                    
                    // ä»productMappingä¸­è·å–æŒä»“äº§å“çš„ä»£ç 
                    let lookupName = fund.name;
                    if (fund.name.includes(' â˜…')) {
                        lookupName = fund.name.replace(' â˜…', '');
                    }
                    const matchedProduct = productMapping[lookupName] || productPool.find(p => p.name === lookupName);
                    
                    if (matchedProduct && matchedProduct.code === buyProduct.code) {
                        // æ›´æ–°ç°æœ‰æŒä»“ï¼Œæ ‡è®°ä¸ºå·²æ‰¾åˆ°
                        isExisting = true;
                        existingFund = fund;
                    }
                });
            }
        }
        
        // å¦‚æœä¸åœ¨æŒä»“ä¸­ï¼Œæ‰æ·»åŠ ä¸ºæ–°äº§å“
        if (!isExisting || !existingFund) {
            const product = productPool.find(p => p.name === order.productName);
            // ä½¿ç”¨strategyNameå­—æ®µï¼ˆæŠ•èµ„æ–¹æ¡ˆç”¨çš„ç­–ç•¥ç±»å‹ï¼‰
            const strategyType = product ? (product.strategyName || product.strategyType) : '';

            fundAllocation.push({
                index: 'æ–°',
                name: order.productName,
                strategyType: strategyType,
                currentValue: 0,
                adjustedValue: order.amount,
                isSold: false,
                sellValue: 0,
                buyValue: order.amount
            });
        }
        // è¿½åŠ æ“ä½œå·²ç»åœ¨ç¬¬1æ­¥ä¸­å¤„ç†è¿‡äº†ï¼ˆä¹°å…¥é‡‘é¢å·²åŠ åˆ°æŒä»“çš„buyValueä¸­ï¼‰
        // è¿™é‡Œä¸éœ€è¦å†æ¬¡æ·»åŠ åˆ°fundAllocation
    });

    // 3. è®¡ç®—å æ¯”å¹¶æ¸²æŸ“è¡¨æ ¼
    let totalCurrentValue = 0;
    let totalAdjustedValue = 0;

    fundAllocation.forEach(fund => {
        totalCurrentValue += fund.currentValue;
        totalAdjustedValue += fund.adjustedValue;

        const percentage = totalMarketValue > 0 ? ((fund.adjustedValue / totalMarketValue) * 100).toFixed(1) : '0.0';

        // åˆ¤æ–­æ“ä½œçŠ¶æ€
        const soldBadge = fund.isSold ? '<span class="badge badge-danger" style="margin-left: 6px;">å–å‡º</span>' : '';
        const newBadge = fund.index === 'æ–°' ? '<span class="badge badge-success" style="margin-left: 6px;">æ–°å¢</span>' : '';
        // è¿½åŠ æ ‡è¯†ï¼šå·²æœ‰äº§å“ä¸”æœ‰ä¹°å…¥é‡‘é¢
        const appendBadge = (fund.index !== 'æ–°' && fund.buyValue > 0 && !fund.isSold) ? '<span class="badge badge-info" style="margin-left: 6px;">è¿½åŠ </span>' : '';
        // è°ƒä»“æ ‡è¯†ï¼šæ—¢æœ‰å–å‡ºåˆæœ‰ä¹°å…¥
        const adjustBadge = (fund.isSold && fund.buyValue > 0) ? '<span class="badge badge-warning" style="margin-left: 6px;">è°ƒä»“</span>' : '';

        const row = document.createElement('tr');
        row.innerHTML = `
            <td style="text-align: center;">${fund.index}</td>
            <td>${fund.name}${soldBadge}${newBadge}${appendBadge}${adjustBadge}</td>
            <td>${fund.strategyType}</td>
            <td style="text-align: center;">${fund.currentValue.toFixed(2)}</td>
            <td style="text-align: center;">${fund.adjustedValue.toFixed(2)}</td>
            <td style="text-align: center;">${percentage}%</td>
        `;
        tbody.appendChild(row);
    });
}

        // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
        function saveData() {
            const data = {
                version: APP_VERSION,
                saveTime: new Date().toISOString(),
                buyOrders: buyOrders,
                sellOrders: sellOrders,
                holdings: holdings,
                productPool: productPool,
                totalMarketValue: totalMarketValue
            };
            localStorage.setItem('investmentData', JSON.stringify(data));
            showAlert('âœ… æ•°æ®å·²æˆåŠŸä¿å­˜', 'success');
        }

        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®
        function loadData() {
            const data = localStorage.getItem('investmentData');
            if (data) {
                try {
                    const parsed = JSON.parse(data);

                    // ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥
                    if (parsed.version && parsed.version !== APP_VERSION) {
                        if (!confirm(`æ£€æµ‹åˆ°æ•°æ®ç‰ˆæœ¬ä¸º ${parsed.version}ï¼Œå½“å‰å·¥å…·ç‰ˆæœ¬ä¸º ${APP_VERSION}ã€‚\næ˜¯å¦ç»§ç»­åŠ è½½æ•°æ®ï¼Ÿ\n\nå»ºè®®ï¼šå¦‚æœç‰ˆæœ¬å·®å¼‚è¾ƒå¤§ï¼Œå»ºè®®å¯¼å‡ºæ•°æ®åæ¸…ç©ºé‡ç½®ã€‚`)) {
                            return;
                        }
                    }

                    buyOrders = parsed.buyOrders || [];
                    sellOrders = parsed.sellOrders || [];
                    holdings = parsed.holdings || [];
                    // åªæœ‰å½“ä¿å­˜çš„äº§å“æ± æ•°æ®ä¸ä¸ºç©ºæ—¶æ‰è¦†ç›–åˆå§‹åŒ–æ•°æ®
                    if (parsed.productPool && parsed.productPool.length > 0) {
                        productPool = parsed.productPool;
                    }
                    totalMarketValue = parsed.totalMarketValue || 4937.94;

                    const saveTime = parsed.saveTime ? new Date(parsed.saveTime).toLocaleString('zh-CN') : 'æœªçŸ¥';
                    showAlert(`âœ… æ•°æ®å·²åŠ è½½ (ä¿å­˜æ—¶é—´: ${saveTime})`, 'success');

                    updateSummary();
                    updatePoolTable(); // åŠ è½½æ•°æ®åæ›´æ–°äº§å“æ± è¡¨æ ¼
                } catch (error) {
                    showAlert('âŒ æ•°æ®åŠ è½½å¤±è´¥ï¼š' + error.message, 'error');
                }
            } else {
                showAlert('âš ï¸ æ²¡æœ‰æ‰¾åˆ°ä¿å­˜çš„æ•°æ®', 'error');
            }
        }

        // å¯¼å‡ºæ•°æ®å¤‡ä»½
        function exportBackup() {
            const data = {
                version: APP_VERSION,
                exportTime: new Date().toISOString(),
                buyOrders: buyOrders,
                sellOrders: sellOrders,
                holdings: holdings,
                productPool: productPool,
                totalMarketValue: totalMarketValue
            };
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `æŠ•èµ„æ–¹æ¡ˆå¤‡ä»½_${new Date().getTime()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showAlert('âœ… æ•°æ®å¤‡ä»½å·²å¯¼å‡º', 'success');
        }

        // å¯¼å…¥æ•°æ®å¤‡ä»½
        function importBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);

                        // éªŒè¯æ•°æ®æ ¼å¼
                        if (!data.version) {
                            throw new Error('æ— æ•ˆçš„å¤‡ä»½æ–‡ä»¶æ ¼å¼');
                        }

                        // ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥
                        if (data.version !== APP_VERSION) {
                            if (!confirm(`å¤‡ä»½æ–‡ä»¶ç‰ˆæœ¬ä¸º ${data.version}ï¼Œå½“å‰å·¥å…·ç‰ˆæœ¬ä¸º ${APP_VERSION}ã€‚\næ˜¯å¦ç»§ç»­å¯¼å…¥ï¼Ÿ`)) {
                                return;
                            }
                        }

                        if (confirm(`å³å°†å¯¼å…¥å¤‡ä»½æ–‡ä»¶ï¼ˆä¿å­˜æ—¶é—´ï¼š${data.exportTime ? new Date(data.exportTime).toLocaleString('zh-CN') : 'æœªçŸ¥'}ï¼‰\n\nâš ï¸ æ­¤æ“ä½œå°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ`)) {
                            buyOrders = data.buyOrders || [];
                            sellOrders = data.sellOrders || [];
                            holdings = data.holdings || [];
                            productPool = data.productPool || [];
                            totalMarketValue = data.totalMarketValue || 4937.94;

                            updateSummary();
                            updatePoolTable();
                            showAlert('âœ… æ•°æ®å¤‡ä»½å·²æˆåŠŸå¯¼å…¥', 'success');
                        }
                    } catch (error) {
                        showAlert('âŒ å¤‡ä»½æ–‡ä»¶å¯¼å…¥å¤±è´¥ï¼š' + error.message, 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // æ¸…ç©ºæ•°æ®
        function clearData() {
            showConfirmModal(
                'æ¸…ç©ºæ‰€æœ‰æ•°æ®',
                'âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼å»ºè®®å…ˆå¯¼å‡ºå¤‡ä»½ï¼',
                function() {
                    buyOrders = [];
                    sellOrders = [];
                    holdings = [];
                    // ä¿ç•™äº§å“æ± ï¼Œä¸æ¸…ç©º
                    totalMarketValue = 4937.94;
                    localStorage.removeItem('investmentData');
                    
                    // éšè—å½“å‰ä¼°å€¼è¡¨äº§å“åç§°æ˜¾ç¤º
                    document.getElementById('currentValuationProduct').style.display = 'none';
                    document.getElementById('currentValuationProductName').textContent = '';
                    
                    updateSummary();
                    showAlert('âœ… æ‰€æœ‰æ•°æ®å·²æ¸…ç©º', 'success');
                },
                'ç¡®è®¤æ¸…ç©º'
            );
        }

        // å¯¼å‡ºä¸ºExcelï¼ˆå®Œæ•´çš„æŠ•èµ„æ–¹æ¡ˆï¼‰
        function exportToExcel() {
            // åˆ›å»ºå·¥ä½œç°¿
            const workbook = XLSX.utils.book_new();

            // 1. ä¸“æˆ·æ¦‚å†µsheet
            const overviewData = [
                ['ä¸“æˆ·æ¦‚å†µ'],
                [''],
                ['é¡¹ç›®', 'é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰', 'è¯´æ˜'],
                ['ä¸“æˆ·æ€»å¸‚å€¼', totalMarketValue, 'å¯¼å…¥ä¼°å€¼è¡¨åè‡ªåŠ¨è·å–'],
                ['åŸºé‡‘èµ„äº§å‡€å€¼', fundAssetValue || '--', 'ä»ä¼°å€¼è¡¨æå–'],
                ['ä¹°å…¥ä¸Šé™ï¼ˆå¯ç”¨èµ„é‡‘-å¾…ä»˜è´¹ç”¨ï¼‰', hasImportedHoldings ? investableAmount : '--', 'å¯æŠ•ç§‘ç›®æ€»é‡‘é¢å‡å»éœ€æ”¯ä»˜ç§‘ç›®æ€»é‡‘é¢'],
                ['ä¹°å…¥æ€»é‡‘é¢ï¼ˆå·²å‹¾é€‰ï¼‰', buyOrders.filter(o => o.checked).reduce((sum, o) => sum + o.amount, 0), 'æ‰€æœ‰å‹¾é€‰çš„ä¹°å…¥è®¢å•é‡‘é¢æ€»å’Œ'],
                ['å–å‡ºæ€»é‡‘é¢ï¼ˆå·²å‹¾é€‰ï¼‰', sellOrders.filter(o => o.checked).reduce((sum, o) => sum + (o.redeemShares * o.currentNav), 0), 'æ‰€æœ‰å‹¾é€‰çš„å–å‡ºè®¢å•èµå›é‡‘é¢æ€»å’Œ'],
                ['è°ƒæ•´åæ€»å¸‚å€¼', totalMarketValue, 'ä¹°å…¥é‡‘é¢å‡å»å–å‡ºé‡‘é¢ï¼Œæ€»å¸‚å€¼ä¿æŒä¸å˜'],
                [''],
                ['å¯æŠ•ç§‘ç›®æ˜ç»†'],
                ['ç§‘ç›®', 'å¸‚å€¼ï¼ˆä¸‡å…ƒï¼‰'],
                ['æ´»æœŸå­˜æ¬¾', holdings.filter(h => h.category === 'å¯æŠ•ç§‘ç›®' && h.name === 'æ´»æœŸå­˜æ¬¾').reduce((sum, h) => sum + (h.marketValue || 0), 0)],
                ['è´§å¸åŸºé‡‘', holdings.filter(h => h.category === 'å¯æŠ•ç§‘ç›®' && h.name === 'è´§å¸åŸºé‡‘').reduce((sum, h) => sum + (h.marketValue || 0), 0)],
                ['å°è®¡', holdings.filter(h => h.category === 'å¯æŠ•ç§‘ç›®').reduce((sum, h) => sum + (h.marketValue || 0), 0)],
                [''],
                ['éœ€æ”¯ä»˜ç§‘ç›®æ˜ç»†'],
                ['ç§‘ç›®', 'å¸‚å€¼ï¼ˆä¸‡å…ƒï¼‰', 'ç§‘ç›®ä»£ç '],
                ['åº”ä»˜å¤–åŒ…æœåŠ¡è´¹', holdings.filter(h => h.category === 'éœ€æ”¯ä»˜ç§‘ç›®' && h.name === 'åº”ä»˜å¤–åŒ…æœåŠ¡è´¹').reduce((sum, h) => sum + (h.marketValue || 0), 0), '2205'],
                ['åº”ä»˜ç®¡ç†äººæŠ¥é…¬', holdings.filter(h => h.category === 'éœ€æ”¯ä»˜ç§‘ç›®' && h.name === 'åº”ä»˜ç®¡ç†äººæŠ¥é…¬').reduce((sum, h) => sum + (h.marketValue || 0), 0), '2206'],
                ['åº”ä»˜æ‰˜ç®¡è´¹', holdings.filter(h => h.category === 'éœ€æ”¯ä»˜ç§‘ç›®' && h.name === 'åº”ä»˜æ‰˜ç®¡è´¹').reduce((sum, h) => sum + (h.marketValue || 0), 0), '2207'],
                ['å°è®¡', holdings.filter(h => h.category === 'éœ€æ”¯ä»˜ç§‘ç›®').reduce((sum, h) => sum + (h.marketValue || 0), 0), '']
            ];
            const overviewSheet = XLSX.utils.aoa_to_sheet(overviewData);
            XLSX.utils.book_append_sheet(workbook, overviewSheet, 'ä¸“æˆ·æ¦‚å†µ');

            // 2. å½“å‰æŒä»“sheetï¼ˆä½¿ç”¨ä¼°å€¼è¡¨ç›´æ¥æå–çš„å¸‚å€¼ï¼‰
            const holdingData = [
                ['å½“å‰æŒä»“æ˜ç»†'],
                ['åºå·', 'äº§å“ä»£ç ', 'äº§å“åç§°', 'èµ„äº§ç±»åˆ«', 'ç­–ç•¥ç±»å‹', 'å½“å‰ä»½é¢ï¼ˆä¸‡ä»½ï¼‰', 'æ ‡çš„å‡€å€¼', 'å½“å‰å¸‚å€¼ï¼ˆä¸‡å…ƒï¼‰', 'å å‡€å€¼æ¯”ä¾‹ï¼ˆ%ï¼‰', 'åŸºé‡‘èµ„äº§å‡€å€¼ï¼ˆä¸‡å…ƒï¼‰']
            ];
            const investFunds = holdings.filter(h => h.category === 'å·²æŠ•åŸºé‡‘');
            const holdingTotalValue = investFunds.reduce((sum, h) => sum + (h.marketValue || 0), 0);
            investFunds.forEach((holding, index) => {
                const marketValue = holding.marketValue || 0;
                const percentage = holdingTotalValue > 0 ? (marketValue / holdingTotalValue) * 100 : 0;
                
                // è·å–äº§å“ä»£ç å’Œç­–ç•¥ä¿¡æ¯
                let productCode = holding.productCode || '';
                let assetClass = holding.assetClass || '';
                let strategyType = holding.strategyName || holding.strategyType || '';
                
                // å¦‚æœæ²¡æœ‰åŒ¹é…ï¼Œå°è¯•ä»productMappingè·å–
                if (!productCode && holding.originalName) {
                    const matchedProduct = productMapping[holding.originalName];
                    if (matchedProduct && matchedProduct.matched) {
                        productCode = matchedProduct.code || '';
                        assetClass = matchedProduct.assetClass || '';
                        strategyType = matchedProduct.strategyName || '';
                    }
                }
                
                holdingData.push([
                    index + 1,
                    productCode || '--',
                    holding.name,
                    assetClass || '--',
                    strategyType || '--',
                    holding.shares || 0,
                    holding.nav || 0,
                    marketValue,
                    percentage.toFixed(2),
                    holding.fundNav || '--'
                ]);
            });
            const holdingSheet = XLSX.utils.aoa_to_sheet(holdingData);
            XLSX.utils.book_append_sheet(workbook, holdingSheet, 'å½“å‰æŒä»“');

            // 3. ä¹°å…¥æ˜ç»†sheet
            const buyData = [
                ['ä¹°å…¥æ˜ç»†'],
                ['åºå·', 'äº§å“ä»£ç ', 'äº§å“åç§°', 'èµ„äº§ç±»åˆ«', 'ç­–ç•¥ç±»å‹', 'ç”³è´­é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰', 'é¢„è®¡æŠ•åæ¯”ä¾‹ï¼ˆ%ï¼‰', 'æŠ•åæ¯”ä¾‹æ ¡éªŒ']
            ];
            buyOrders.filter(o => o.checked).forEach((order, index) => {
                const percentage = (order.amount / totalMarketValue) * 100;
                let validation = 'âœ“ æ­£å¸¸';
                if (percentage >= 30) validation = 'âš  â‰¥30%';
                
                // ä»äº§å“æ± è·å–äº§å“ä¿¡æ¯
                const product = productPool.find(p => p.name === order.productName);
                const productCode = product ? product.code : '';
                const assetClass = product ? product.assetClass : '';
                const strategyType = product ? (product.strategyName || product.strategyType) : '';
                
                buyData.push([
                    index + 1,
                    productCode || '--',
                    order.productName,
                    assetClass || '--',
                    strategyType || '--',
                    order.amount,
                    percentage.toFixed(2),
                    validation
                ]);
            });
            const buySheet = XLSX.utils.aoa_to_sheet(buyData);
            XLSX.utils.book_append_sheet(workbook, buySheet, 'ä¹°å…¥æ˜ç»†');

            // 4. å–å‡ºæ˜ç»†sheet
            const sellData = [
                ['å–å‡ºæ˜ç»†'],
                ['åºå·', 'äº§å“ä»£ç ', 'äº§å“åç§°', 'èµ„äº§ç±»åˆ«', 'ç­–ç•¥ç±»å‹', 'å½“å‰å‡€å€¼', 'å½“å‰ä»½é¢ï¼ˆä¸‡ä»½ï¼‰', 'è®¡åˆ’èµå›ä»½é¢ï¼ˆä¸‡ä»½ï¼‰', 'èµå›é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰', 'èµå›åå‰©ä½™å¸‚å€¼ï¼ˆä¸‡å…ƒï¼‰', 'é¢„è®¡æŠ•åæ¯”ä¾‹ï¼ˆ%ï¼‰', 'æŠ•åæ¯”ä¾‹æ ¡éªŒ']
            ];
            sellOrders.filter(o => o.checked).forEach((order, index) => {
                const percentage = (order.remainingValue / totalMarketValue) * 100;
                let validation = 'âœ“ æ­£å¸¸';
                if (percentage >= 30) validation = 'âš  â‰¥30%';
                
                // ä»æŒä»“è·å–äº§å“ä¿¡æ¯
                const holding = holdings.find(h => h.name === order.productName && h.category === 'å·²æŠ•åŸºé‡‘');
                let productCode = holding ? holding.productCode : '';
                let assetClass = holding ? holding.assetClass : '';
                let strategyType = holding ? (holding.strategyName || holding.strategyType) : '';
                
                // å¦‚æœæ²¡æœ‰ï¼Œä»productMappingè·å–
                if (!productCode && holding && holding.originalName) {
                    const matchedProduct = productMapping[holding.originalName];
                    if (matchedProduct && matchedProduct.matched) {
                        productCode = matchedProduct.code || '';
                        assetClass = matchedProduct.assetClass || '';
                        strategyType = matchedProduct.strategyName || '';
                    }
                }
                
                sellData.push([
                    index + 1,
                    productCode || '--',
                    order.productName,
                    assetClass || '--',
                    strategyType || '--',
                    order.currentNav,
                    order.currentShares,
                    order.redeemShares,
                    (order.redeemShares * order.currentNav).toFixed(2),
                    order.remainingValue.toFixed(2),
                    percentage.toFixed(2),
                    validation
                ]);
            });
            const sellSheet = XLSX.utils.aoa_to_sheet(sellData);
            XLSX.utils.book_append_sheet(workbook, sellSheet, 'å–å‡ºæ˜ç»†');

            // 5. è°ƒä»“åæŒä»“åˆ†å¸ƒsheetï¼ˆä¼˜åŒ–ç‰ˆï¼‰
            const allocationData = [
                ['è°ƒä»“åæŒä»“åˆ†å¸ƒæƒé‡'],
                ['åºå·', 'äº§å“ä»£ç ', 'äº§å“åç§°', 'èµ„äº§ç±»åˆ«', 'ç­–ç•¥ç±»å‹', 'å½“å‰å¸‚å€¼ï¼ˆä¸‡å…ƒï¼‰', 'è°ƒä»“åå¸‚å€¼ï¼ˆä¸‡å…ƒï¼‰', 'è°ƒä»“åå æ¯”ï¼ˆ%ï¼‰', 'æ“ä½œçŠ¶æ€', 'æŠ•åæ¯”ä¾‹æ ¡éªŒ']
            ];
            
            // è®¡ç®—è°ƒä»“åæŒä»“ï¼ˆä¸updateAllocationAfterAdjustmentå‡½æ•°é€»è¾‘ä¸€è‡´ï¼‰
            const fundAllocation = [];
            
            investFunds.forEach(fund => {
                // ä½¿ç”¨æŒä»“tabä¸­çš„å¸‚å€¼ï¼ˆä¼°å€¼è¡¨ç›´æ¥æå–çš„å€¼ï¼‰
                const currentValue = fund.marketValue || 0;

                // æ£€æŸ¥è¯¥åŸºé‡‘æ˜¯å¦æœ‰å–å‡ºè®¢å•
                const sellOrder = sellOrders.find(o => o.productName === fund.name && o.checked);
                let sellValue = 0;
                let isSold = false;
                let remainingValue = currentValue; // é¢„è®¡èµå›åå‰©ä½™å¸‚å€¼
                if (sellOrder) {
                    sellValue = sellOrder.redeemShares * sellOrder.currentNav;
                    remainingValue = currentValue - sellValue; // è®¡ç®—èµå›åå‰©ä½™å¸‚å€¼
                    isSold = true;
                }

                // æ£€æŸ¥è¯¥åŸºé‡‘æ˜¯å¦æœ‰è¿½åŠ ä¹°å…¥
                const buyOrder = buyOrders.find(o => o.productName === fund.name && o.checked);
                let buyValue = 0;
                if (buyOrder) {
                    buyValue = buyOrder.amount;
                }

                // è°ƒä»“åå¸‚å€¼ = é¢„è®¡èµå›åå‰©ä½™å¸‚å€¼ + ä¹°å…¥é‡‘é¢
                const adjustedValue_fund = remainingValue + buyValue;

                // è·å–ç­–ç•¥ç±»å‹ï¼šä¼˜å…ˆä½¿ç”¨holdingsæ•°ç»„ä¸­çš„ç­–ç•¥ç±»å‹ï¼ˆç”¨æˆ·æ‰‹åŠ¨ä¿®æ”¹çš„å€¼ï¼‰
                let strategyType = fund.strategyName || fund.strategyType || '';
                let productCode = fund.productCode || '';
                let assetClass = fund.assetClass || '';
                
                // å¦‚æœholdingsä¸­æ²¡æœ‰ç­–ç•¥ç±»å‹ï¼Œåˆ™å°è¯•ä»productMappingè·å–
                if (!strategyType || !productCode) {
                    // ä¼˜å…ˆä½¿ç”¨åŸå§‹åç§°æŸ¥æ‰¾ï¼ˆå› ä¸ºfund.nameå¯èƒ½å·²è¢«ä¿®æ”¹ä¸ºå¸¦" â˜…"çš„åç§°ï¼‰
                    let lookupName = fund.name;
                    if (fund.originalName) {
                        lookupName = fund.originalName;
                    } else if (lookupName.includes(' â˜…')) {
                        lookupName = lookupName.replace(' â˜…', '');
                    }

                    const matchedProduct = productMapping[lookupName];
                    if (matchedProduct && matchedProduct.matched && matchedProduct.code) {
                        // å·²åŒ¹é…åˆ°äº§å“æ± ä¸­çš„äº§å“ï¼Œä½¿ç”¨äº§å“æ± çš„strategyNameå­—æ®µï¼ˆæŠ•èµ„æ–¹æ¡ˆç”¨çš„ç­–ç•¥ç±»å‹ï¼‰
                        if (!strategyType) strategyType = matchedProduct.strategyName || matchedProduct.strategyType || '';
                        if (!productCode) productCode = matchedProduct.code || '';
                        if (!assetClass) assetClass = matchedProduct.assetClass || '';
                    } else {
                        // æœªåŒ¹é…ï¼Œå°è¯•ç”¨åŸå§‹åç§°åœ¨äº§å“æ± ä¸­æŸ¥æ‰¾
                        const product = productPool.find(p => p.name === lookupName);
                        if (!strategyType) strategyType = product ? (product.strategyName || product.strategyType) : '';
                        if (!productCode) productCode = product ? product.code : '';
                        if (!assetClass) assetClass = product ? product.assetClass : '';
                    }
                }

                const percentage = totalMarketValue > 0 ? ((adjustedValue_fund / totalMarketValue) * 100) : 0;
                let validation = 'âœ“ æ­£å¸¸';
                if (percentage >= 30) validation = 'âš  â‰¥30%';
                
                // çŠ¶æ€æ ‡è®°
                let status = 'æŒæœ‰';
                if (isSold && buyValue > 0) {
                    status = 'è°ƒä»“ï¼ˆå–å‡º+ä¹°å…¥ï¼‰';
                } else if (isSold) {
                    status = 'å–å‡º';
                } else if (buyValue > 0) {
                    status = 'è¿½åŠ ';
                }
                
                fundAllocation.push({
                    index: fund.index,
                    name: fund.name,
                    productCode: productCode,
                    assetClass: assetClass,
                    strategyType: strategyType,
                    currentValue: currentValue,
                    adjustedValue: adjustedValue_fund,
                    percentage: percentage,
                    validation: validation,
                    status: status
                });
            });

            // æ·»åŠ ä¹°å…¥çš„äº§å“ï¼ˆæ–°è¿›å…¥æŒä»“ï¼Œæ’é™¤å·²è¿½åŠ çš„äº§å“ï¼‰
            buyOrders.filter(o => o.checked).forEach(order => {
                // æ£€æŸ¥è¯¥äº§å“æ˜¯å¦å·²ç»åœ¨æŒä»“ä¸­ï¼ˆè¿½åŠ çš„æƒ…å†µï¼‰
                const existingFund = fundAllocation.find(f => f.name === order.productName);
                
                // å¦‚æœä¸åœ¨æŒä»“ä¸­ï¼Œæ‰æ·»åŠ ä¸ºæ–°äº§å“
                if (!existingFund) {
                    const product = productPool.find(p => p.name === order.productName);
                    // ä½¿ç”¨strategyNameå­—æ®µï¼ˆæŠ•èµ„æ–¹æ¡ˆç”¨çš„ç­–ç•¥ç±»å‹ï¼‰
                    const strategyType = product ? (product.strategyName || product.strategyType) : '';
                    const productCode = product ? product.code : '';
                    const assetClass = product ? product.assetClass : '';

                    const percentage = totalMarketValue > 0 ? ((order.amount / totalMarketValue) * 100) : 0;
                    let validation = 'âœ“ æ­£å¸¸';
                    if (percentage >= 30) validation = 'âš  â‰¥30%';
                    
                    fundAllocation.push({
                        index: 'æ–°',
                        name: order.productName,
                        productCode: productCode,
                        assetClass: assetClass,
                        strategyType: strategyType,
                        currentValue: 0,
                        adjustedValue: order.amount,
                        percentage: percentage,
                        validation: validation,
                        status: 'æ–°å¢'
                    });
                }
            });

            // æŒ‰è°ƒä»“åå¸‚å€¼æ’åºï¼ˆä»å¤§åˆ°å°ï¼‰
            fundAllocation.sort((a, b) => b.adjustedValue - a.adjustedValue);

            fundAllocation.forEach(fund => {
                allocationData.push([
                    fund.index,
                    fund.productCode || '--',
                    fund.name,
                    fund.assetClass || '--',
                    fund.strategyType || '--',
                    fund.currentValue.toFixed(2),
                    fund.adjustedValue.toFixed(2),
                    fund.percentage.toFixed(2),
                    fund.status,
                    fund.validation
                ]);
            });

            const allocationSheet = XLSX.utils.aoa_to_sheet(allocationData);
            XLSX.utils.book_append_sheet(workbook, allocationSheet, 'è°ƒä»“ååˆ†å¸ƒ');

            // å¯¼å‡ºæ–‡ä»¶
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 10);
            XLSX.writeFile(workbook, `æŠ•èµ„æ–¹æ¡ˆ_${dateStr}.xlsx`);
            showAlert('æŠ•èµ„æ–¹æ¡ˆå·²å¯¼å‡ºä¸ºExcelæ–‡ä»¶', 'success');
        }

        // ä¸‹è½½æ–‡ä»¶
        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type: type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = 'alert alert-' + type + ' show';
            setTimeout(() => {
                alert.classList.remove('show');
            }, 3000);
        }

        // æ˜¾ç¤ºå¸®åŠ©æ¨¡æ€æ¡†
        function showHelp() {
            document.getElementById('helpModal').style.display = 'block';
        }

        // å…³é—­å¸®åŠ©æ¨¡æ€æ¡†
        function closeHelp() {
            document.getElementById('helpModal').style.display = 'none';
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('helpModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            console.log('=== é¡µé¢åŠ è½½å¼€å§‹ ===');
            console.log('å¼€å§‹è°ƒç”¨ initProductPool...');
            initProductPool();
            console.log('initProductPool è°ƒç”¨å®Œæˆï¼ŒproductPoolé•¿åº¦:', productPool.length);
            initHoldings();
            updateSellProducts();
            loadData();
            updatePoolTable();
            updateSummary();
            setupSellProductChangeListeners(); // è®¾ç½®å–å‡ºäº§å“ä¸‹æ‹‰æ¡†äº‹ä»¶ç›‘å¬å™¨
            
            // ç»‘å®šä¹°å…¥ç¡®è®¤æŒ‰é’®äº‹ä»¶
            const buyConfirmBtn = document.getElementById('buyProductConfirmBtn');
            if (buyConfirmBtn) {
                buyConfirmBtn.addEventListener('click', confirmBuyProductSelection);
                console.log('ä¹°å…¥ç¡®è®¤æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
            } else {
                console.error('æœªæ‰¾åˆ°ä¹°å…¥ç¡®è®¤æŒ‰é’®');
            }
            
            // ç»‘å®šå–å‡ºç¡®è®¤æŒ‰é’®äº‹ä»¶
            const sellConfirmBtn2 = document.getElementById('sellConfirmBtn2');
            if (sellConfirmBtn2) {
                sellConfirmBtn2.addEventListener('click', addSellOrder);
                console.log('å–å‡ºç¡®è®¤æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
            }
            
            console.log('=== é¡µé¢åŠ è½½å®Œæˆ ===');
        };
    </script>
</body>
</html>
